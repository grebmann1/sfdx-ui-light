!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("OpenAIAgentsBundle",[],t):"object"==typeof exports?exports.OpenAIAgentsBundle=t():e.OpenAIAgentsBundle=t()}(this,()=>(()=>{var e={585:e=>{var t=1e3,n=60*t,s=60*n,r=24*s,a=7*r;function i(e,t,n,s){var r=t>=1.5*n;return Math.round(e/n)+" "+s+(r?"s":"")}e.exports=function(e,o){o=o||{};var c,u,l=typeof e;if("string"===l&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var i=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(i){var o=parseFloat(i[1]);switch((i[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return o*a;case"days":case"day":case"d":return o*r;case"hours":case"hour":case"hrs":case"hr":case"h":return o*s;case"minutes":case"minute":case"mins":case"min":case"m":return o*n;case"seconds":case"second":case"secs":case"sec":case"s":return o*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if("number"===l&&isFinite(e))return o.long?(c=e,(u=Math.abs(c))>=r?i(c,u,r,"day"):u>=s?i(c,u,s,"hour"):u>=n?i(c,u,n,"minute"):u>=t?i(c,u,t,"second"):c+" ms"):function(e){var a=Math.abs(e);return a>=r?Math.round(e/r)+"d":a>=s?Math.round(e/s)+"h":a>=n?Math.round(e/n)+"m":a>=t?Math.round(e/t)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},736:(e,t,n)=>{e.exports=function(e){function t(e){let n,r,a,i=null;function o(...e){if(!o.enabled)return;const s=o,r=Number(new Date),a=r-(n||r);s.diff=a,s.prev=n,s.curr=r,n=r,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let i=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,r)=>{if("%%"===n)return"%";i++;const a=t.formatters[r];if("function"==typeof a){const t=e[i];n=a.call(s,t),e.splice(i,1),i--}return n}),t.formatArgs.call(s,e),(s.log||t.log).apply(s,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=s,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==i?i:(r!==t.namespaces&&(r=t.namespaces,a=t.enabled(e)),a),set:e=>{i=e}}),"function"==typeof t.init&&t.init(o),o}function s(e,n){const s=t(this.namespace+(void 0===n?":":n)+e);return s.log=this.log,s}function r(e,t){let n=0,s=0,r=-1,a=0;for(;n<e.length;)if(s<t.length&&(t[s]===e[n]||"*"===t[s]))"*"===t[s]?(r=s,a=n,s++):(n++,s++);else{if(-1===r)return!1;s=r+1,a++,n=a}for(;s<t.length&&"*"===t[s];)s++;return s===t.length}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names,...t.skips.map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const e of n)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=function(e){for(const n of t.skips)if(r(e,n))return!1;for(const n of t.names)if(r(e,n))return!0;return!1},t.humanize=n(585),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(n=>{t[n]=e[n]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},833:(e,t,n)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let s=0,r=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(s++,"%c"===e&&(r=s))}),t.splice(r,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(736)(t);const{formatters:s}=e.exports;s.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}},t={};function n(s){var r=t[s];if(void 0!==r)return r.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,n),a.exports}return n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};n.r(e),n.d(e,{AssistantContent:()=>ei,AssistantMessageItem:()=>ni,AudioContent:()=>Ka,ComputerCallResultItem:()=>di,ComputerToolOutput:()=>Ya,ComputerUseCallItem:()=>li,FunctionCallItem:()=>ci,FunctionCallResultItem:()=>ui,HostedToolCallItem:()=>oi,ImageContent:()=>Ha,InputFile:()=>Ga,InputImage:()=>Wa,InputText:()=>za,ItemBase:()=>Ua,MessageItem:()=>ii,ModelItem:()=>gi,OutputModelItem:()=>fi,OutputText:()=>Ja,ReasoningItem:()=>hi,Refusal:()=>Ba,SharedBase:()=>qa,StreamEvent:()=>xi,StreamEventGenericItem:()=>bi,StreamEventResponseCompleted:()=>wi,StreamEventResponseStarted:()=>vi,StreamEventTextStream:()=>yi,ToolCallItem:()=>pi,ToolOutputImage:()=>Xa,ToolOutputText:()=>Va,UnknownItem:()=>mi,UsageData:()=>_i,UserContent:()=>si,UserMessageItem:()=>ri,computerActions:()=>Qa});var t={};n.r(t),n.d(t,{Agent:()=>Ao,AgentHooks:()=>Ra,AgentsError:()=>Bt,BatchTraceProcessor:()=>Lr,ConsoleSpanExporter:()=>Zr,GuardrailExecutionError:()=>Kt,Handoff:()=>Da,InputGuardrailTripwireTriggered:()=>Vt,MCPServerStdio:()=>dr,MCPServerStreamableHttp:()=>pr,MaxTurnsExceededError:()=>zt,ModelBehaviorError:()=>Wt,NoopSpan:()=>Vr,NoopTrace:()=>Yr,OutputGuardrailTripwireTriggered:()=>Xt,RunAgentUpdatedStreamEvent:()=>Ui,RunContext:()=>ki,RunHandoffCallItem:()=>Di,RunItemStreamEvent:()=>qi,RunMessageOutputItem:()=>Ei,RunRawModelStreamEvent:()=>Fi,RunReasoningItem:()=>$i,RunResult:()=>Ti,RunState:()=>_o,RunToolApprovalItem:()=>Mi,RunToolCallItem:()=>Ni,RunToolCallOutputItem:()=>Pi,Runner:()=>So,RuntimeEventEmitter:()=>wr,Span:()=>Hr,StreamedRunResult:()=>Ai,SystemError:()=>Jt,ToolCallError:()=>Ht,Trace:()=>Xr,TraceProvider:()=>Qr,Usage:()=>Si,UserError:()=>Gt,addTraceProcessor:()=>Ia,assistant:()=>Ro,computerTool:()=>hn,createAgentSpan:()=>aa,createCustomSpan:()=>ha,createFunctionSpan:()=>oa,createGenerationSpan:()=>da,createGuardrailSpan:()=>fa,createHandoffSpan:()=>ua,createMCPListToolsSpan:()=>Sa,createResponseSpan:()=>sa,createSpeechGroupSpan:()=>ba,createSpeechSpan:()=>va,createTranscriptionSpan:()=>_a,defineOutputGuardrail:()=>Pa,extractAllTextOutput:()=>Zi,generateGroupId:()=>Kr,generateSpanId:()=>Gr,generateTraceId:()=>Wr,getAllMcpTools:()=>gr,getCurrentSpan:()=>Rr,getCurrentTrace:()=>Or,getGlobalTraceProvider:()=>ta,getHandoff:()=>Ma,getLogger:()=>un,getOrCreateTrace:()=>Pr,getTransferMessage:()=>$a,handoff:()=>ja,hostedMcpTool:()=>mn,invalidateServerToolsCache:()=>mr,protocol:()=>e,resetCurrentSpan:()=>Dr,run:()=>To,setCurrentSpan:()=>$r,setDefaultModelProvider:()=>La,setTraceProcessors:()=>Ta,setTracingDisabled:()=>Aa,startTraceExportLoop:()=>Ca,system:()=>Oo,tool:()=>gn,user:()=>Co,withAgentSpan:()=>ia,withCustomSpan:()=>ma,withFunctionSpan:()=>ca,withGenerationSpan:()=>pa,withGuardrailSpan:()=>ga,withHandoffSpan:()=>la,withMCPListToolsSpan:()=>ka,withResponseSpan:()=>ra,withSpeechGroupSpan:()=>xa,withSpeechSpan:()=>wa,withTrace:()=>Nr,withTranscriptionSpan:()=>ya});var s={};n.r(s),n.d(s,{OpenAIChatCompletionsModel:()=>dp,OpenAIProvider:()=>pp,OpenAIResponsesModel:()=>sp,OpenAITracingExporter:()=>hp,codeInterpreterTool:()=>zd,fileSearchTool:()=>Jd,imageGenerationTool:()=>Wd,setDefaultOpenAIClient:()=>Dd,setDefaultOpenAIKey:()=>jd,setDefaultOpenAITracingExporter:()=>mp,setOpenAIAPI:()=>$d,setTracingExportApiKey:()=>Pd,webSearchTool:()=>Bd});var r={};n.r(r),n.d(r,{DEFAULT_OPENAI_REALTIME_MODEL:()=>Ih,DEFAULT_OPENAI_REALTIME_SESSION_CONFIG:()=>Th,ModelBehaviorError:()=>Wt,OpenAIRealtimeBase:()=>Ah,OpenAIRealtimeWebRTC:()=>Ch,OpenAIRealtimeWebSocket:()=>Rh,OutputGuardrailTripwireTriggered:()=>Xt,RealtimeAgent:()=>Sp,RealtimeSession:()=>Eh,UserError:()=>Gt,tool:()=>gn,utils:()=>Nh});var a={};async function i(e){try{return[null,await e()]}catch(e){return[e,null]}}function o(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}n.r(a),n.d(a,{Agent:()=>Ao,AgentHooks:()=>Ra,AgentsError:()=>Bt,BatchTraceProcessor:()=>Lr,ConsoleSpanExporter:()=>Zr,GuardrailExecutionError:()=>Kt,Handoff:()=>Da,InputGuardrailTripwireTriggered:()=>Vt,MCPServerStdio:()=>dr,MCPServerStreamableHttp:()=>pr,MaxTurnsExceededError:()=>zt,ModelBehaviorError:()=>Wt,NoopSpan:()=>Vr,NoopTrace:()=>Yr,OpenAIChatCompletionsModel:()=>dp,OpenAIProvider:()=>pp,OpenAIResponsesModel:()=>sp,OpenAITracingExporter:()=>hp,OutputGuardrailTripwireTriggered:()=>Xt,RunAgentUpdatedStreamEvent:()=>Ui,RunContext:()=>ki,RunHandoffCallItem:()=>Di,RunItemStreamEvent:()=>qi,RunMessageOutputItem:()=>Ei,RunRawModelStreamEvent:()=>Fi,RunReasoningItem:()=>$i,RunResult:()=>Ti,RunState:()=>_o,RunToolApprovalItem:()=>Mi,RunToolCallItem:()=>Ni,RunToolCallOutputItem:()=>Pi,Runner:()=>So,RuntimeEventEmitter:()=>wr,Span:()=>Hr,StreamedRunResult:()=>Ai,SystemError:()=>Jt,ToolCallError:()=>Ht,Trace:()=>Xr,TraceProvider:()=>Qr,Usage:()=>Si,UserError:()=>Gt,addTraceProcessor:()=>Ia,assistant:()=>Ro,codeInterpreterTool:()=>zd,computerTool:()=>hn,createAgentSpan:()=>aa,createCustomSpan:()=>ha,createFunctionSpan:()=>oa,createGenerationSpan:()=>da,createGuardrailSpan:()=>fa,createHandoffSpan:()=>ua,createMCPListToolsSpan:()=>Sa,createResponseSpan:()=>sa,createSpeechGroupSpan:()=>ba,createSpeechSpan:()=>va,createTranscriptionSpan:()=>_a,defineOutputGuardrail:()=>Pa,extractAllTextOutput:()=>Zi,fileSearchTool:()=>Jd,generateGroupId:()=>Kr,generateSpanId:()=>Gr,generateTraceId:()=>Wr,getAllMcpTools:()=>gr,getCurrentSpan:()=>Rr,getCurrentTrace:()=>Or,getGlobalTraceProvider:()=>ta,getHandoff:()=>Ma,getLogger:()=>un,getOrCreateTrace:()=>Pr,getTransferMessage:()=>$a,handoff:()=>ja,hostedMcpTool:()=>mn,imageGenerationTool:()=>Wd,invalidateServerToolsCache:()=>mr,protocol:()=>e,realtime:()=>r,resetCurrentSpan:()=>Dr,run:()=>To,setCurrentSpan:()=>$r,setDefaultModelProvider:()=>La,setDefaultOpenAIClient:()=>Dd,setDefaultOpenAIKey:()=>jd,setDefaultOpenAITracingExporter:()=>mp,setOpenAIAPI:()=>$d,setTraceProcessors:()=>Ta,setTracingDisabled:()=>Aa,setTracingExportApiKey:()=>Pd,startTraceExportLoop:()=>Ca,system:()=>Oo,tool:()=>gn,user:()=>Co,webSearchTool:()=>Bd,withAgentSpan:()=>ia,withCustomSpan:()=>ma,withFunctionSpan:()=>ca,withGenerationSpan:()=>pa,withGuardrailSpan:()=>ga,withHandoffSpan:()=>la,withMCPListToolsSpan:()=>ka,withResponseSpan:()=>ra,withSpeechGroupSpan:()=>xa,withSpeechSpan:()=>wa,withTrace:()=>Nr,withTranscriptionSpan:()=>ya});const c=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class u extends Error{}class l extends u{constructor(e,t,n,s){super(`${l.makeMessage(e,t,n)}`),this.status=e,this.headers=s,this.requestID=s?.get("x-request-id"),this.error=t;const r=t;this.code=r?.code,this.param=r?.param,this.type=r?.type}static makeMessage(e,t,n){const s=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,n,s){if(!e||!s)return new p({message:n,cause:c(t)});const r=t?.error;return 400===e?new m(e,r,n,s):401===e?new f(e,r,n,s):403===e?new g(e,r,n,s):404===e?new _(e,r,n,s):409===e?new y(e,r,n,s):422===e?new v(e,r,n,s):429===e?new w(e,r,n,s):e>=500?new b(e,r,n,s):new l(e,r,n,s)}}class d extends l{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class p extends l{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class h extends p{constructor({message:e}={}){super({message:e??"Request timed out."})}}class m extends l{}class f extends l{}class g extends l{}class _ extends l{}class y extends l{}class v extends l{}class w extends l{}class b extends l{}class x extends u{constructor(){super("Could not parse response content as the length limit was reached")}}class S extends u{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class k extends Error{constructor(e){super(e)}}function I(e){return"auto-parseable-response-format"===e?.$brand}function T(e){return"auto-parseable-tool"===e?.$brand}function A(e,t){const n=e.choices.map(e=>{if("length"===e.finish_reason)throw new x;if("content_filter"===e.finish_reason)throw new S;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const n=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:T(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?C(t,e.message.content):null}}});return{...e,choices:n}}function C(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function O(e,t){if(!e)return!1;const n=e.tools?.find(e=>e.function?.name===t.function.name);return T(n)||n?.function.strict||!1}function R(e){return!!I(e.response_format)||(e.tools?.some(e=>T(e)||"function"===e.type&&!0===e.function.strict)??!1)}const E=Symbol("Let zodToJsonSchema decide on which parser to use"),N={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},P=e=>"_def"in e?e._def:e;var $,D;!function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),s={};for(const e of n)s[e]=t[e];return e.objectValues(s)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}($||($={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(D||(D={}));const j=$.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),M=e=>{switch(typeof e){case"undefined":return j.undefined;case"string":return j.string;case"number":return Number.isNaN(e)?j.nan:j.number;case"boolean":return j.boolean;case"function":return j.function;case"bigint":return j.bigint;case"symbol":return j.symbol;case"object":return Array.isArray(e)?j.array:null===e?j.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?j.promise:"undefined"!=typeof Map&&e instanceof Map?j.map:"undefined"!=typeof Set&&e instanceof Set?j.set:"undefined"!=typeof Date&&e instanceof Date?j.date:j.object;default:return j.unknown}},Z=$.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class L extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},s=e=>{for(const r of e.issues)if("invalid_union"===r.code)r.unionErrors.map(s);else if("invalid_return_type"===r.code)s(r.returnTypeError);else if("invalid_arguments"===r.code)s(r.argumentsError);else if(0===r.path.length)n._errors.push(t(r));else{let e=n,s=0;for(;s<r.path.length;){const n=r.path[s];s===r.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(r))):e[n]=e[n]||{_errors:[]},e=e[n],s++}}};return s(this),n}static assert(e){if(!(e instanceof L))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,$.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}L.create=e=>new L(e);const F=(e,t)=>{let n;switch(e.code){case Z.invalid_type:n=e.received===j.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Z.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,$.jsonStringifyReplacer)}`;break;case Z.unrecognized_keys:n=`Unrecognized key(s) in object: ${$.joinValues(e.keys,", ")}`;break;case Z.invalid_union:n="Invalid input";break;case Z.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${$.joinValues(e.options)}`;break;case Z.invalid_enum_value:n=`Invalid enum value. Expected ${$.joinValues(e.options)}, received '${e.received}'`;break;case Z.invalid_arguments:n="Invalid function arguments";break;case Z.invalid_return_type:n="Invalid function return type";break;case Z.invalid_date:n="Invalid date";break;case Z.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:$.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Z.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Z.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Z.custom:n="Invalid input";break;case Z.invalid_intersection_types:n="Intersection results could not be merged";break;case Z.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Z.not_finite:n="Number must be finite";break;default:n=t.defaultError,$.assertNever(e)}return{message:n}};let q=F;function U(e,t){const n=q,s=(e=>{const{data:t,path:n,errorMaps:s,issueData:r}=e,a=[...n,...r.path||[]],i={...r,path:a};if(void 0!==r.message)return{...r,path:a,message:r.message};let o="";const c=s.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...r,path:a,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===F?void 0:F].filter(e=>!!e)});e.common.issues.push(s)}class B{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if("aborted"===s.status)return J;"dirty"===s.status&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,s=await e.value;n.push({key:t,value:s})}return B.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:t,value:r}=s;if("aborted"===t.status)return J;if("aborted"===r.status)return J;"dirty"===t.status&&e.dirty(),"dirty"===r.status&&e.dirty(),"__proto__"===t.value||void 0===r.value&&!s.alwaysSet||(n[t.value]=r.value)}return{status:e.value,value:n}}}const J=Object.freeze({status:"aborted"}),z=e=>({status:"dirty",value:e}),W=e=>({status:"valid",value:e}),G=e=>"aborted"===e.status,K=e=>"dirty"===e.status,H=e=>"valid"===e.status,V=e=>"undefined"!=typeof Promise&&e instanceof Promise;var X;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(X||(X={}));class Y{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Q=(e,t)=>{if(H(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new L(e.common.issues);return this._error=t,this._error}}};function ee(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:r}=e;if(t&&(n||s))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:r}:{errorMap:(t,r)=>{const{message:a}=e;return"invalid_enum_value"===t.code?{message:a??r.defaultError}:void 0===r.data?{message:a??s??r.defaultError}:"invalid_type"!==t.code?{message:r.defaultError}:{message:a??n??r.defaultError}},description:r}}class te{get description(){return this._def.description}_getType(e){return M(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:M(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new B,ctx:{common:e.parent.common,data:e.data,parsedType:M(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(V(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Q(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return H(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>H(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:M(e)},s=this._parse({data:e,path:n.path,parent:n}),r=await(V(s)?s:Promise.resolve(s));return Q(n,r)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const r=e(t),a=()=>s.addIssue({code:Z.custom,...n(t)});return"undefined"!=typeof Promise&&r instanceof Promise?r.then(e=>!!e||(a(),!1)):!!r||(a(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue("function"==typeof t?t(n,s):t),!1))}_refinement(e){return new Qe({schema:this,typeName:ct.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return et.create(this,this._def)}nullable(){return tt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ze.create(this)}promise(){return Ye.create(this,this._def)}or(e){return qe.create([this,e],this._def)}and(e){return Be.create(this,e,this._def)}transform(e){return new Qe({...ee(this._def),schema:this,typeName:ct.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new nt({...ee(this._def),innerType:this,defaultValue:t,typeName:ct.ZodDefault})}brand(){return new at({typeName:ct.ZodBranded,type:this,...ee(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new st({...ee(this._def),innerType:this,catchValue:t,typeName:ct.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return it.create(this,e)}readonly(){return ot.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ne=/^c[^\s-]{8,}$/i,se=/^[0-9a-z]+$/,re=/^[0-9A-HJKMNP-TV-Z]{26}$/i,ae=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,ie=/^[a-z0-9_-]{21}$/i,oe=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,ce=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,ue=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let le;const de=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,pe=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,he=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,me=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,fe=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ge=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,_e="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ye=new RegExp(`^${_e}$`);function ve(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function we(e){return new RegExp(`^${ve(e)}$`)}function be(e){let t=`${_e}T${ve(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function xe(e,t){return!("v4"!==t&&t||!de.test(e))||!("v6"!==t&&t||!he.test(e))}function Se(e,t){if(!oe.test(e))return!1;try{const[n]=e.split("."),s=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),r=JSON.parse(atob(s));return!("object"!=typeof r||null===r||"typ"in r&&"JWT"!==r?.typ||!r.alg||t&&r.alg!==t)}catch{return!1}}function ke(e,t){return!("v4"!==t&&t||!pe.test(e))||!("v6"!==t&&t||!me.test(e))}class Ie extends te{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==j.string){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.string,received:t.parsedType}),J}const t=new B;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),U(n,{code:Z.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),U(n,{code:Z.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?U(n,{code:Z.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&U(n,{code:Z.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)ue.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"email",code:Z.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)le||(le=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),le.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"emoji",code:Z.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)ae.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"uuid",code:Z.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)ie.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"nanoid",code:Z.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)ne.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"cuid",code:Z.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)se.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"cuid2",code:Z.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)re.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"ulid",code:Z.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),U(n,{validation:"url",code:Z.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"regex",code:Z.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?be(s).test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?ye.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?we(s).test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{code:Z.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?ce.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"duration",code:Z.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?xe(e.data,s.version)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"ip",code:Z.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?Se(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"jwt",code:Z.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?ke(e.data,s.version)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"cidr",code:Z.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?fe.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"base64",code:Z.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?ge.test(e.data)||(n=this._getOrReturnCtx(e,n),U(n,{validation:"base64url",code:Z.invalid_string,message:s.message}),t.dirty()):$.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:Z.invalid_string,...X.errToObj(n)})}_addCheck(e){return new Ie({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...X.errToObj(e)})}url(e){return this._addCheck({kind:"url",...X.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...X.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...X.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...X.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...X.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...X.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...X.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...X.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...X.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...X.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...X.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...X.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...X.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...X.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...X.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...X.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...X.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...X.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...X.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...X.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...X.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...X.errToObj(t)})}nonempty(e){return this.min(1,X.errToObj(e))}trim(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Ie({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Te(e,t){const n=(e.toString().split(".")[1]||"").length,s=(t.toString().split(".")[1]||"").length,r=n>s?n:s;return Number.parseInt(e.toFixed(r).replace(".",""))%Number.parseInt(t.toFixed(r).replace(".",""))/10**r}Ie.create=e=>new Ie({checks:[],typeName:ct.ZodString,coerce:e?.coerce??!1,...ee(e)});class Ae extends te{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==j.number){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.number,received:t.parsedType}),J}let t;const n=new B;for(const s of this._def.checks)"int"===s.kind?$.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),U(t,{code:Z.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"multipleOf"===s.kind?0!==Te(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),U(t,{code:Z.not_finite,message:s.message}),n.dirty()):$.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,X.toString(t))}gt(e,t){return this.setLimit("min",e,!1,X.toString(t))}lte(e,t){return this.setLimit("max",e,!0,X.toString(t))}lt(e,t){return this.setLimit("max",e,!1,X.toString(t))}setLimit(e,t,n,s){return new Ae({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:X.toString(s)}]})}_addCheck(e){return new Ae({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:X.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:X.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:X.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:X.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:X.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:X.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:X.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:X.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:X.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&$.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Ae.create=e=>new Ae({checks:[],typeName:ct.ZodNumber,coerce:e?.coerce||!1,...ee(e)});class Ce extends te{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==j.bigint)return this._getInvalidInput(e);let t;const n=new B;for(const s of this._def.checks)"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),U(t,{code:Z.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):$.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.bigint,received:t.parsedType}),J}gte(e,t){return this.setLimit("min",e,!0,X.toString(t))}gt(e,t){return this.setLimit("min",e,!1,X.toString(t))}lte(e,t){return this.setLimit("max",e,!0,X.toString(t))}lt(e,t){return this.setLimit("max",e,!1,X.toString(t))}setLimit(e,t,n,s){return new Ce({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:X.toString(s)}]})}_addCheck(e){return new Ce({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:X.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:X.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:X.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:X.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:X.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Ce.create=e=>new Ce({checks:[],typeName:ct.ZodBigInt,coerce:e?.coerce??!1,...ee(e)});class Oe extends te{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==j.boolean){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.boolean,received:t.parsedType}),J}return W(e.data)}}Oe.create=e=>new Oe({typeName:ct.ZodBoolean,coerce:e?.coerce||!1,...ee(e)});class Re extends te{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==j.date){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.date,received:t.parsedType}),J}if(Number.isNaN(e.data.getTime()))return U(this._getOrReturnCtx(e),{code:Z.invalid_date}),J;const t=new B;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),U(n,{code:Z.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),U(n,{code:Z.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):$.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Re({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:X.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:X.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Re.create=e=>new Re({checks:[],coerce:e?.coerce||!1,typeName:ct.ZodDate,...ee(e)});class Ee extends te{_parse(e){if(this._getType(e)!==j.symbol){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.symbol,received:t.parsedType}),J}return W(e.data)}}Ee.create=e=>new Ee({typeName:ct.ZodSymbol,...ee(e)});class Ne extends te{_parse(e){if(this._getType(e)!==j.undefined){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.undefined,received:t.parsedType}),J}return W(e.data)}}Ne.create=e=>new Ne({typeName:ct.ZodUndefined,...ee(e)});class Pe extends te{_parse(e){if(this._getType(e)!==j.null){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.null,received:t.parsedType}),J}return W(e.data)}}Pe.create=e=>new Pe({typeName:ct.ZodNull,...ee(e)});class $e extends te{constructor(){super(...arguments),this._any=!0}_parse(e){return W(e.data)}}$e.create=e=>new $e({typeName:ct.ZodAny,...ee(e)});class De extends te{constructor(){super(...arguments),this._unknown=!0}_parse(e){return W(e.data)}}De.create=e=>new De({typeName:ct.ZodUnknown,...ee(e)});class je extends te{_parse(e){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.never,received:t.parsedType}),J}}je.create=e=>new je({typeName:ct.ZodNever,...ee(e)});class Me extends te{_parse(e){if(this._getType(e)!==j.undefined){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.void,received:t.parsedType}),J}return W(e.data)}}Me.create=e=>new Me({typeName:ct.ZodVoid,...ee(e)});class Ze extends te{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==j.array)return U(t,{code:Z.invalid_type,expected:j.array,received:t.parsedType}),J;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,r=t.data.length<s.exactLength.value;(e||r)&&(U(t,{code:e?Z.too_big:Z.too_small,minimum:r?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&(U(t,{code:Z.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&(U(t,{code:Z.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new Y(t,e,t.path,n)))).then(e=>B.mergeArray(n,e));const r=[...t.data].map((e,n)=>s.type._parseSync(new Y(t,e,t.path,n)));return B.mergeArray(n,r)}get element(){return this._def.type}min(e,t){return new Ze({...this._def,minLength:{value:e,message:X.toString(t)}})}max(e,t){return new Ze({...this._def,maxLength:{value:e,message:X.toString(t)}})}length(e,t){return new Ze({...this._def,exactLength:{value:e,message:X.toString(t)}})}nonempty(e){return this.min(1,e)}}function Le(e){if(e instanceof Fe){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=et.create(Le(s))}return new Fe({...e._def,shape:()=>t})}return e instanceof Ze?new Ze({...e._def,type:Le(e.element)}):e instanceof et?et.create(Le(e.unwrap())):e instanceof tt?tt.create(Le(e.unwrap())):e instanceof Je?Je.create(e.items.map(e=>Le(e))):e}Ze.create=(e,t)=>new Ze({type:e,minLength:null,maxLength:null,exactLength:null,typeName:ct.ZodArray,...ee(t)});class Fe extends te{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=$.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==j.object){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.object,received:t.parsedType}),J}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:r}=this._getCached(),a=[];if(!(this._def.catchall instanceof je&&"strip"===this._def.unknownKeys))for(const e in n.data)r.includes(e)||a.push(e);const i=[];for(const e of r){const t=s[e],r=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new Y(n,r,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof je){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(U(n,{code:Z.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const s=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new Y(n,s,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const n=await t.key,s=await t.value;e.push({key:n,value:s,alwaysSet:t.alwaysSet})}return e}).then(e=>B.mergeObjectSync(t,e)):B.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return X.errToObj,new Fe({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:X.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Fe({...this._def,unknownKeys:"strip"})}passthrough(){return new Fe({...this._def,unknownKeys:"passthrough"})}extend(e){return new Fe({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Fe({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:ct.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Fe({...this._def,catchall:e})}pick(e){const t={};for(const n of $.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Fe({...this._def,shape:()=>t})}omit(e){const t={};for(const n of $.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Fe({...this._def,shape:()=>t})}deepPartial(){return Le(this)}partial(e){const t={};for(const n of $.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new Fe({...this._def,shape:()=>t})}required(e){const t={};for(const n of $.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof et;)e=e._def.innerType;t[n]=e}return new Fe({...this._def,shape:()=>t})}keyof(){return He($.objectKeys(this.shape))}}Fe.create=(e,t)=>new Fe({shape:()=>e,unknownKeys:"strip",catchall:je.create(),typeName:ct.ZodObject,...ee(t)}),Fe.strictCreate=(e,t)=>new Fe({shape:()=>e,unknownKeys:"strict",catchall:je.create(),typeName:ct.ZodObject,...ee(t)}),Fe.lazycreate=(e,t)=>new Fe({shape:e,unknownKeys:"strip",catchall:je.create(),typeName:ct.ZodObject,...ee(t)});class qe extends te{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new L(e.ctx.common.issues));return U(t,{code:Z.invalid_union,unionErrors:n}),J});{let e;const s=[];for(const r of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=r._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const r=s.map(e=>new L(e));return U(t,{code:Z.invalid_union,unionErrors:r}),J}}get options(){return this._def.options}}function Ue(e,t){const n=M(e),s=M(t);if(e===t)return{valid:!0,data:e};if(n===j.object&&s===j.object){const n=$.objectKeys(t),s=$.objectKeys(e).filter(e=>-1!==n.indexOf(e)),r={...e,...t};for(const n of s){const s=Ue(e[n],t[n]);if(!s.valid)return{valid:!1};r[n]=s.data}return{valid:!0,data:r}}if(n===j.array&&s===j.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const r=Ue(e[s],t[s]);if(!r.valid)return{valid:!1};n.push(r.data)}return{valid:!0,data:n}}return n===j.date&&s===j.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}qe.create=(e,t)=>new qe({options:e,typeName:ct.ZodUnion,...ee(t)});class Be extends te{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if(G(e)||G(s))return J;const r=Ue(e.value,s.value);return r.valid?((K(e)||K(s))&&t.dirty(),{status:t.value,value:r.data}):(U(n,{code:Z.invalid_intersection_types}),J)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Be.create=(e,t,n)=>new Be({left:e,right:t,typeName:ct.ZodIntersection,...ee(n)});class Je extends te{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==j.array)return U(n,{code:Z.invalid_type,expected:j.array,received:n.parsedType}),J;if(n.data.length<this._def.items.length)return U(n,{code:Z.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),J;!this._def.rest&&n.data.length>this._def.items.length&&(U(n,{code:Z.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const s=this._def.items[t]||this._def.rest;return s?s._parse(new Y(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>B.mergeArray(t,e)):B.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new Je({...this._def,rest:e})}}Je.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Je({items:e,typeName:ct.ZodTuple,rest:null,...ee(t)})};class ze extends te{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==j.map)return U(n,{code:Z.invalid_type,expected:j.map,received:n.parsedType}),J;const s=this._def.keyType,r=this._def.valueType,a=[...n.data.entries()].map(([e,t],a)=>({key:s._parse(new Y(n,e,n.path,[a,"key"])),value:r._parse(new Y(n,t,n.path,[a,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of a){const s=await n.key,r=await n.value;if("aborted"===s.status||"aborted"===r.status)return J;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of a){const s=n.key,r=n.value;if("aborted"===s.status||"aborted"===r.status)return J;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}}}}ze.create=(e,t,n)=>new ze({valueType:t,keyType:e,typeName:ct.ZodMap,...ee(n)});class We extends te{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==j.set)return U(n,{code:Z.invalid_type,expected:j.set,received:n.parsedType}),J;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&(U(n,{code:Z.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&(U(n,{code:Z.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const r=this._def.valueType;function a(e){const n=new Set;for(const s of e){if("aborted"===s.status)return J;"dirty"===s.status&&t.dirty(),n.add(s.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map((e,t)=>r._parse(new Y(n,e,n.path,t)));return n.common.async?Promise.all(i).then(e=>a(e)):a(i)}min(e,t){return new We({...this._def,minSize:{value:e,message:X.toString(t)}})}max(e,t){return new We({...this._def,maxSize:{value:e,message:X.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}We.create=(e,t)=>new We({valueType:e,minSize:null,maxSize:null,typeName:ct.ZodSet,...ee(t)});class Ge extends te{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ge.create=(e,t)=>new Ge({getter:e,typeName:ct.ZodLazy,...ee(t)});class Ke extends te{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return U(t,{received:t.data,code:Z.invalid_literal,expected:this._def.value}),J}return{status:"valid",value:e.data}}get value(){return this._def.value}}function He(e,t){return new Ve({values:e,typeName:ct.ZodEnum,...ee(t)})}Ke.create=(e,t)=>new Ke({value:e,typeName:ct.ZodLiteral,...ee(t)});class Ve extends te{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return U(t,{expected:$.joinValues(n),received:t.parsedType,code:Z.invalid_type}),J}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return U(t,{received:t.data,code:Z.invalid_enum_value,options:n}),J}return W(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Ve.create(e,{...this._def,...t})}exclude(e,t=this._def){return Ve.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Ve.create=He;class Xe extends te{_parse(e){const t=$.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==j.string&&n.parsedType!==j.number){const e=$.objectValues(t);return U(n,{expected:$.joinValues(e),received:n.parsedType,code:Z.invalid_type}),J}if(this._cache||(this._cache=new Set($.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=$.objectValues(t);return U(n,{received:n.data,code:Z.invalid_enum_value,options:e}),J}return W(e.data)}get enum(){return this._def.values}}Xe.create=(e,t)=>new Xe({values:e,typeName:ct.ZodNativeEnum,...ee(t)});class Ye extends te{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==j.promise&&!1===t.common.async)return U(t,{code:Z.invalid_type,expected:j.promise,received:t.parsedType}),J;const n=t.parsedType===j.promise?t.data:Promise.resolve(t.data);return W(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Ye.create=(e,t)=>new Ye({type:e,typeName:ct.ZodPromise,...ee(t)});class Qe extends te{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===ct.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,r={addIssue:e=>{U(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(r.addIssue=r.addIssue.bind(r),"preprocess"===s.type){const e=s.transform(n.data,r);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return J;const s=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===s.status?J:"dirty"===s.status||"dirty"===t.value?z(s.value):s});{if("aborted"===t.value)return J;const s=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===s.status?J:"dirty"===s.status||"dirty"===t.value?z(s.value):s}}if("refinement"===s.type){const e=e=>{const t=s.refinement(e,r);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===s.status?J:("dirty"===s.status&&t.dirty(),e(s.value),{status:t.value,value:s.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?J:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===s.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!H(e))return J;const a=s.transform(e.value,r);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>H(e)?Promise.resolve(s.transform(e.value,r)).then(e=>({status:t.value,value:e})):J)}$.assertNever(s)}}Qe.create=(e,t,n)=>new Qe({schema:e,typeName:ct.ZodEffects,effect:t,...ee(n)}),Qe.createWithPreprocess=(e,t,n)=>new Qe({schema:t,effect:{type:"preprocess",transform:e},typeName:ct.ZodEffects,...ee(n)});class et extends te{_parse(e){return this._getType(e)===j.undefined?W(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}et.create=(e,t)=>new et({innerType:e,typeName:ct.ZodOptional,...ee(t)});class tt extends te{_parse(e){return this._getType(e)===j.null?W(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}tt.create=(e,t)=>new tt({innerType:e,typeName:ct.ZodNullable,...ee(t)});class nt extends te{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===j.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}nt.create=(e,t)=>new nt({innerType:e,typeName:ct.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...ee(t)});class st extends te{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return V(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new L(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new L(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}st.create=(e,t)=>new st({innerType:e,typeName:ct.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...ee(t)});class rt extends te{_parse(e){if(this._getType(e)!==j.nan){const t=this._getOrReturnCtx(e);return U(t,{code:Z.invalid_type,expected:j.nan,received:t.parsedType}),J}return{status:"valid",value:e.data}}}rt.create=e=>new rt({typeName:ct.ZodNaN,...ee(e)}),Symbol("zod_brand");class at extends te{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class it extends te{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?J:"dirty"===e.status?(t.dirty(),z(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?J:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new it({in:e,out:t,typeName:ct.ZodPipeline})}}class ot extends te{_parse(e){const t=this._def.innerType._parse(e),n=e=>(H(e)&&(e.value=Object.freeze(e.value)),e);return V(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}var ct;function ut(e,t,n,s){s?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function lt(e,t,n,s,r){e[t]=n,ut(e,t,s,r)}function dt(e,t,n){const s=n??t.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((n,s)=>dt(e,t,n))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return pt(e,t)}}ot.create=(e,t)=>new ot({innerType:e,typeName:ct.ZodReadonly,...ee(t)}),Fe.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(ct||(ct={})),Ie.create,Ae.create,rt.create,Ce.create,Oe.create,Re.create,Ee.create,Ne.create,Pe.create,$e.create,De.create,je.create,Me.create,Ze.create,Fe.create,Fe.strictCreate,qe.create,Be.create,Je.create,ze.create,We.create,Ge.create,Ke.create,Ve.create,Xe.create,Ye.create,Qe.create,et.create,tt.create,Qe.createWithPreprocess,it.create;const pt=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const s of e.checks)switch(s.kind){case"min":lt(n,"minimum",s.value,s.message,t);break;case"max":lt(n,"maximum",s.value,s.message,t)}return n};let ht;const mt=/^[cC][^\s-]{8,}$/,ft=/^[0-9a-z]+$/,gt=/^[0-9A-HJKMNP-TV-Z]{26}$/,_t=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,yt=()=>(void 0===ht&&(ht=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ht),vt=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,wt=/^[a-zA-Z0-9_-]{21}$/;function bt(e,t){const n={type:"string"};function s(e){return"escape"===t.patternStrategy?xt(e):e}if(e.checks)for(const r of e.checks)switch(r.kind){case"min":lt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":lt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":St(n,"email",r.message,t);break;case"format:idn-email":St(n,"idn-email",r.message,t);break;case"pattern:zod":kt(n,_t,r.message,t)}break;case"url":St(n,"uri",r.message,t);break;case"uuid":St(n,"uuid",r.message,t);break;case"regex":kt(n,r.regex,r.message,t);break;case"cuid":kt(n,mt,r.message,t);break;case"cuid2":kt(n,ft,r.message,t);break;case"startsWith":kt(n,RegExp(`^${s(r.value)}`),r.message,t);break;case"endsWith":kt(n,RegExp(`${s(r.value)}$`),r.message,t);break;case"datetime":St(n,"date-time",r.message,t);break;case"date":St(n,"date",r.message,t);break;case"time":St(n,"time",r.message,t);break;case"duration":St(n,"duration",r.message,t);break;case"length":lt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),lt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":kt(n,RegExp(s(r.value)),r.message,t);break;case"ip":"v6"!==r.version&&St(n,"ipv4",r.message,t),"v4"!==r.version&&St(n,"ipv6",r.message,t);break;case"emoji":kt(n,yt,r.message,t);break;case"ulid":kt(n,gt,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":St(n,"binary",r.message,t);break;case"contentEncoding:base64":lt(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":kt(n,vt,r.message,t)}break;case"nanoid":kt(n,wt,r.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}const xt=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),St=(e,t,n,s)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&s.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&s.errorMessages&&{errorMessage:{format:n}}})):lt(e,"format",t,n,s)},kt=(e,t,n,s)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&s.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:It(t,s),...n&&s.errorMessages&&{errorMessage:{pattern:n}}})):lt(e,"pattern",It(t,s),n,s)},It=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const s=n.flags.includes("i"),r=n.flags.includes("m"),a=n.flags.includes("s"),i=s?n.source.toLowerCase():n.source;let o="",c=!1,u=!1,l=!1;for(let e=0;e<i.length;e++)if(c)o+=i[e],c=!1;else{if(s)if(u){if(i[e].match(/[a-z]/)){l?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],l=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(r){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?o+=u?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?c=!0:u&&"]"===i[e]?u=!1:u||"["!==i[e]||(u=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function Tt(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===ct.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,s)=>({...n,[s]:Rt(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",s]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Rt(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===ct.ZodString&&e.keyType._def.checks?.length){const s=Object.entries(bt(e.keyType._def,t)).reduce((e,[t,n])=>"type"===t?e:{...e,[t]:n},{});return{...n,propertyNames:s}}return e.keyType?._def.typeName===ct.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const At={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Ct=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>Rt(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function Ot(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Rt(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Rt(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function Rt(e,t,n=!1){const s=t.seen.get(e);if(t.override){const r=t.override?.(e,t,s,n);if(r!==E)return r}if(s&&!n){const e=Et(s,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const r={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,r);const a=Pt(e,e.typeName,t,n);return a&&$t(e,t,a),r.jsonSchema=a,a}const Et=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Nt(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Nt=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Pt=(e,t,n,s)=>{switch(t){case ct.ZodString:return bt(e,n);case ct.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"int":n.type="integer",ut(n,"type",s.message,t);break;case"min":"jsonSchema7"===t.target?s.inclusive?lt(n,"minimum",s.value,s.message,t):lt(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),lt(n,"minimum",s.value,s.message,t));break;case"max":"jsonSchema7"===t.target?s.inclusive?lt(n,"maximum",s.value,s.message,t):lt(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),lt(n,"maximum",s.value,s.message,t));break;case"multipleOf":lt(n,"multipleOf",s.value,s.message,t)}return n}(e,n);case ct.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((e,[n,s])=>{if(void 0===s||void 0===s._def)return e;const r=[...t.currentPath,"properties",n],a=Rt(s._def,{...t,currentPath:r,propertyPath:r});if(void 0===a)return e;if(t.openaiStrictMode&&s.isOptional()&&!s.isNullable()&&void 0===s._def?.defaultValue)throw new Error(`Zod field at \`${r.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...e.properties,[n]:a},required:s.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}},{properties:{},required:[]}),additionalProperties:Ot(e,t)};return n.required.length||delete n.required,n}(e,n);case ct.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const s of e.checks)switch(s.kind){case"min":"jsonSchema7"===t.target?s.inclusive?lt(n,"minimum",s.value,s.message,t):lt(n,"exclusiveMinimum",s.value,s.message,t):(s.inclusive||(n.exclusiveMinimum=!0),lt(n,"minimum",s.value,s.message,t));break;case"max":"jsonSchema7"===t.target?s.inclusive?lt(n,"maximum",s.value,s.message,t):lt(n,"exclusiveMaximum",s.value,s.message,t):(s.inclusive||(n.exclusiveMaximum=!0),lt(n,"maximum",s.value,s.message,t));break;case"multipleOf":lt(n,"multipleOf",s.value,s.message,t)}return n}(e,n);case ct.ZodBoolean:return{type:"boolean"};case ct.ZodDate:return dt(e,n);case ct.ZodUndefined:return{not:{}};case ct.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case ct.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==ct.ZodAny&&(n.items=Rt(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&lt(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&lt(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(lt(n,"minItems",e.exactLength.value,e.exactLength.message,t),lt(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case ct.ZodUnion:case ct.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Ct(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in At&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=At[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Ct(e,t)}(e,n);case ct.ZodIntersection:return function(e,t){const n=[Rt(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Rt(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let s="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const r=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...s}=e;t=s}else s=void 0;r.push(t)}else r.push(...e.allOf),void 0===e.unevaluatedProperties&&(s=void 0);var t}),r.length?{allOf:r,...s}:void 0}(e,n);case ct.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>Rt(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Rt(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>Rt(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case ct.ZodRecord:return Tt(e,n);case ct.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case ct.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case ct.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),s=Array.from(new Set(n.map(e=>typeof e)));return{type:1===s.length?"string"===s[0]?"string":"number":["string","number"],enum:n}}(e);case ct.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:At[e.innerType._def.typeName],nullable:!0}:{type:[At[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Rt(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Rt(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case ct.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Rt(e.innerType._def,t);const n=Rt(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case ct.ZodMap:return function(e,t){return"record"===t.mapStrategy?Tt(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Rt(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Rt(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case ct.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Rt(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&lt(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&lt(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case ct.ZodLazy:return Rt(e.getter()._def,n);case ct.ZodPromise:return function(e,t){return Rt(e.type._def,t)}(e,n);case ct.ZodNaN:case ct.ZodNever:return{not:{}};case ct.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?Rt(e.schema._def,t,n):{}}(e,n,s);case ct.ZodAny:case ct.ZodUnknown:return{};case ct.ZodDefault:return function(e,t){return{...Rt(e.innerType._def,t),default:e.defaultValue()}}(e,n);case ct.ZodBranded:return function(e,t){return Rt(e.type._def,t)}(e,n);case ct.ZodReadonly:case ct.ZodCatch:return((e,t)=>Rt(e.innerType._def,t))(e,n);case ct.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Rt(e.in._def,t);if("output"===t.pipeStrategy)return Rt(e.out._def,t);const n=Rt(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Rt(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case ct.ZodFunction:case ct.ZodVoid:case ct.ZodSymbol:default:return}},$t=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Dt=(e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...N,basePath:["#"],definitions:{},name:e}:{...N,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[P(n),{def:P(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),s="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,r=Rt(e._def,void 0===s?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??{},a="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==a&&(r.title=a);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let s=0;s<500;s++){const s=Object.entries(n.definitions).filter(([e])=>!t.has(e));if(0===s.length)break;for(const[r,a]of s)e[r]=Rt(P(a),{...n,currentPath:[...n.basePath,n.definitionPath,r]},!0)??{},t.add(r)}return e})(),o=void 0===s?i?{...r,[n.definitionPath]:i}:r:"duplicate-ref"===n.nameStrategy?{...r,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[s]:r}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...i,[s]:r}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function jt(e,t){const n=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:Lt(t,e)};if("message"===e.type){const n=e.content.map(e=>"output_text"===e.type?{...e,parsed:Mt(t,e.text)}:e);return{...e,content:n}}return e}),s=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||Ft(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const e of s.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),s}function Mt(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function Zt(e){return"auto-parseable-tool"===e?.$brand}function Lt(e,t){const n=(s=e.tools??[],r=t.name,s.find(e=>"function"===e.type&&e.name===r));var s,r;return{...t,...t,parsed_arguments:Zt(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function Ft(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}function qt(e,t){return Dt(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Ut(e,t,n){return function(t){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),n}({type:"json_schema",...n,name:t,strict:!0,schema:qt(e,{name:t})})}class Bt extends Error{state;constructor(e,t){super(e),this.state=t}}class Jt extends Bt{}class zt extends Bt{}class Wt extends Bt{}class Gt extends Bt{}class Kt extends Bt{error;constructor(e,t,n){super(e,n),this.error=t}}class Ht extends Bt{error;constructor(e,t,n){super(e,n),this.error=t}}class Vt extends Bt{result;constructor(e,t,n){super(e,n),this.result=t}}class Xt extends Bt{result;constructor(e,t,n){super(e,n),this.result=t}}function Yt(e){return"object"==typeof e&&null!==e&&"_def"in e&&"object"==typeof e._def&&null!==e._def&&"typeName"in e._def&&"ZodObject"===e._def.typeName}function Qt(e){if(0===(e=(e=e.replace(/\s/g,"_")).replace(/[^a-zA-Z0-9]/g,"_")).length)throw new Error("Tool name cannot be empty");return e}function en(e,t){if(Yt(e)){const s=function(e,{parser:t,callback:n}){const s={...e};return Object.defineProperties(s,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:n,enumerable:!1}}),s}({type:"function",name:(n={name:t,parameters:e,function:()=>{},description:""}).name,parameters:qt(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))});return{schema:s.parameters,parser:s.$parseRaw}}var n;if("object"==typeof e&&null!==e)return{schema:e,parser:e=>JSON.parse(e)};throw new Gt("Input type is not a ZodObject or a valid JSON schema")}function tn(e){if("text"===e)return"text";if(Yt(e)){const t=Ut(e,"output");return{type:t.type,name:t.name,strict:t.strict||!1,schema:t.schema}}return e}var nn=n(833);function sn(e){const t={};return"true"===t[e]||"1"===t[e]}const rn={get disabled(){return!0}},an={get dontLogModelData(){return sn("OPENAI_AGENTS_DONT_LOG_MODEL_DATA")},get dontLogToolData(){return sn("OPENAI_AGENTS_DONT_LOG_TOOL_DATA")}},on=an.dontLogModelData,cn=an.dontLogToolData;function un(e="openai-agents"){return{namespace:e,debug:nn(e),error:console.error,warn:console.warn,dontLogModelData:on,dontLogToolData:cn}}const ln=un("openai-agents:core"),dn=ln;function pn(e){if(null==e)return String(e);if("string"==typeof e)return e;if("object"==typeof e)try{return JSON.stringify(e)}catch(e){return"[object with circular references]"}return String(e)}function hn(e){return{type:"computer",name:e.name??"computer_use_preview",computer:e.computer}}function mn(e){return{type:"hosted_tool",name:"hosted_mcp",providerData:void 0===e.requireApproval||"never"===e.requireApproval?{type:"mcp",server_label:e.serverLabel,server_url:e.serverUrl,require_approval:"never",allowed_tools:yn(e.allowedTools),headers:e.headers}:{type:"mcp",server_label:e.serverLabel,server_url:e.serverUrl,allowed_tools:yn(e.allowedTools),headers:e.headers,require_approval:"string"==typeof e.requireApproval?"always":_n(e.requireApproval),on_approval:e.onApproval}}}function fn(e,t){return`An error occurred while running the tool. Please try again. Error: ${t instanceof Error?t.toString():String(t)}`}function gn(e){const t=e.name?Qt(e.name):Qt(e.execute.name),n=void 0===e.errorFunction?fn:e.errorFunction;if(!t)throw new Error("Tool name cannot be empty. Either name your function or provide a name in the options.");const s=e.strict??!0;if(!s&&Yt(e.parameters))throw new Gt("Strict mode is required for Zod parameters");const{parser:r,schema:a}=en(e.parameters,t),o="function"==typeof e.needsApproval?e.needsApproval:async()=>"boolean"==typeof e.needsApproval&&e.needsApproval;return{type:"function",name:t,description:e.description,parameters:a,strict:s,invoke:async function(s,a){return async function(n,s){const[a,o]=await i(()=>r(s));if(null!==a)throw dn.dontLogToolData?dn.debug(`Invalid JSON input for tool ${t}`):dn.debug(`Invalid JSON input for tool ${t}: ${s}`),new Wt("Invalid JSON input for tool");dn.dontLogToolData?dn.debug(`Invoking tool ${t}`):dn.debug(`Invoking tool ${t} with input ${s}`);const c=await e.execute(o,n),u=pn(c);return dn.dontLogToolData?dn.debug(`Tool ${t} completed`):dn.debug(`Tool ${t} returned: ${u}`),c}(s,a).catch(e=>{if(n){const r=Rr();return r?.setError({message:"Error running tool (non-fatal)",data:{tool_name:t,error:e.toString()}}),n(s,e)}throw e})},needsApproval:o}}function _n(e){const t={};return e.always&&(t.always={tool_names:e.always.toolNames}),e.never&&(t.never={tool_names:e.never.toolNames}),t}function yn(e){if(void 0!==e)return Array.isArray(e)?{tool_names:e}:{tool_names:e?.toolNames??[]}}var vn,wn;!function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),s={};for(const e of n)s[e]=t[e];return e.objectValues(s)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(vn||(vn={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(wn||(wn={}));const bn=vn.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),xn=e=>{switch(typeof e){case"undefined":return bn.undefined;case"string":return bn.string;case"number":return Number.isNaN(e)?bn.nan:bn.number;case"boolean":return bn.boolean;case"function":return bn.function;case"bigint":return bn.bigint;case"symbol":return bn.symbol;case"object":return Array.isArray(e)?bn.array:null===e?bn.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?bn.promise:"undefined"!=typeof Map&&e instanceof Map?bn.map:"undefined"!=typeof Set&&e instanceof Set?bn.set:"undefined"!=typeof Date&&e instanceof Date?bn.date:bn.object;default:return bn.unknown}},Sn=vn.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class kn extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},s=e=>{for(const r of e.issues)if("invalid_union"===r.code)r.unionErrors.map(s);else if("invalid_return_type"===r.code)s(r.returnTypeError);else if("invalid_arguments"===r.code)s(r.argumentsError);else if(0===r.path.length)n._errors.push(t(r));else{let e=n,s=0;for(;s<r.path.length;){const n=r.path[s];s===r.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(r))):e[n]=e[n]||{_errors:[]},e=e[n],s++}}};return s(this),n}static assert(e){if(!(e instanceof kn))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,vn.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}kn.create=e=>new kn(e);const In=(e,t)=>{let n;switch(e.code){case Sn.invalid_type:n=e.received===bn.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Sn.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,vn.jsonStringifyReplacer)}`;break;case Sn.unrecognized_keys:n=`Unrecognized key(s) in object: ${vn.joinValues(e.keys,", ")}`;break;case Sn.invalid_union:n="Invalid input";break;case Sn.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${vn.joinValues(e.options)}`;break;case Sn.invalid_enum_value:n=`Invalid enum value. Expected ${vn.joinValues(e.options)}, received '${e.received}'`;break;case Sn.invalid_arguments:n="Invalid function arguments";break;case Sn.invalid_return_type:n="Invalid function return type";break;case Sn.invalid_date:n="Invalid date";break;case Sn.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:vn.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Sn.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Sn.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Sn.custom:n="Invalid input";break;case Sn.invalid_intersection_types:n="Intersection results could not be merged";break;case Sn.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Sn.not_finite:n="Number must be finite";break;default:n=t.defaultError,vn.assertNever(e)}return{message:n}};let Tn=In;function An(e,t){const n=Tn,s=(e=>{const{data:t,path:n,errorMaps:s,issueData:r}=e,a=[...n,...r.path||[]],i={...r,path:a};if(void 0!==r.message)return{...r,path:a,message:r.message};let o="";const c=s.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...r,path:a,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===In?void 0:In].filter(e=>!!e)});e.common.issues.push(s)}class Cn{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const s of t){if("aborted"===s.status)return On;"dirty"===s.status&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,s=await e.value;n.push({key:t,value:s})}return Cn.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const s of t){const{key:t,value:r}=s;if("aborted"===t.status)return On;if("aborted"===r.status)return On;"dirty"===t.status&&e.dirty(),"dirty"===r.status&&e.dirty(),"__proto__"===t.value||void 0===r.value&&!s.alwaysSet||(n[t.value]=r.value)}return{status:e.value,value:n}}}const On=Object.freeze({status:"aborted"}),Rn=e=>({status:"dirty",value:e}),En=e=>({status:"valid",value:e}),Nn=e=>"aborted"===e.status,Pn=e=>"dirty"===e.status,$n=e=>"valid"===e.status,Dn=e=>"undefined"!=typeof Promise&&e instanceof Promise;var jn;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(jn||(jn={}));class Mn{constructor(e,t,n,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=s}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Zn=(e,t)=>{if($n(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new kn(e.common.issues);return this._error=t,this._error}}};function Ln(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:s,description:r}=e;if(t&&(n||s))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:r}:{errorMap:(t,r)=>{const{message:a}=e;return"invalid_enum_value"===t.code?{message:a??r.defaultError}:void 0===r.data?{message:a??s??r.defaultError}:"invalid_type"!==t.code?{message:r.defaultError}:{message:a??n??r.defaultError}},description:r}}class Fn{get description(){return this._def.description}_getType(e){return xn(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:xn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Cn,ctx:{common:e.parent.common,data:e.data,parsedType:xn(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Dn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:xn(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Zn(n,s)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:xn(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return $n(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>$n(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:xn(e)},s=this._parse({data:e,path:n.path,parent:n}),r=await(Dn(s)?s:Promise.resolve(s));return Zn(n,r)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,s)=>{const r=e(t),a=()=>s.addIssue({code:Sn.custom,...n(t)});return"undefined"!=typeof Promise&&r instanceof Promise?r.then(e=>!!e||(a(),!1)):!!r||(a(),!1)})}refinement(e,t){return this._refinement((n,s)=>!!e(n)||(s.addIssue("function"==typeof t?t(n,s):t),!1))}_refinement(e){return new qs({schema:this,typeName:Vs.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Us.create(this,this._def)}nullable(){return Bs.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Ss.create(this)}promise(){return Fs.create(this,this._def)}or(e){return Ts.create([this,e],this._def)}and(e){return Rs.create(this,e,this._def)}transform(e){return new qs({...Ln(this._def),schema:this,typeName:Vs.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Js({...Ln(this._def),innerType:this,defaultValue:t,typeName:Vs.ZodDefault})}brand(){return new Gs({typeName:Vs.ZodBranded,type:this,...Ln(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new zs({...Ln(this._def),innerType:this,catchValue:t,typeName:Vs.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Ks.create(this,e)}readonly(){return Hs.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const qn=/^c[^\s-]{8,}$/i,Un=/^[0-9a-z]+$/,Bn=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Jn=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,zn=/^[a-z0-9_-]{21}$/i,Wn=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Gn=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Kn=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let Hn;const Vn=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Xn=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Yn=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Qn=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,es=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ts=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,ns="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ss=new RegExp(`^${ns}$`);function rs(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function as(e){return new RegExp(`^${rs(e)}$`)}function is(e){let t=`${ns}T${rs(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function os(e,t){return!("v4"!==t&&t||!Vn.test(e))||!("v6"!==t&&t||!Yn.test(e))}function cs(e,t){if(!Wn.test(e))return!1;try{const[n]=e.split("."),s=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),r=JSON.parse(atob(s));return!("object"!=typeof r||null===r||"typ"in r&&"JWT"!==r?.typ||!r.alg||t&&r.alg!==t)}catch{return!1}}function us(e,t){return!("v4"!==t&&t||!Xn.test(e))||!("v6"!==t&&t||!Qn.test(e))}class ls extends Fn{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==bn.string){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.string,received:t.parsedType}),On}const t=new Cn;let n;for(const s of this._def.checks)if("min"===s.kind)e.data.length<s.value&&(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("max"===s.kind)e.data.length>s.value&&(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),t.dirty());else if("length"===s.kind){const r=e.data.length>s.value,a=e.data.length<s.value;(r||a)&&(n=this._getOrReturnCtx(e,n),r?An(n,{code:Sn.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):a&&An(n,{code:Sn.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),t.dirty())}else if("email"===s.kind)Kn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"email",code:Sn.invalid_string,message:s.message}),t.dirty());else if("emoji"===s.kind)Hn||(Hn=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Hn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"emoji",code:Sn.invalid_string,message:s.message}),t.dirty());else if("uuid"===s.kind)Jn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"uuid",code:Sn.invalid_string,message:s.message}),t.dirty());else if("nanoid"===s.kind)zn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"nanoid",code:Sn.invalid_string,message:s.message}),t.dirty());else if("cuid"===s.kind)qn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"cuid",code:Sn.invalid_string,message:s.message}),t.dirty());else if("cuid2"===s.kind)Un.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"cuid2",code:Sn.invalid_string,message:s.message}),t.dirty());else if("ulid"===s.kind)Bn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"ulid",code:Sn.invalid_string,message:s.message}),t.dirty());else if("url"===s.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),An(n,{validation:"url",code:Sn.invalid_string,message:s.message}),t.dirty()}else"regex"===s.kind?(s.regex.lastIndex=0,s.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"regex",code:Sn.invalid_string,message:s.message}),t.dirty())):"trim"===s.kind?e.data=e.data.trim():"includes"===s.kind?e.data.includes(s.value,s.position)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),t.dirty()):"toLowerCase"===s.kind?e.data=e.data.toLowerCase():"toUpperCase"===s.kind?e.data=e.data.toUpperCase():"startsWith"===s.kind?e.data.startsWith(s.value)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:{startsWith:s.value},message:s.message}),t.dirty()):"endsWith"===s.kind?e.data.endsWith(s.value)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:{endsWith:s.value},message:s.message}),t.dirty()):"datetime"===s.kind?is(s).test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:"datetime",message:s.message}),t.dirty()):"date"===s.kind?ss.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:"date",message:s.message}),t.dirty()):"time"===s.kind?as(s).test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.invalid_string,validation:"time",message:s.message}),t.dirty()):"duration"===s.kind?Gn.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"duration",code:Sn.invalid_string,message:s.message}),t.dirty()):"ip"===s.kind?os(e.data,s.version)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"ip",code:Sn.invalid_string,message:s.message}),t.dirty()):"jwt"===s.kind?cs(e.data,s.alg)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"jwt",code:Sn.invalid_string,message:s.message}),t.dirty()):"cidr"===s.kind?us(e.data,s.version)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"cidr",code:Sn.invalid_string,message:s.message}),t.dirty()):"base64"===s.kind?es.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"base64",code:Sn.invalid_string,message:s.message}),t.dirty()):"base64url"===s.kind?ts.test(e.data)||(n=this._getOrReturnCtx(e,n),An(n,{validation:"base64url",code:Sn.invalid_string,message:s.message}),t.dirty()):vn.assertNever(s);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:Sn.invalid_string,...jn.errToObj(n)})}_addCheck(e){return new ls({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...jn.errToObj(e)})}url(e){return this._addCheck({kind:"url",...jn.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...jn.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...jn.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...jn.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...jn.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...jn.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...jn.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...jn.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...jn.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...jn.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...jn.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...jn.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...jn.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...jn.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...jn.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...jn.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...jn.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...jn.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...jn.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...jn.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...jn.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...jn.errToObj(t)})}nonempty(e){return this.min(1,jn.errToObj(e))}trim(){return new ls({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ls({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ls({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function ds(e,t){const n=(e.toString().split(".")[1]||"").length,s=(t.toString().split(".")[1]||"").length,r=n>s?n:s;return Number.parseInt(e.toFixed(r).replace(".",""))%Number.parseInt(t.toFixed(r).replace(".",""))/10**r}ls.create=e=>new ls({checks:[],typeName:Vs.ZodString,coerce:e?.coerce??!1,...Ln(e)});class ps extends Fn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==bn.number){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.number,received:t.parsedType}),On}let t;const n=new Cn;for(const s of this._def.checks)"int"===s.kind?vn.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.invalid_type,expected:"integer",received:"float",message:s.message}),n.dirty()):"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),n.dirty()):"multipleOf"===s.kind?0!==ds(e.data,s.value)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):"finite"===s.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.not_finite,message:s.message}),n.dirty()):vn.assertNever(s);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,jn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,jn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,jn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,jn.toString(t))}setLimit(e,t,n,s){return new ps({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:jn.toString(s)}]})}_addCheck(e){return new ps({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:jn.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:jn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:jn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:jn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:jn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:jn.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:jn.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:jn.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:jn.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&vn.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}ps.create=e=>new ps({checks:[],typeName:Vs.ZodNumber,coerce:e?.coerce||!1,...Ln(e)});class hs extends Fn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==bn.bigint)return this._getInvalidInput(e);let t;const n=new Cn;for(const s of this._def.checks)"min"===s.kind?(s.inclusive?e.data<s.value:e.data<=s.value)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"max"===s.kind?(s.inclusive?e.data>s.value:e.data>=s.value)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),n.dirty()):"multipleOf"===s.kind?e.data%s.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),An(t,{code:Sn.not_multiple_of,multipleOf:s.value,message:s.message}),n.dirty()):vn.assertNever(s);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.bigint,received:t.parsedType}),On}gte(e,t){return this.setLimit("min",e,!0,jn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,jn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,jn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,jn.toString(t))}setLimit(e,t,n,s){return new hs({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:jn.toString(s)}]})}_addCheck(e){return new hs({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:jn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:jn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:jn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:jn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:jn.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}hs.create=e=>new hs({checks:[],typeName:Vs.ZodBigInt,coerce:e?.coerce??!1,...Ln(e)});class ms extends Fn{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==bn.boolean){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.boolean,received:t.parsedType}),On}return En(e.data)}}ms.create=e=>new ms({typeName:Vs.ZodBoolean,coerce:e?.coerce||!1,...Ln(e)});class fs extends Fn{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==bn.date){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.date,received:t.parsedType}),On}if(Number.isNaN(e.data.getTime()))return An(this._getOrReturnCtx(e),{code:Sn.invalid_date}),On;const t=new Cn;let n;for(const s of this._def.checks)"min"===s.kind?e.data.getTime()<s.value&&(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),t.dirty()):"max"===s.kind?e.data.getTime()>s.value&&(n=this._getOrReturnCtx(e,n),An(n,{code:Sn.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),t.dirty()):vn.assertNever(s);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new fs({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:jn.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:jn.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}fs.create=e=>new fs({checks:[],coerce:e?.coerce||!1,typeName:Vs.ZodDate,...Ln(e)});class gs extends Fn{_parse(e){if(this._getType(e)!==bn.symbol){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.symbol,received:t.parsedType}),On}return En(e.data)}}gs.create=e=>new gs({typeName:Vs.ZodSymbol,...Ln(e)});class _s extends Fn{_parse(e){if(this._getType(e)!==bn.undefined){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.undefined,received:t.parsedType}),On}return En(e.data)}}_s.create=e=>new _s({typeName:Vs.ZodUndefined,...Ln(e)});class ys extends Fn{_parse(e){if(this._getType(e)!==bn.null){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.null,received:t.parsedType}),On}return En(e.data)}}ys.create=e=>new ys({typeName:Vs.ZodNull,...Ln(e)});class vs extends Fn{constructor(){super(...arguments),this._any=!0}_parse(e){return En(e.data)}}vs.create=e=>new vs({typeName:Vs.ZodAny,...Ln(e)});class ws extends Fn{constructor(){super(...arguments),this._unknown=!0}_parse(e){return En(e.data)}}ws.create=e=>new ws({typeName:Vs.ZodUnknown,...Ln(e)});class bs extends Fn{_parse(e){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.never,received:t.parsedType}),On}}bs.create=e=>new bs({typeName:Vs.ZodNever,...Ln(e)});class xs extends Fn{_parse(e){if(this._getType(e)!==bn.undefined){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.void,received:t.parsedType}),On}return En(e.data)}}xs.create=e=>new xs({typeName:Vs.ZodVoid,...Ln(e)});class Ss extends Fn{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),s=this._def;if(t.parsedType!==bn.array)return An(t,{code:Sn.invalid_type,expected:bn.array,received:t.parsedType}),On;if(null!==s.exactLength){const e=t.data.length>s.exactLength.value,r=t.data.length<s.exactLength.value;(e||r)&&(An(t,{code:e?Sn.too_big:Sn.too_small,minimum:r?s.exactLength.value:void 0,maximum:e?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(null!==s.minLength&&t.data.length<s.minLength.value&&(An(t,{code:Sn.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),null!==s.maxLength&&t.data.length>s.maxLength.value&&(An(t,{code:Sn.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>s.type._parseAsync(new Mn(t,e,t.path,n)))).then(e=>Cn.mergeArray(n,e));const r=[...t.data].map((e,n)=>s.type._parseSync(new Mn(t,e,t.path,n)));return Cn.mergeArray(n,r)}get element(){return this._def.type}min(e,t){return new Ss({...this._def,minLength:{value:e,message:jn.toString(t)}})}max(e,t){return new Ss({...this._def,maxLength:{value:e,message:jn.toString(t)}})}length(e,t){return new Ss({...this._def,exactLength:{value:e,message:jn.toString(t)}})}nonempty(e){return this.min(1,e)}}function ks(e){if(e instanceof Is){const t={};for(const n in e.shape){const s=e.shape[n];t[n]=Us.create(ks(s))}return new Is({...e._def,shape:()=>t})}return e instanceof Ss?new Ss({...e._def,type:ks(e.element)}):e instanceof Us?Us.create(ks(e.unwrap())):e instanceof Bs?Bs.create(ks(e.unwrap())):e instanceof Es?Es.create(e.items.map(e=>ks(e))):e}Ss.create=(e,t)=>new Ss({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Vs.ZodArray,...Ln(t)});class Is extends Fn{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=vn.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==bn.object){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.object,received:t.parsedType}),On}const{status:t,ctx:n}=this._processInputParams(e),{shape:s,keys:r}=this._getCached(),a=[];if(!(this._def.catchall instanceof bs&&"strip"===this._def.unknownKeys))for(const e in n.data)r.includes(e)||a.push(e);const i=[];for(const e of r){const t=s[e],r=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new Mn(n,r,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof bs){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(An(n,{code:Sn.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const s=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new Mn(n,s,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const n=await t.key,s=await t.value;e.push({key:n,value:s,alwaysSet:t.alwaysSet})}return e}).then(e=>Cn.mergeObjectSync(t,e)):Cn.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return jn.errToObj,new Is({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const s=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:jn.errToObj(e).message??s}:{message:s}}}:{}})}strip(){return new Is({...this._def,unknownKeys:"strip"})}passthrough(){return new Is({...this._def,unknownKeys:"passthrough"})}extend(e){return new Is({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Is({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Vs.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Is({...this._def,catchall:e})}pick(e){const t={};for(const n of vn.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Is({...this._def,shape:()=>t})}omit(e){const t={};for(const n of vn.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Is({...this._def,shape:()=>t})}deepPartial(){return ks(this)}partial(e){const t={};for(const n of vn.objectKeys(this.shape)){const s=this.shape[n];e&&!e[n]?t[n]=s:t[n]=s.optional()}return new Is({...this._def,shape:()=>t})}required(e){const t={};for(const n of vn.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof Us;)e=e._def.innerType;t[n]=e}return new Is({...this._def,shape:()=>t})}keyof(){return Ms(vn.objectKeys(this.shape))}}Is.create=(e,t)=>new Is({shape:()=>e,unknownKeys:"strip",catchall:bs.create(),typeName:Vs.ZodObject,...Ln(t)}),Is.strictCreate=(e,t)=>new Is({shape:()=>e,unknownKeys:"strict",catchall:bs.create(),typeName:Vs.ZodObject,...Ln(t)}),Is.lazycreate=(e,t)=>new Is({shape:e,unknownKeys:"strip",catchall:bs.create(),typeName:Vs.ZodObject,...Ln(t)});class Ts extends Fn{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new kn(e.ctx.common.issues));return An(t,{code:Sn.invalid_union,unionErrors:n}),On});{let e;const s=[];for(const r of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=r._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&s.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const r=s.map(e=>new kn(e));return An(t,{code:Sn.invalid_union,unionErrors:r}),On}}get options(){return this._def.options}}Ts.create=(e,t)=>new Ts({options:e,typeName:Vs.ZodUnion,...Ln(t)});const As=e=>e instanceof Ds?As(e.schema):e instanceof qs?As(e.innerType()):e instanceof js?[e.value]:e instanceof Zs?e.options:e instanceof Ls?vn.objectValues(e.enum):e instanceof Js?As(e._def.innerType):e instanceof _s?[void 0]:e instanceof ys?[null]:e instanceof Us?[void 0,...As(e.unwrap())]:e instanceof Bs?[null,...As(e.unwrap())]:e instanceof Gs||e instanceof Hs?As(e.unwrap()):e instanceof zs?As(e._def.innerType):[];class Cs extends Fn{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==bn.object)return An(t,{code:Sn.invalid_type,expected:bn.object,received:t.parsedType}),On;const n=this.discriminator,s=t.data[n],r=this.optionsMap.get(s);return r?t.common.async?r._parseAsync({data:t.data,path:t.path,parent:t}):r._parseSync({data:t.data,path:t.path,parent:t}):(An(t,{code:Sn.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),On)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const s=new Map;for(const n of t){const t=As(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const r of t){if(s.has(r))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(r)}`);s.set(r,n)}}return new Cs({typeName:Vs.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...Ln(n)})}}function Os(e,t){const n=xn(e),s=xn(t);if(e===t)return{valid:!0,data:e};if(n===bn.object&&s===bn.object){const n=vn.objectKeys(t),s=vn.objectKeys(e).filter(e=>-1!==n.indexOf(e)),r={...e,...t};for(const n of s){const s=Os(e[n],t[n]);if(!s.valid)return{valid:!1};r[n]=s.data}return{valid:!0,data:r}}if(n===bn.array&&s===bn.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let s=0;s<e.length;s++){const r=Os(e[s],t[s]);if(!r.valid)return{valid:!1};n.push(r.data)}return{valid:!0,data:n}}return n===bn.date&&s===bn.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}class Rs extends Fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=(e,s)=>{if(Nn(e)||Nn(s))return On;const r=Os(e.value,s.value);return r.valid?((Pn(e)||Pn(s))&&t.dirty(),{status:t.value,value:r.data}):(An(n,{code:Sn.invalid_intersection_types}),On)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>s(e,t)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Rs.create=(e,t,n)=>new Rs({left:e,right:t,typeName:Vs.ZodIntersection,...Ln(n)});class Es extends Fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bn.array)return An(n,{code:Sn.invalid_type,expected:bn.array,received:n.parsedType}),On;if(n.data.length<this._def.items.length)return An(n,{code:Sn.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),On;!this._def.rest&&n.data.length>this._def.items.length&&(An(n,{code:Sn.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const s=[...n.data].map((e,t)=>{const s=this._def.items[t]||this._def.rest;return s?s._parse(new Mn(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(s).then(e=>Cn.mergeArray(t,e)):Cn.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new Es({...this._def,rest:e})}}Es.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Es({items:e,typeName:Vs.ZodTuple,rest:null,...Ln(t)})};class Ns extends Fn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bn.object)return An(n,{code:Sn.invalid_type,expected:bn.object,received:n.parsedType}),On;const s=[],r=this._def.keyType,a=this._def.valueType;for(const e in n.data)s.push({key:r._parse(new Mn(n,e,n.path,e)),value:a._parse(new Mn(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Cn.mergeObjectAsync(t,s):Cn.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,n){return new Ns(t instanceof Fn?{keyType:e,valueType:t,typeName:Vs.ZodRecord,...Ln(n)}:{keyType:ls.create(),valueType:e,typeName:Vs.ZodRecord,...Ln(t)})}}class Ps extends Fn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bn.map)return An(n,{code:Sn.invalid_type,expected:bn.map,received:n.parsedType}),On;const s=this._def.keyType,r=this._def.valueType,a=[...n.data.entries()].map(([e,t],a)=>({key:s._parse(new Mn(n,e,n.path,[a,"key"])),value:r._parse(new Mn(n,t,n.path,[a,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of a){const s=await n.key,r=await n.value;if("aborted"===s.status||"aborted"===r.status)return On;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of a){const s=n.key,r=n.value;if("aborted"===s.status||"aborted"===r.status)return On;"dirty"!==s.status&&"dirty"!==r.status||t.dirty(),e.set(s.value,r.value)}return{status:t.value,value:e}}}}Ps.create=(e,t,n)=>new Ps({valueType:t,keyType:e,typeName:Vs.ZodMap,...Ln(n)});class $s extends Fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==bn.set)return An(n,{code:Sn.invalid_type,expected:bn.set,received:n.parsedType}),On;const s=this._def;null!==s.minSize&&n.data.size<s.minSize.value&&(An(n,{code:Sn.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),null!==s.maxSize&&n.data.size>s.maxSize.value&&(An(n,{code:Sn.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());const r=this._def.valueType;function a(e){const n=new Set;for(const s of e){if("aborted"===s.status)return On;"dirty"===s.status&&t.dirty(),n.add(s.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map((e,t)=>r._parse(new Mn(n,e,n.path,t)));return n.common.async?Promise.all(i).then(e=>a(e)):a(i)}min(e,t){return new $s({...this._def,minSize:{value:e,message:jn.toString(t)}})}max(e,t){return new $s({...this._def,maxSize:{value:e,message:jn.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}$s.create=(e,t)=>new $s({valueType:e,minSize:null,maxSize:null,typeName:Vs.ZodSet,...Ln(t)});class Ds extends Fn{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Ds.create=(e,t)=>new Ds({getter:e,typeName:Vs.ZodLazy,...Ln(t)});class js extends Fn{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return An(t,{received:t.data,code:Sn.invalid_literal,expected:this._def.value}),On}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Ms(e,t){return new Zs({values:e,typeName:Vs.ZodEnum,...Ln(t)})}js.create=(e,t)=>new js({value:e,typeName:Vs.ZodLiteral,...Ln(t)});class Zs extends Fn{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return An(t,{expected:vn.joinValues(n),received:t.parsedType,code:Sn.invalid_type}),On}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return An(t,{received:t.data,code:Sn.invalid_enum_value,options:n}),On}return En(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Zs.create(e,{...this._def,...t})}exclude(e,t=this._def){return Zs.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Zs.create=Ms;class Ls extends Fn{_parse(e){const t=vn.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==bn.string&&n.parsedType!==bn.number){const e=vn.objectValues(t);return An(n,{expected:vn.joinValues(e),received:n.parsedType,code:Sn.invalid_type}),On}if(this._cache||(this._cache=new Set(vn.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=vn.objectValues(t);return An(n,{received:n.data,code:Sn.invalid_enum_value,options:e}),On}return En(e.data)}get enum(){return this._def.values}}Ls.create=(e,t)=>new Ls({values:e,typeName:Vs.ZodNativeEnum,...Ln(t)});class Fs extends Fn{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==bn.promise&&!1===t.common.async)return An(t,{code:Sn.invalid_type,expected:bn.promise,received:t.parsedType}),On;const n=t.parsedType===bn.promise?t.data:Promise.resolve(t.data);return En(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}Fs.create=(e,t)=>new Fs({type:e,typeName:Vs.ZodPromise,...Ln(t)});class qs extends Fn{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Vs.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),s=this._def.effect||null,r={addIssue:e=>{An(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(r.addIssue=r.addIssue.bind(r),"preprocess"===s.type){const e=s.transform(n.data,r);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return On;const s=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===s.status?On:"dirty"===s.status||"dirty"===t.value?Rn(s.value):s});{if("aborted"===t.value)return On;const s=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===s.status?On:"dirty"===s.status||"dirty"===t.value?Rn(s.value):s}}if("refinement"===s.type){const e=e=>{const t=s.refinement(e,r);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const s=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===s.status?On:("dirty"===s.status&&t.dirty(),e(s.value),{status:t.value,value:s.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?On:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===s.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!$n(e))return On;const a=s.transform(e.value,r);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>$n(e)?Promise.resolve(s.transform(e.value,r)).then(e=>({status:t.value,value:e})):On)}vn.assertNever(s)}}qs.create=(e,t,n)=>new qs({schema:e,typeName:Vs.ZodEffects,effect:t,...Ln(n)}),qs.createWithPreprocess=(e,t,n)=>new qs({schema:t,effect:{type:"preprocess",transform:e},typeName:Vs.ZodEffects,...Ln(n)});class Us extends Fn{_parse(e){return this._getType(e)===bn.undefined?En(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Us.create=(e,t)=>new Us({innerType:e,typeName:Vs.ZodOptional,...Ln(t)});class Bs extends Fn{_parse(e){return this._getType(e)===bn.null?En(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Bs.create=(e,t)=>new Bs({innerType:e,typeName:Vs.ZodNullable,...Ln(t)});class Js extends Fn{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===bn.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Js.create=(e,t)=>new Js({innerType:e,typeName:Vs.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...Ln(t)});class zs extends Fn{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Dn(s)?s.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new kn(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===s.status?s.value:this._def.catchValue({get error(){return new kn(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}zs.create=(e,t)=>new zs({innerType:e,typeName:Vs.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...Ln(t)});class Ws extends Fn{_parse(e){if(this._getType(e)!==bn.nan){const t=this._getOrReturnCtx(e);return An(t,{code:Sn.invalid_type,expected:bn.nan,received:t.parsedType}),On}return{status:"valid",value:e.data}}}Ws.create=e=>new Ws({typeName:Vs.ZodNaN,...Ln(e)}),Symbol("zod_brand");class Gs extends Fn{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ks extends Fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?On:"dirty"===e.status?(t.dirty(),Rn(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?On:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new Ks({in:e,out:t,typeName:Vs.ZodPipeline})}}class Hs extends Fn{_parse(e){const t=this._def.innerType._parse(e),n=e=>($n(e)&&(e.value=Object.freeze(e.value)),e);return Dn(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}var Vs;Hs.create=(e,t)=>new Hs({innerType:e,typeName:Vs.ZodReadonly,...Ln(t)}),Is.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Vs||(Vs={}));const Xs=ls.create,Ys=ps.create,Qs=(Ws.create,hs.create,ms.create),er=(fs.create,gs.create,_s.create,ys.create,vs.create),tr=(ws.create,bs.create,xs.create,Ss.create),nr=Is.create,sr=(Is.strictCreate,Ts.create),rr=Cs.create,ar=(Rs.create,Es.create,Ns.create),ir=(Ps.create,$s.create,Ds.create),or=js.create,cr=Zs.create;Ls.create,Fs.create,qs.create,Us.create,Bs.create,qs.createWithPreprocess,Ks.create;class ur{cacheToolsList;_cachedTools=void 0;logger;constructor(e){this.logger=e.logger??un("openai-agents:stdio-mcp-client"),this.cacheToolsList=e.cacheToolsList??!1}debugLog(e){nn.enabled(this.logger.namespace)&&this.logger.debug(e())}}class lr{cacheToolsList;_cachedTools=void 0;logger;constructor(e){this.logger=e.logger??un("openai-agents:streamable-http-mcp-client"),this.cacheToolsList=e.cacheToolsList??!1}debugLog(e){nn.enabled(this.logger.namespace)&&this.logger.debug(e())}}nr({name:Xs(),description:Xs().optional(),inputSchema:nr({type:or("object"),properties:ar(Xs(),er()),required:tr(Xs()),additionalProperties:Qs()})});class dr extends ur{underlying;constructor(e){super(e),this.underlying=new yr(e)}get name(){return this.underlying.name}connect(){return this.underlying.connect()}close(){return this.underlying.close()}async listTools(){if(this.cacheToolsList&&this._cachedTools)return this._cachedTools;const e=await this.underlying.listTools();return this.cacheToolsList&&(this._cachedTools=e),e}callTool(e,t){return this.underlying.callTool(e,t)}}class pr extends lr{underlying;constructor(e){super(e),this.underlying=new vr(e)}get name(){return this.underlying.name}connect(){return this.underlying.connect()}close(){return this.underlying.close()}async listTools(){if(this.cacheToolsList&&this._cachedTools)return this._cachedTools;const e=await this.underlying.listTools();return this.cacheToolsList&&(this._cachedTools=e),e}callTool(e,t){return this.underlying.callTool(e,t)}}const hr={};function mr(e){delete hr[e]}async function fr(e,t){return e.cacheToolsList&&hr[e.name]?hr[e.name].map(n=>_r(n,e,t)):ka(async n=>{const s=await e.listTools();n.spanData.result=s.map(e=>e.name);const r=s.map(n=>_r(n,e,t));return e.cacheToolsList&&(hr[e.name]=s),r},{data:{server:e.name}})}async function gr(e,t=!1){return async function(e,t=!1){const n=[],s=new Set;for(const r of e){const e=await fr(r,t),a=[...new Set(e.map(e=>e.name))].filter(e=>s.has(e));if(a.length>0)throw new Gt(`Duplicate tool names found across MCP servers: ${a.join(", ")}`);for(const t of e)s.add(t.name),n.push(t)}return n}(e,t)}function _r(e,t,n){async function s(n,s){let r={};"string"==typeof n&&n?r=JSON.parse(n):"object"==typeof n&&null!=n&&(r=n);const a=Rr();a&&(a.spanData.mcp_data={server:t.name});const i=await t.callTool(e.name,r);return 1===i.length?i[0]:i}const r={type:e.inputSchema?.type??"object",properties:e.inputSchema?.properties??{},required:e.inputSchema?.required??[],additionalProperties:e.inputSchema?.additionalProperties??!1};if(n||!0===r.additionalProperties)try{const t=function(e){const t={...e,additionalProperties:!1};return t.required||(t.required=[]),t}(r);return gn({name:e.name,description:e.description||"",parameters:t,strict:!0,execute:s})}catch(e){ln.warn(`Error converting MCP schema to strict mode: ${e}`)}const a={...r,additionalProperties:!0};return gn({name:e.name,description:e.description||"",parameters:a,strict:!1,execute:s})}class yr extends ur{constructor(e){super(e)}get name(){return"MCPServerStdio"}connect(){throw new Error("Method not implemented.")}close(){throw new Error("Method not implemented.")}listTools(){throw new Error("Method not implemented.")}callTool(e,t){throw new Error("Method not implemented.")}}class vr extends lr{constructor(e){super(e)}get name(){return"MCPServerStdio"}connect(){throw new Error("Method not implemented.")}close(){throw new Error("Method not implemented.")}listTools(){throw new Error("Method not implemented.")}callTool(e,t){throw new Error("Method not implemented.")}}class wr{#e=new EventTarget;on(e,t){return this.#e.addEventListener(e,e=>t(...e.detail??[])),this}off(e,t){return this.#e.removeEventListener(e,e=>t(...e.detail??[])),this}emit(e,...t){const n=new CustomEvent(e,{detail:t});return this.#e.dispatchEvent(n)}once(e,t){const n=(...s)=>{this.off(e,n),t(...s)};return this.on(e,n),this}}const br=crypto.randomUUID.bind(crypto),xr=class{constructor(){}pipeTo(e,t){}pipeThrough(e,t){}},Sr=globalThis.ReadableStream,kr=(globalThis.ReadableStreamDefaultController,globalThis.TransformStream);class Ir{context=null;constructor(){}run(e,t){return this.context=e,t()}getStore(){return this.context}enterWith(e){this.context=e}}const Tr=new class{constructor(){}setTimeout(e,t){const n=setTimeout(e,t);return n.ref="function"==typeof n.ref?n.ref:()=>n,n.unref="function"==typeof n.unref?n.unref:()=>n,n.hasRef="function"==typeof n.hasRef?n.hasRef:()=>!0,n.refresh="function"==typeof n.refresh?n.refresh:()=>n,n}clearTimeout(e){window.clearTimeout(e)}};let Ar;function Cr(){return Ar??=new Ir,Ar}function Or(){const e=Cr().getStore();return e?.trace?e.trace:null}function Rr(){const e=Cr().getStore();return e?.span?e.span:null}function Er(e){return async()=>{const t=Or();if(!t)throw new Error("No trace found");await t.start();const n=await e(t);return await t.end(),n}}async function Nr(e,t,n={}){const s="string"==typeof e?ta().createTrace({...n,name:e}):e;return Cr().run({trace:s},Er(t))}async function Pr(e,t={}){if(Or())return await e();const n=ta().createTrace(t);return Cr().run({trace:n},Er(e))}function $r(e){const t=Cr().getStore();if(!t)throw new Error("No existing trace found");t.span&&(t.span.previousSpan=t.previousSpan,t.previousSpan=t.span),t.span=e,Cr().enterWith(t)}function Dr(){const e=Cr().getStore();e&&(e.span=e.previousSpan,e.previousSpan=e.previousSpan?.previousSpan,Cr().enterWith(e))}function jr(e){const t=Rr();t&&t.setError(e)}function Mr(e){const t=Cr().getStore();if(!t)throw new Error("No existing trace found");const n=(s=t,{trace:s.trace?.clone(),span:s.span?.clone(),previousSpan:s.previousSpan?.clone()});var s;return Cr().run(n,e)}class Zr{async export(e){if(rn.disabled)dn.debug("Tracing is disabled. Skipping export");else for(const t of e)"trace"===t.type?console.log(`[Exporter] Export trace traceId=${t.traceId} name=${t.name}`):console.log(`[Exporter] Export span: ${JSON.stringify(t)}`)}}class Lr{#t;#n;#s;#r;#a;#i=[];#o;#c=null;#u=!1;#l=null;constructor(e,{maxQueueSize:t=1e3,maxBatchSize:n=100,scheduleDelay:s=5e3,exportTriggerRatio:r=.8}={}){this.#t=t,this.#n=n,this.#s=s,this.#r=t*r,this.#a=e,this.#o=Tr,dn.debug("Automatic trace export loop is not supported in this environment. You need to manually call `getGlobalTraceProvider().forceFlush()` to export traces.")}start(){this.#l=new AbortController,this.#d()}async#p(e){this.#i.length+1>this.#t?dn.error("Dropping trace because buffer is full"):(this.#i.push(e),this.#i.length>this.#r&&await this.#h())}#d(){this.#c=this.#o.setTimeout(async()=>{await this.#h(),this.#d()},this.#s),"function"==typeof this.#c.unref&&this.#c.unref()}async#h(e=!1){if(0!==this.#i.length)if(dn.debug(`Exporting batches. Force: ${e}. Buffer size: ${this.#i.length}`),e||this.#i.length<this.#n){const e=[...this.#i];this.#i=[],this.#u=!0,await this.#a.export(e),this.#u=!1}else if(this.#i.length>0){const e=this.#i.splice(0,this.#n);this.#u=!0,await this.#a.export(e),this.#u=!1}}async onTraceStart(e){await this.#p(e)}async onTraceEnd(e){}async onSpanStart(e){}async onSpanEnd(e){await this.#p(e)}async shutdown(e){for(e&&this.#o.setTimeout(()=>{this.#l?.abort()},e),dn.debug("Shutting down gracefully");this.#i.length>0;){if(dn.debug(`Waiting for buffer to empty. Items left: ${this.#i.length}`),this.#u||await this.#h(!0),this.#l?.signal.aborted){dn.debug("Timeout reached, force flushing"),await this.#h(!0);break}await new Promise(e=>this.#o.setTimeout(e,500))}dn.debug("Buffer empty. Exiting"),this.#o&&this.#c&&this.#o.clearTimeout(this.#c)}async forceFlush(){this.#i.length>0&&await this.#h(!0)}}class Fr{#m=[];start(){for(const e of this.#m)e.start&&e.start()}addTraceProcessor(e){this.#m.push(e)}setProcessors(e){dn.debug("Shutting down old processors");for(const e of this.#m)e.shutdown();this.#m=e}async onTraceStart(e){for(const t of this.#m)await t.onTraceStart(e)}async onTraceEnd(e){for(const t of this.#m)await t.onTraceEnd(e)}async onSpanStart(e){for(const t of this.#m)await t.onSpanStart(e)}async onSpanEnd(e){for(const t of this.#m)await t.onSpanEnd(e)}async shutdown(e){for(const t of this.#m)await t.shutdown(e)}async forceFlush(){for(const e of this.#m)await e.forceFlush()}}let qr,Ur=null,Br=null;function Jr(){return Br||(Br=new Lr((Ur||(Ur=new Zr),Ur))),Br}function zr(){return(new Date).toISOString()}function Wr(){return`trace_${br().replace(/-/g,"")}`}function Gr(){return`span_${br().replace(/-/g,"").slice(0,24)}`}function Kr(){return`group_${br().replace(/-/g,"").slice(0,24)}`}class Hr{type="trace.span";#f;#g;#_;#y;#v;#w;#b;#x;#S;constructor(e,t){this.#g=e.traceId,this.#_=e.spanId??Gr(),this.#f=e.data,this.#v=t,this.#y=e.parentId??null,this.#x=e.error??null,this.#w=e.startedAt??null,this.#b=e.endedAt??null}get traceId(){return this.#g}get spanData(){return this.#f}get spanId(){return this.#_}get parentId(){return this.#y}get previousSpan(){return this.#S}set previousSpan(e){this.#S=e}start(){this.#w?dn.warn("Span already started"):(this.#w=zr(),this.#v.onSpanStart(this))}end(){this.#b?dn.debug("Span already finished",this.spanData):(this.#b=zr(),this.#v.onSpanEnd(this))}setError(e){this.#x=e}get error(){return this.#x}get startedAt(){return this.#w}get endedAt(){return this.#b}clone(){const e=new Hr({traceId:this.traceId,spanId:this.spanId,parentId:this.parentId??void 0,data:this.spanData,startedAt:this.#w??void 0,endedAt:this.#b??void 0,error:this.#x??void 0},this.#v);return e.previousSpan=this.previousSpan?.clone(),e}toJSON(){return{object:this.type,id:this.spanId,trace_id:this.traceId,parent_id:this.parentId,started_at:this.startedAt,ended_at:this.endedAt,span_data:(e=this.spanData,Object.fromEntries(Object.entries(e).filter(([e])=>!e.startsWith("_")))),error:this.error};var e}}class Vr extends Hr{constructor(e,t){super({traceId:"no-op",spanId:"no-op",data:e},t)}start(){}end(){}setError(){}toJSON(){return null}}class Xr{type="trace";traceId;name;groupId=null;metadata;#v;#k;constructor(e,t){this.traceId=e.traceId??Wr(),this.name=e.name??"Agent workflow",this.groupId=e.groupId??null,this.metadata=e.metadata??{},this.#v=t??Jr(),this.#k=e.started??!1}async start(){this.#k||(this.#k=!0,await this.#v.onTraceStart(this))}async end(){this.#k&&(this.#k=!1,await this.#v.onTraceEnd(this))}clone(){return new Xr({traceId:this.traceId,name:this.name,groupId:this.groupId??void 0,metadata:this.metadata,started:this.#k})}toJSON(){return{object:this.type,id:this.traceId,workflow_name:this.name,group_id:this.groupId,metadata:this.metadata}}}class Yr extends Xr{constructor(){super({})}async start(){}async end(){}toJSON(){return null}}class Qr{#I;#T;constructor(){this.#I=new Fr,this.#T=rn.disabled,this.#A()}registerProcessor(e){this.#I.addTraceProcessor(e)}setProcessors(e){this.#I.setProcessors(e)}getCurrentTrace(){return Or()}getCurrentSpan(){return Rr()}setDisabled(e){this.#T=e}startExportLoop(){this.#I.start()}createTrace(e){if(this.#T)return dn.debug("Tracing is disabled, Not creating trace %o",e),new Yr;const t=e.traceId??Wr(),n=e.name??"Agent workflow";return dn.debug("Creating trace %s with name %s",t,n),new Xr({...e,name:n,traceId:t},this.#I)}createSpan(e,t){if(this.#T||e.disabled)return dn.debug("Tracing is disabled, Not creating span %o",e),new Vr(e.data,this.#I);let n,s;if(t){if(t instanceof Xr){if(t instanceof Yr)return dn.debug("Parent trace is no-op, returning NoopSpan"),new Vr(e.data,this.#I);s=t.traceId}else if(t instanceof Hr){if(t instanceof Vr)return dn.debug("Parent span is no-op, returning NoopSpan"),new Vr(e.data,this.#I);n=t.spanId,s=t.traceId}}else{const t=Or(),r=Rr();if(!t)return dn.error("No active trace. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Vr(e.data,this.#I);if(r instanceof Vr||t instanceof Yr)return dn.debug(`Parent ${r} or ${t} is no-op, returning NoopSpan`),new Vr(e.data,this.#I);s=t.traceId,r?(dn.debug("Using parent span %s",r.spanId),n=r.spanId):dn.debug("No parent span, using current trace %s",t.traceId)}return s?(dn.debug(`Creating span ${JSON.stringify(e.data)} with id ${e.spanId??s}`),new Hr({...e,traceId:s,parentId:n},this.#I)):(dn.error("No traceId found. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Vr(e.data,this.#I))}async shutdown(e){try{dn.debug("Shutting down tracing provider"),await this.#I.shutdown(e)}catch(e){dn.error("Error shutting down tracing provider %o",e)}}#A(){if("undefined"!=typeof process&&"function"==typeof process.on){const e=async()=>{const e=setTimeout(()=>{console.warn("Cleanup timeout, forcing exit"),process.exit(1)},5e3);try{await this.shutdown()}finally{clearTimeout(e)}};process.on("beforeExit",e),process.on("SIGINT",async()=>{await e(),ea("SIGINT")||process.exit(130)}),process.on("SIGTERM",async()=>{await e(),ea("SIGTERM")||process.exit(0)}),process.on("unhandledRejection",async(t,n)=>{dn.error("Unhandled rejection",t,n),await e(),process.listeners("unhandledRejection").length>1||process.exit(1)})}}async forceFlush(){await this.#I.forceFlush()}}function ea(e){return process.listeners(e).length>1}function ta(){return qr||(qr=new Qr),qr}function na(e){return async(t,...n)=>Mr(async()=>{const s=e(...n);$r(s);try{return s.start(),await t(s)}catch(e){throw s.setError({message:e.message,data:e.data}),e}finally{s.end(),Dr()}})}function sa(e,t){return e={},ta().createSpan({...e,data:{type:"response",...e.data}},t)}const ra=na(sa);function aa(e,t){return ta().createSpan({...e,data:{type:"agent",name:e?.data?.name??"Agent",...e?.data}},t)}const ia=na(aa);function oa(e,t){return ta().createSpan({...e,data:{type:"function",input:e?.data?.input??"",output:e?.data?.output??"",...e?.data}},t)}const ca=na(oa);function ua(e,t){return ta().createSpan({...e,data:{type:"handoff",...e?.data}},t)}const la=na(ua);function da(e,t){return ta().createSpan({...e,data:{type:"generation",...e?.data}},t)}const pa=na(da);function ha(e,t){return ta().createSpan({...e,data:{type:"custom",data:{},...e?.data}},t)}const ma=na(ha);function fa(e,t){return ta().createSpan({...e,data:{type:"guardrail",triggered:!1,...e?.data}},t)}const ga=na(fa);function _a(e,t){return ta().createSpan({...e,data:{type:"transcription",...e.data}},t)}const ya=na(_a);function va(e,t){return ta().createSpan({...e,data:{type:"speech",...e.data}},t)}const wa=na(va);function ba(e,t){return ta().createSpan({...e,data:{type:"speech_group",...e?.data}},t)}const xa=na(ba);function Sa(e,t){return ta().createSpan({...e,data:{type:"mcp_tools",...e?.data}},t)}const ka=na(Sa);function Ia(e){ta().registerProcessor(e)}function Ta(e){ta().setProcessors(e)}function Aa(e){ta().setDisabled(e)}function Ca(){ta().startExportLoop()}class Oa{on(e,t){return this.eventEmitter.on(e,t),this.eventEmitter}off(e,t){return this.eventEmitter.off(e,t),this.eventEmitter}emit(e,...t){return this.eventEmitter.emit(e,...t)}once(e,t){return this.eventEmitter.once(e,t),this.eventEmitter}}class Ra extends Oa{eventEmitter=new wr}class Ea extends Oa{eventEmitter=new wr}function Na({name:e,execute:t}){return{type:"input",name:e,guardrailFunction:t,run:async n=>({guardrail:{type:"input",name:e},output:await t(n)})}}function Pa({name:e,execute:t}){return{type:"output",name:e,guardrailFunction:t,run:async n=>({guardrail:{type:"output",name:e},agent:n.agent,agentOutput:n.agentOutput,output:await t(n)})}}function $a(e){return JSON.stringify({assistant:e.name})}class Da{toolName;toolDescription;inputJsonSchema={type:"object",properties:{},required:[],additionalProperties:!1};strictJsonSchema=!0;onInvokeHandoff;agentName;inputFilter;agent;getHandoffAsFunctionTool(){return{type:"function",name:this.toolName,description:this.toolDescription,parameters:this.inputJsonSchema,strict:this.strictJsonSchema}}constructor(e,t){this.agentName=e.name,this.onInvokeHandoff=t,this.toolName=function(e){return`transfer_to_${Qt(e.name)}`}(e),this.toolDescription=function(e){return`Handoff to the ${e.name} agent to handle the request. ${e.handoffDescription??""}`}(e),this.agent=e}}function ja(e,t={}){let n;if(!!t.onHandoff!=!!t.inputType)throw new Gt("You must provide either both `onHandoff` and `inputType` or neither.");const s=new Da(e,async function(s,r){if(n){if(!r)throw jr({message:`Handoff function expected non empty input but got: ${r}`,data:{details:"input is empty"}}),new Wt("Handoff function expected non empty input");try{const e=await n(r);t.onHandoff&&await t.onHandoff(s,e)}catch(e){throw jr({message:"Invalid JSON provided",data:{}}),dn.dontLogToolData||dn.error(`Invalid JSON when parsing: ${r}. Error: ${e}`),new Wt("Invalid JSON provided")}}else await(t.onHandoff?.(s));return e});if(t.inputType){const e=en(t.inputType,s.toolName);s.inputJsonSchema=e.schema,s.strictJsonSchema=!0,n=e.parser}return t.toolNameOverride&&(s.toolName=t.toolNameOverride),t.toolDescriptionOverride&&(s.toolDescription=t.toolDescriptionOverride),t.inputFilter&&(s.inputFilter=t.inputFilter),s}function Ma(e){return e instanceof Da?e:ja(e)}let Za;function La(e){Za=e}function Fa(){if(void 0===Za)throw new Error("No default model provider set. Make sure to set a provider using setDefaultModelProvider before calling getDefaultModelProvider or pass an explicit provider.");return Za}const qa=nr({providerData:ar(Xs(),er()).optional()}),Ua=qa.extend({id:Xs().optional()}),Ba=qa.extend({type:or("refusal"),refusal:Xs()}),Ja=qa.extend({type:or("output_text"),text:Xs()}),za=qa.extend({type:or("input_text"),text:Xs()}),Wa=qa.extend({type:or("input_image"),image:Xs().or(nr({id:Xs()})).describe("Could be a URL, base64 or an object with a file ID.")}),Ga=qa.extend({type:or("input_file"),file:Xs().describe("Either base64 encoded file data or a publicly accessible file URL").or(nr({id:Xs().describe("OpenAI file ID")})).or(nr({url:Xs().describe("Publicly accessible PDF file URL")})).describe("Contents of the file or an object with a file ID.")}),Ka=qa.extend({type:or("audio"),audio:Xs().or(nr({id:Xs()})).describe("Base64 encoded audio data or file id"),format:Xs().nullable().optional(),transcript:Xs().nullable().optional()}),Ha=qa.extend({type:or("image"),image:Xs().describe("Base64 encoded image data")}),Va=qa.extend({type:or("text"),text:Xs()}),Xa=qa.extend({type:or("image"),data:Xs().describe("Base64 encoded image data"),mediaType:Xs().describe("IANA media type of the image")}),Ya=qa.extend({type:or("computer_screenshot"),data:Xs().describe("Base64 encoded image data or URL")}),Qa=rr("type",[nr({type:or("screenshot")}),nr({type:or("click"),x:Ys(),y:Ys(),button:cr(["left","right","wheel","back","forward"])}),nr({type:or("double_click"),x:Ys(),y:Ys()}),nr({type:or("scroll"),x:Ys(),y:Ys(),scroll_x:Ys(),scroll_y:Ys()}),nr({type:or("type"),text:Xs()}),nr({type:or("wait")}),nr({type:or("move"),x:Ys(),y:Ys()}),nr({type:or("keypress"),keys:tr(Xs())}),nr({type:or("drag"),path:tr(nr({x:Ys(),y:Ys()}))})]),ei=rr("type",[Ja,Ba,za,Ka,Ha]),ti=Ua.extend({type:or("message").optional()}),ni=ti.extend({role:or("assistant"),status:cr(["in_progress","completed","incomplete"]),content:tr(ei)}),si=rr("type",[za,Wa,Ga,Ka]),ri=ti.extend({role:or("user"),content:tr(si).or(Xs())}),ai=ti.extend({role:or("system"),content:Xs()}),ii=rr("role",[ai,ni,ri]),oi=Ua.extend({type:or("hosted_tool_call"),name:Xs().describe("The name of the hosted tool"),arguments:Xs().describe("The arguments of the hosted tool call").optional(),status:Xs().optional(),output:Xs().optional()}),ci=Ua.extend({type:or("function_call"),callId:Xs().describe("The ID of the tool call"),name:Xs().describe("The name of the function"),status:cr(["in_progress","completed","incomplete"]).optional(),arguments:Xs()}),ui=Ua.extend({type:or("function_call_result"),name:Xs().describe("The name of the tool"),callId:Xs().describe("The ID of the tool call"),status:cr(["in_progress","completed","incomplete"]),output:rr("type",[Va,Xa])}),li=Ua.extend({type:or("computer_call"),callId:Xs().describe("The ID of the computer call"),status:cr(["in_progress","completed","incomplete"]),action:Qa}),di=Ua.extend({type:or("computer_call_result"),callId:Xs().describe("The ID of the computer call"),output:Ya}),pi=rr("type",[li,ci,oi]),hi=qa.extend({id:Xs().optional(),type:or("reasoning"),content:tr(za)}),mi=Ua.extend({type:or("unknown")}),fi=rr("type",[ni,oi,ci,li,hi,mi]),gi=sr([ri,ni,ai,oi,ci,li,ui,di,hi,mi]),_i=nr({requests:Ys().optional(),inputTokens:Ys(),outputTokens:Ys(),totalTokens:Ys(),inputTokensDetails:ar(Xs(),Ys()).optional(),outputTokensDetails:ar(Xs(),Ys()).optional()}),yi=qa.extend({type:or("output_text_delta"),delta:Xs()}),vi=qa.extend({type:or("response_started")}),wi=qa.extend({type:or("response_done"),response:qa.extend({id:Xs(),usage:_i,output:tr(fi)})}),bi=qa.extend({type:or("model"),event:er().describe("The event from the model")}),xi=rr("type",[yi,wi,vi,bi]);class Si{requests;inputTokens;outputTokens;totalTokens;inputTokensDetails=[];outputTokensDetails=[];constructor(e){void 0===e?(this.requests=0,this.inputTokens=0,this.outputTokens=0,this.totalTokens=0,this.inputTokensDetails=[],this.outputTokensDetails=[]):(this.requests=e?.requests??1,this.inputTokens=e?.inputTokens??0,this.outputTokens=e?.outputTokens??0,this.totalTokens=e?.totalTokens??0,this.inputTokensDetails=e?.inputTokensDetails?[e.inputTokensDetails]:[],this.outputTokensDetails=e?.outputTokensDetails?[e.outputTokensDetails]:[])}add(e){this.requests+=e.requests,this.inputTokens+=e.inputTokens,this.outputTokens+=e.outputTokens,this.totalTokens+=e.totalTokens,e.inputTokensDetails&&this.inputTokensDetails.push(...e.inputTokensDetails),e.outputTokensDetails&&this.outputTokensDetails.push(...e.outputTokensDetails)}}class ki{context;usage;#C;constructor(e={}){this.context=e,this.usage=new Si,this.#C=new Map}_rebuildApprovals(e){this.#C=new Map(Object.entries(e))}isToolApproved({toolName:e,callId:t}){const n=this.#C.get(e);if(!0===n?.approved&&!0===n.rejected)return dn.warn("Tool is permanently approved and rejected at the same time. Approval takes precedence"),!0;if(!0===n?.approved)return!0;if(!0===n?.rejected)return!1;const s=!!Array.isArray(n?.approved)&&n.approved.includes(t),r=!!Array.isArray(n?.rejected)&&n.rejected.includes(t);return s&&r?(dn.warn(`Tool call ${t} is both approved and rejected at the same time. Approval takes precedence`),!0):!!s||!r&&void 0}approveTool(e,{alwaysApprove:t=!1}={}){const n=e.rawItem.name;if(t)return void this.#C.set(n,{approved:!0,rejected:[]});const s=this.#C.get(n)??{approved:[],rejected:[]};if(Array.isArray(s.approved)){const t="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.approved.push(t)}this.#C.set(n,s)}rejectTool(e,{alwaysReject:t=!1}={}){const n=e.rawItem.name;if(t)return void this.#C.set(n,{approved:!1,rejected:!0});const s=this.#C.get(n)??{approved:[],rejected:[]};if(Array.isArray(s.rejected)){const t="callId"in e.rawItem?e.rawItem.callId:e.rawItem.id;s.rejected.push(t)}this.#C.set(n,s)}toJSON(){return{context:this.context,usage:this.usage,approvals:Object.fromEntries(this.#C.entries())}}}class Ii{state;constructor(e){this.state=e}get history(){return xo(this.input,this.newItems)}get output(){return xo([],this.newItems)}get input(){return this.state._originalInput}get newItems(){return this.state._generatedItems}get rawResponses(){return this.state._modelResponses}get lastResponseId(){const e=this.rawResponses;return e&&e.length>0?e[e.length-1].responseId:void 0}get lastAgent(){return this.state._currentAgent}get inputGuardrailResults(){return this.state._inputGuardrailResults}get outputGuardrailResults(){return this.state._outputGuardrailResults}get interruptions(){return"next_step_interruption"===this.state._currentStep?.type?this.state._currentStep.data.interruptions:[]}get finalOutput(){if("next_step_final_output"===this.state._currentStep?.type)return this.state._currentAgent.processFinalOutput(this.state._currentStep.output);dn.warn("Accessed finalOutput before agent run is completed.")}}class Ti extends Ii{constructor(e){super(e)}}class Ai extends Ii{get currentAgent(){return this.lastAgent}currentTurn=0;maxTurns;#x=null;#O;#R;#E;#N;#P;#$;#D=!1;constructor(e={}){super(e.state),this.#O=e.signal,this.#O&&this.#O.addEventListener("abort",async()=>{await this.#E.cancel()}),this.#E=new Sr({start:e=>{this.#R=e},cancel:()=>{this.#D=!0}}),this.#N=new Promise((e,t)=>{this.#P=e,this.#$=t})}_addItem(e){this.cancelled||this.#R?.enqueue(e)}_done(){!this.cancelled&&this.#R&&(this.#R.close(),this.#R=void 0,this.#P?.())}_raiseError(e){!this.cancelled&&this.#R&&(this.#R.error(e),this.#R=void 0),this.#x=e,this.#$?.(e),this.#N.catch(e=>{dn.debug(`Resulted in an error: ${e}`)})}get cancelled(){return this.#D}toStream(){return this.#E}get completed(){return this.#N}get error(){return this.#x}toTextStream(e={}){const t=this.#E.pipeThrough(new kr({transform(e,t){if("raw_model_stream_event"===e.type&&"output_text_delta"===e.data.type){const n=yi.parse(e.data);t.enqueue(n.delta)}}}));return e.compatibleWithNodeStreams?xr.fromWeb(t):t}[Symbol.asyncIterator](){return this.#E[Symbol.asyncIterator]()}}function Ci(e){return"function"===e.type?{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict}:"computer"===e.type?{type:"computer",name:e.name,environment:e.computer.environment,dimensions:e.computer.dimensions}:{type:"hosted_tool",name:e.name,providerData:e.providerData}}function Oi(e){return{toolName:e.toolName,toolDescription:e.toolDescription,inputJsonSchema:e.inputJsonSchema,strictJsonSchema:e.strictJsonSchema}}class Ri{type="base_item";rawItem;toJSON(){return{type:this.type,rawItem:this.rawItem}}}class Ei extends Ri{rawItem;agent;type="message_output_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}get content(){let e="";for(const t of this.rawItem.content)"output_text"===t.type&&(e+=t.text);return e}}class Ni extends Ri{rawItem;agent;type="tool_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Pi extends Ri{rawItem;agent;output;type="tool_call_output_item";constructor(e,t,n){super(),this.rawItem=e,this.agent=t,this.output=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),output:pn(this.output)}}}class $i extends Ri{rawItem;agent;type="reasoning_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Di extends Ri{rawItem;agent;type="handoff_call_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class ji extends Ri{rawItem;sourceAgent;targetAgent;type="handoff_output_item";constructor(e,t,n){super(),this.rawItem=e,this.sourceAgent=t,this.targetAgent=n}toJSON(){return{...super.toJSON(),sourceAgent:this.sourceAgent.toJSON(),targetAgent:this.targetAgent.toJSON()}}}class Mi extends Ri{rawItem;agent;type="tool_approval_item";constructor(e,t){super(),this.rawItem=e,this.agent=t}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}function Zi(e){return e.filter(e=>"message_output_item"===e.type).map(e=>e.content).join("")}function Li(e){if("message"!==e.type)return;if("assistant"!==e.role)return;const t=e.content[e.content.length-1];return"output_text"===t.type?t.text:void 0}class Fi{data;type="raw_model_stream_event";constructor(e){this.data=e}}class qi{name;item;type="run_item_stream_event";constructor(e,t){this.name=e,this.item=t}}class Ui{agent;type="agent_updated_stream_event";constructor(e){this.agent=e}}function Bi(e,t,n,s){const r=[],a=[],i=[],o=[],c=[],u=[],l=new Map(s.map(e=>[e.toolName,e])),d=new Map(n.filter(e=>"function"===e.type).map(e=>[e.name,e])),p=n.find(e=>"computer"===e.type),h=new Map(n.filter(e=>"hosted_tool"===e.type&&"mcp"===e.providerData?.type).map(e=>e).map(e=>[e.providerData.server_label,e]));for(const n of e.output){if("message"===n.type)"assistant"===n.role&&r.push(new Ei(n,t));else if("hosted_tool_call"===n.type){r.push(new Ni(n,t));const e=n.name;if(u.push(e),"mcp_approval_request"===n.providerData?.type||"mcp_approval_request"===n.name){const e=n.providerData,s=e.server_label,a=h.get(s);if(void 0===a){const e=`MCP server (${s}) not found in Agent (${t.name})`;throw jr({message:e,data:{mcp_server_label:s}}),new Wt(e)}const i=new Mi({type:"hosted_tool_call",name:e.name,id:e.id,status:"in_progress",providerData:e},t);c.push({requestItem:i,mcpTool:a}),a.providerData.on_approval||r.push(i)}}else if("reasoning"===n.type)r.push(new $i(n,t));else if("computer_call"===n.type){if(r.push(new Ni(n,t)),u.push("computer_use"),!p)throw jr({message:"Model produced computer action without a computer tool.",data:{agent_name:t.name}}),new Wt("Model produced computer action without a computer tool.");o.push({toolCall:n,computer:p})}if("function_call"!==n.type)continue;u.push(n.name);const e=l.get(n.name);if(e)r.push(new Di(n,t)),a.push({toolCall:n,handoff:e});else{const e=d.get(n.name);if(!e)throw jr({message:`Tool ${n.name} not found in agent ${t.name}.`,data:{tool_name:n.name,agent_name:t.name}}),new Wt(`Tool ${n.name} not found in agent ${t.name}.`);r.push(new Ni(n,t)),i.push({toolCall:n,tool:e})}}return{newItems:r,handoffs:a,functions:i,computerActions:o,mcpApprovalRequests:c,toolsUsed:u,hasToolsOrApprovalsToRun:()=>a.length>0||i.length>0||c.length>0||o.length>0}}const Ji=rr("type",[nr({type:or("next_step_handoff"),newAgent:er()}),nr({type:or("next_step_final_output"),output:Xs()}),nr({type:or("next_step_run_again")}),nr({type:or("next_step_interruption"),data:ar(Xs(),er())})]);class zi{originalInput;modelResponse;preStepItems;newStepItems;nextStep;constructor(e,t,n,s,r){this.originalInput=e,this.modelResponse=t,this.preStepItems=n,this.newStepItems=s,this.nextStep=r}get generatedItems(){return this.preStepItems.concat(this.newStepItems)}}function Wi(e,t,n){return e.resetToolChoice&&t.hasUsedTools(e)?{...n,toolChoice:void 0}:n}async function Gi(e,t,n,s,r,a,i){const o=n.filter(e=>e instanceof Mi&&"callId"in e.rawItem&&"function_call"===e.rawItem.type).map(e=>e.rawItem.callId),c=r.functions.filter(e=>o.includes(e.toolCall.callId)),u=await Vi(e,c,a,i),l=u.map(e=>e.runItem),d=r.mcpApprovalRequests.filter(e=>"tool_approval_item"===e.requestItem.type&&"hosted_tool_call"===e.requestItem.rawItem.type&&"mcp_approval_request"===e.requestItem.rawItem.providerData?.type);for(const t of d){const n=t.requestItem.rawItem.id,s=i._context.isToolApproved({toolName:t.requestItem.rawItem.name,callId:n});if(void 0!==s){const t={approve:s,approval_request_id:n,reason:void 0};l.push(new Ni({type:"hosted_tool_call",name:"mcp_approval_response",providerData:t},e))}}const p=await eo(e,u,i),h=n.filter(e=>!(e instanceof Mi));return p.isFinalOutput?(a.emit("agent_end",i._context,e,p.finalOutput),e.emit("agent_end",i._context,p.finalOutput),new zi(t,s,h,l,{type:"next_step_final_output",output:p.finalOutput})):p.isInterrupted?new zi(t,s,h,l,{type:"next_step_interruption",data:{interruptions:p.interruptions}}):new zi(t,s,h,l,{type:"next_step_run_again"})}async function Ki(e,t,n,s,r,a,o){const c=n;let u=r.newItems;const[l,d]=await Promise.all([Vi(e,r.functions,a,o),Yi(e,r.computerActions,a,o._context)]);if(u=u.concat(l.map(e=>e.runItem)),u=u.concat(d),r.mcpApprovalRequests.length>0)for(const t of r.mcpApprovalRequests){const n=t.mcpTool.providerData,s=t.requestItem.rawItem.providerData;if(n.on_approval){const r=await n.on_approval(o._context,t.requestItem),a={approve:r.approve,approval_request_id:s.id,reason:r.reason};u.push(new Ni({type:"hosted_tool_call",name:"mcp_approval_response",providerData:a},e))}else{u.push(t.requestItem);const n={type:"hosted_mcp_tool_approval",tool:t.mcpTool,runItem:new Mi({type:"hosted_tool_call",name:s.name,id:s.id,arguments:s.arguments,status:"in_progress",providerData:s},e)};l.push(n)}}if(r.handoffs.length>0)return await async function(e,t,n,s,r,a,i,o){if(s=[...s],0===a.length)return dn.warn("Incorrectly called executeHandoffCalls with no handoffs. This should not happen. Moving on."),new zi(t,r,n,s,{type:"next_step_run_again"});if(a.length>1){const t="Multiple handoffs detected, ignoring this one.";for(let n=1;n<a.length;n++)s.push(new Pi(Hi(a[n].toolCall,t),e,t))}const c=a[0];return la(async u=>{const l=c.handoff,d=await l.onInvokeHandoff(o,c.toolCall.arguments);if(u.spanData.to_agent=d.name,a.length>1){const e=a.map(e=>e.handoff.agentName);u.setError({message:"Multiple handoffs requested",data:{requested_agents:e}})}s.push(new ji(Hi(c.toolCall,$a(d)),e,d)),i.emit("agent_handoff",o,e,d),e.emit("agent_handoff",o,d);const p=l.inputFilter??i.config.handoffInputFilter;if(p){dn.debug("Filtering inputs for handoff"),"function"!=typeof p&&u.setError({message:"Invalid input filter",data:{details:"not callable"}});const e=p({inputHistory:Array.isArray(t)?[...t]:t,preHandoffItems:[...n],newItems:[...s]});t=e.inputHistory,n=e.preHandoffItems,s=e.newItems}return new zi(t,r,n,s,{type:"next_step_handoff",newAgent:d})},{data:{from_agent:e.name}})}(e,t,c,u,s,r.handoffs,a,o._context);const p=await eo(e,l,o);if(p.isFinalOutput)return a.emit("agent_end",o._context,e,p.finalOutput),e.emit("agent_end",o._context,p.finalOutput),new zi(t,s,c,u,{type:"next_step_final_output",output:p.finalOutput});if(p.isInterrupted)return new zi(t,s,c,u,{type:"next_step_interruption",data:{interruptions:p.interruptions}});const h=u.filter(e=>e instanceof Ei),m=h.length>0?Li(h[h.length-1].rawItem):void 0;if(!m)return new zi(t,s,c,u,{type:"next_step_run_again"});if("text"===e.outputType&&!r.hasToolsOrApprovalsToRun())return new zi(t,s,c,u,{type:"next_step_final_output",output:m});if("text"!==e.outputType&&m){const{parser:n}=en(e.outputType,"final_output"),[r]=await i(()=>n(m));if(r)throw jr({message:"Invalid output type",data:{error:String(r)}}),new Wt("Invalid output type");return new zi(t,s,c,u,{type:"next_step_final_output",output:m})}return new zi(t,s,c,u,{type:"next_step_run_again"})}function Hi(e,t){return{type:"function_call_result",name:e.name,callId:e.callId,status:"completed",output:{type:"text",text:pn(t)}}}async function Vi(e,t,n,s){try{return await Promise.all(t.map(async function(t){let r=t.toolCall.arguments;if(t.tool.parameters&&(r=Yt(t.tool.parameters)?t.tool.parameters.parse(r):JSON.parse(r)),await t.tool.needsApproval(s._context,r,t.toolCall.callId)){const n=s._context.isToolApproved({toolName:t.tool.name,callId:t.toolCall.callId});if(!1===n)return ca(async n=>{const s="Tool execution was not approved.";return n.setError({message:s,data:{tool_name:t.tool.name,error:`Tool execution for ${t.toolCall.callId} was manually rejected by user.`}}),n.spanData.output=s,{type:"function_output",tool:t.tool,output:s,runItem:new Pi(Hi(t.toolCall,s),e,s)}},{data:{name:t.tool.name}});if(!0!==n)return{type:"function_approval",tool:t.tool,runItem:new Mi(t.toolCall,e)}}return ca(async r=>{n.config.traceIncludeSensitiveData&&(r.spanData.input=t.toolCall.arguments);try{n.emit("agent_tool_start",s._context,e,t.tool,{toolCall:t.toolCall}),e.emit("agent_tool_start",s._context,t.tool,{toolCall:t.toolCall});const a=await t.tool.invoke(s._context,t.toolCall.arguments),i=pn(a);return n.emit("agent_tool_end",s._context,e,t.tool,i,{toolCall:t.toolCall}),e.emit("agent_tool_end",s._context,t.tool,i,{toolCall:t.toolCall}),n.config.traceIncludeSensitiveData&&(r.spanData.output=i),{type:"function_output",tool:t.tool,output:a,runItem:new Pi(Hi(t.toolCall,a),e,a)}}catch(e){throw r.setError({message:"Error running tool",data:{tool_name:t.tool.name,error:String(e)}}),e}},{data:{name:t.tool.name}})}))}catch(e){throw new Ht(`Failed to run function tools: ${e}`,e,s)}}async function Xi(e,t){const n=t.action;let s;switch(n.type){case"click":await e.click(n.x,n.y,n.button);break;case"double_click":await e.doubleClick(n.x,n.y);break;case"drag":await e.drag(n.path.map(e=>[e.x,e.y]));break;case"keypress":await e.keypress(n.keys);break;case"move":await e.move(n.x,n.y);break;case"screenshot":s=await e.screenshot();break;case"scroll":await e.scroll(n.x,n.y,n.scroll_x,n.scroll_y);break;case"type":await e.type(n.text);break;case"wait":await e.wait()}if(void 0!==s)return s;if("function"==typeof e.screenshot&&(s=await e.screenshot(),void 0!==s))return s;throw new Error("Computer does not implement screenshot()")}async function Yi(e,t,n,s,r=void 0){const a=r??dn,i=[];for(const r of t){const t=r.computer.computer,o=r.toolCall;let c;n.emit("agent_tool_start",s,e,r.computer,{toolCall:o}),"function"==typeof e.emit&&e.emit("agent_tool_start",s,r.computer,{toolCall:o});try{c=await Xi(t,o)}catch(e){a.error("Failed to execute computer action:",e),c=""}n.emit("agent_tool_end",s,e,r.computer,c,{toolCall:o}),"function"==typeof e.emit&&e.emit("agent_tool_end",s,r.computer,c,{toolCall:o});const u=c?`data:image/png;base64,${c}`:"",l={type:"computer_call_result",callId:o.callId,output:{type:"computer_screenshot",data:u}};i.push(new Pi(l,e,u))}return i}const Qi={isFinalOutput:!1,isInterrupted:void 0};async function eo(e,t,n){if(0===t.length)return Qi;const s=t.filter(e=>e.runItem instanceof Mi).map(e=>e.runItem);if(s.length>0)return{isFinalOutput:!1,isInterrupted:!0,interruptions:s};if("run_llm_again"===e.toolUseBehavior)return Qi;const r=t[0];if("stop_on_first_tool"===e.toolUseBehavior)return"function_output"===r?.type?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:pn(r.output)}:Qi;const a=e.toolUseBehavior;if("object"==typeof a){const e=t.find(e=>a.stopAtToolNames.includes(e.tool.name));return"function_output"===e?.type?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:pn(e.output)}:Qi}if("function"==typeof a)return a(n._context,t);throw new Gt(`Invalid toolUseBehavior: ${a}`,n)}function to(e,t){for(const n of t.newStepItems){let t;if(n instanceof Ei)t="message_output_created";else if(n instanceof Di)t="handoff_requested";else if(n instanceof ji)t="handoff_occurred";else if(n instanceof Ni)t="tool_called";else if(n instanceof Pi)t="tool_output";else if(n instanceof $i)t="reasoning_item_created";else{if(!(n instanceof Mi)){dn.warn("Unknown item type: ",n);continue}t="tool_approval_requested"}e._addItem(new qi(t,n))}}class no{#j=new Map;addToolUse(e,t){this.#j.set(e,t)}hasUsedTools(e){return this.#j.has(e)}toJSON(){return Object.fromEntries(Array.from(this.#j.entries()).map(([e,t])=>[e.name,t]))}}const so="1.0",ro=or(so),ao=nr({name:Xs()}),io=nr({object:or("trace.span"),id:Xs(),trace_id:Xs(),parent_id:Xs().nullable(),started_at:Xs().nullable(),ended_at:Xs().nullable(),error:nr({message:Xs(),data:ar(Xs(),er()).optional()}).nullable(),span_data:ar(Xs(),er())}).extend({previous_span:ir(()=>io).optional()}),oo=nr({requests:Ys(),inputTokens:Ys(),outputTokens:Ys(),totalTokens:Ys()}),co=nr({usage:oo,output:tr(fi),responseId:Xs().optional(),providerData:ar(Xs(),er()).optional()}),uo=rr("type",[nr({type:or("message_output_item"),rawItem:ni,agent:ao}),nr({type:or("tool_call_item"),rawItem:pi.or(oi),agent:ao}),nr({type:or("tool_call_output_item"),rawItem:ui,agent:ao,output:Xs()}),nr({type:or("reasoning_item"),rawItem:hi,agent:ao}),nr({type:or("handoff_call_item"),rawItem:ci,agent:ao}),nr({type:or("handoff_output_item"),rawItem:ui,sourceAgent:ao,targetAgent:ao}),nr({type:or("tool_approval_item"),rawItem:ci.or(oi),agent:ao})]),lo=nr({object:or("trace"),id:Xs(),workflow_name:Xs(),group_id:Xs().nullable(),metadata:ar(Xs(),er())}),po=nr({newItems:tr(uo),toolsUsed:tr(Xs()),handoffs:tr(nr({toolCall:er(),handoff:er()})),functions:tr(nr({toolCall:er(),tool:er()})),computerActions:tr(nr({toolCall:er(),computer:er()})),mcpApprovalRequests:tr(nr({requestItem:nr({rawItem:nr({type:or("hosted_tool_call"),name:Xs(),arguments:Xs().optional(),status:Xs().optional(),output:Xs().optional(),providerData:ar(Xs(),er()).nullable().optional()})}),mcpTool:nr({type:or("hosted_tool"),name:or("hosted_mcp"),providerData:ar(Xs(),er())})})).optional()}),ho=nr({tripwireTriggered:Qs(),outputInfo:er()}),mo=nr({guardrail:nr({type:or("input"),name:Xs()}),output:ho}),fo=nr({guardrail:nr({type:or("output"),name:Xs()}),agentOutput:er(),agent:ao,output:ho}),go=nr({$schemaVersion:ro,currentTurn:Ys(),currentAgent:ao,originalInput:Xs().or(tr(gi)),modelResponses:tr(co),context:nr({usage:oo,approvals:ar(Xs(),nr({approved:tr(Xs()).or(Qs()),rejected:tr(Xs()).or(Qs())})),context:ar(Xs(),er())}),toolUseTracker:ar(Xs(),tr(Xs())),maxTurns:Ys(),currentAgentSpan:io.nullable().optional(),noActiveAgentRun:Qs(),inputGuardrailResults:tr(mo),outputGuardrailResults:tr(fo),currentStep:Ji.optional(),lastModelResponse:co.optional(),generatedItems:tr(uo),lastProcessedResponse:po.optional(),trace:lo.nullable()});class _o{_currentTurn=0;_currentAgent;_originalInput;_modelResponses;_currentAgentSpan;_context;_toolUseTracker;_generatedItems;_maxTurns;_noActiveAgentRun=!0;_lastTurnResponse;_inputGuardrailResults;_outputGuardrailResults;_currentStep=void 0;_lastProcessedResponse=void 0;_trace=null;constructor(e,t,n,s){this._context=e,this._originalInput=structuredClone(t),this._modelResponses=[],this._currentAgentSpan=void 0,this._currentAgent=n,this._toolUseTracker=new no,this._generatedItems=[],this._maxTurns=s,this._inputGuardrailResults=[],this._outputGuardrailResults=[],this._trace=Or()}getInterruptions(){return"next_step_interruption"!==this._currentStep?.type?[]:this._currentStep.data.interruptions}approve(e,t={alwaysApprove:!1}){this._context.approveTool(e,t)}reject(e,t={alwaysReject:!1}){this._context.rejectTool(e,t)}toJSON(){const e={$schemaVersion:so,currentTurn:this._currentTurn,currentAgent:{name:this._currentAgent.name},originalInput:this._originalInput,modelResponses:this._modelResponses.map(e=>({usage:{requests:e.usage.requests,inputTokens:e.usage.inputTokens,outputTokens:e.usage.outputTokens,totalTokens:e.usage.totalTokens},output:e.output,responseId:e.responseId,providerData:e.providerData})),context:this._context.toJSON(),toolUseTracker:this._toolUseTracker.toJSON(),maxTurns:this._maxTurns,currentAgentSpan:this._currentAgentSpan?.toJSON(),noActiveAgentRun:this._noActiveAgentRun,inputGuardrailResults:this._inputGuardrailResults,outputGuardrailResults:this._outputGuardrailResults.map(e=>({...e,agent:e.agent.toJSON()})),currentStep:this._currentStep,lastModelResponse:this._lastTurnResponse,generatedItems:this._generatedItems.map(e=>e.toJSON()),lastProcessedResponse:this._lastProcessedResponse,trace:this._trace?this._trace.toJSON():null},t=go.safeParse(e);if(!t.success)throw new Jt(`Failed to serialize run state. ${t.error.message}`);return t.data}toString(){return JSON.stringify(this.toJSON())}static async fromString(e,t){const[n,s]=await i(()=>JSON.parse(t));if(n)throw new Gt(`Failed to parse run state. ${n instanceof Error?n.message:String(n)}`);const r=s.$schemaVersion;if(!r)throw new Gt("Run state is missing schema version");if(r!==so)throw new Gt(`Run state schema version ${r} is not supported. Please use version ${so}`);const a=go.parse(JSON.parse(t)),o=function(e){const t=new Map,n=[e];for(;n.length>0;){const e=n.shift();if(!t.has(e.name)){t.set(e.name,e);for(const s of e.handoffs)s instanceof Ao?t.has(s.name)||n.push(s):s.agent&&(t.has(s.agent.name)||n.push(s.agent))}}return t}(e),c=new ki(a.context.context);c._rebuildApprovals(a.context.approvals);const u=o.get(a.currentAgent.name);if(!u)throw new Gt(`Agent ${a.currentAgent.name} not found`);const l=new _o(c,"",u,a.maxTurns);l._currentTurn=a.currentTurn,l._toolUseTracker=new no;for(const[e,t]of Object.entries(a.toolUseTracker))l._toolUseTracker.addToolUse(o.get(e),t);if(a.currentAgentSpan){a.trace||dn.warn("Trace is not set, skipping tracing setup");const e=ta().createTrace({traceId:a.trace?.id,name:a.trace?.workflow_name,groupId:a.trace?.group_id??void 0,metadata:a.trace?.metadata});l._currentAgentSpan=yo(e,a.currentAgentSpan),l._trace=e}return l._noActiveAgentRun=a.noActiveAgentRun,l._inputGuardrailResults=a.inputGuardrailResults,l._outputGuardrailResults=a.outputGuardrailResults.map(e=>({...e,agent:o.get(e.agent.name)})),l._currentStep=a.currentStep,l._originalInput=a.originalInput,l._modelResponses=a.modelResponses.map(vo),l._lastTurnResponse=a.lastModelResponse?vo(a.lastModelResponse):void 0,l._generatedItems=a.generatedItems.map(e=>wo(e,o)),l._lastProcessedResponse=a.lastProcessedResponse?await async function(e,t,n){const s=await t.getAllTools(),r=new Map(s.filter(e=>"function"===e.type).map(e=>[e.name,e])),a=new Map(s.filter(e=>"computer"===e.type).map(e=>[e.name,e])),i=new Map(t.handoffs.map(e=>e instanceof Ao?[e.name,ja(e)]:[e.toolName,e])),o={newItems:n.newItems.map(t=>wo(t,e)),toolsUsed:n.toolsUsed,handoffs:n.handoffs.map(e=>{if(!i.has(e.handoff.toolName))throw new Gt(`Handoff ${e.handoff.toolName} not found`);return{toolCall:e.toolCall,handoff:i.get(e.handoff.toolName)}}),functions:await Promise.all(n.functions.map(async e=>{if(!r.has(e.tool.name))throw new Gt(`Tool ${e.tool.name} not found`);return{toolCall:e.toolCall,tool:r.get(e.tool.name)}})),computerActions:n.computerActions.map(e=>{const t=e.computer.name;if(!a.has(t))throw new Gt(`Computer tool ${t} not found`);return{toolCall:e.toolCall,computer:a.get(t)}}),mcpApprovalRequests:(n.mcpApprovalRequests??[]).map(e=>({requestItem:new Mi(e.requestItem.rawItem,t),mcpTool:e.mcpTool}))};return{...o,hasToolsOrApprovalsToRun:()=>o.handoffs.length>0||o.functions.length>0||o.mcpApprovalRequests.length>0||o.computerActions.length>0}}(o,l._currentAgent,a.lastProcessedResponse):void 0,"next_step_handoff"===a.currentStep?.type&&(l._currentStep={type:"next_step_handoff",newAgent:o.get(a.currentStep.newAgent.name)}),l}}function yo(e,t){const n=t.span_data,s=t.previous_span?yo(e,t.previous_span):void 0,r=ta().createSpan({spanId:t.id,traceId:t.trace_id,parentId:t.parent_id??void 0,startedAt:t.started_at??void 0,endedAt:t.ended_at??void 0,data:n},e);return r.previousSpan=s,r}function vo(e){const t=new Si;return t.requests=e.usage.requests,t.inputTokens=e.usage.inputTokens,t.outputTokens=e.usage.outputTokens,t.totalTokens=e.usage.totalTokens,{usage:t,output:e.output.map(e=>fi.parse(e)),responseId:e.responseId,providerData:e.providerData}}function wo(e,t){switch(e.type){case"message_output_item":return new Ei(e.rawItem,t.get(e.agent.name));case"tool_call_item":return new Ni(e.rawItem,t.get(e.agent.name));case"tool_call_output_item":return new Pi(e.rawItem,t.get(e.agent.name),e.output);case"reasoning_item":return new $i(e.rawItem,t.get(e.agent.name));case"handoff_call_item":return new Di(e.rawItem,t.get(e.agent.name));case"handoff_output_item":return new ji(e.rawItem,t.get(e.sourceAgent.name),t.get(e.targetAgent.name));case"tool_approval_item":return new Mi(e.rawItem,t.get(e.agent.name))}}function bo(e,t){return!e&&(!!t||"enabled_without_data")}function xo(e,t){const n=t.filter(e=>"tool_approval_item"!==e.type).map(e=>e.rawItem);return"string"==typeof e&&(e=[{type:"message",role:"user",content:e}]),[...e,...n]}class So extends Ea{config;inputGuardrailDefs;outputGuardrailDefs;constructor(e={}){super(),this.config={modelProvider:e.modelProvider??Fa(),model:e.model,modelSettings:e.modelSettings,handoffInputFilter:e.handoffInputFilter,inputGuardrails:e.inputGuardrails,outputGuardrails:e.outputGuardrails,tracingDisabled:e.tracingDisabled??!1,traceIncludeSensitiveData:e.traceIncludeSensitiveData??!0,workflowName:e.workflowName??"Agent workflow",traceId:e.traceId,groupId:e.groupId,traceMetadata:e.traceMetadata},this.inputGuardrailDefs=(e.inputGuardrails??[]).map(Na),this.outputGuardrailDefs=(e.outputGuardrails??[]).map(Pa)}async#M(e,t,n){return Mr(async()=>{const s=t instanceof _o?t:new _o(n.context instanceof ki?n.context:new ki(n.context),t,e,n.maxTurns??10);try{for(;;){let e=Io(s._currentAgent.model,this.config.model);if("string"==typeof e&&(e=await this.config.modelProvider.getModel(e)),s._currentStep=s._currentStep??{type:"next_step_run_again"},"next_step_interruption"===s._currentStep.type){if(dn.debug("Continuing from interruption"),!s._lastTurnResponse||!s._lastProcessedResponse)throw new Gt("No model response found in previous state",s);const e=await Gi(s._currentAgent,s._originalInput,s._generatedItems,s._lastTurnResponse,s._lastProcessedResponse,this,s);if(s._toolUseTracker.addToolUse(s._currentAgent,s._lastProcessedResponse.toolsUsed),s._originalInput=e.originalInput,s._generatedItems=e.generatedItems,s._currentStep=e.nextStep,"next_step_interruption"===e.nextStep.type)return new Ti(s);continue}if("next_step_run_again"===s._currentStep.type){const t=[];if(s._currentAgent.handoffs&&t.push(...s._currentAgent.handoffs.map(Ma)),!s._currentAgentSpan){const e=t.map(e=>e.agentName);s._currentAgentSpan=aa({data:{name:s._currentAgent.name,handoffs:e,output_type:s._currentAgent.outputSchemaName}}),s._currentAgentSpan.start(),$r(s._currentAgentSpan)}const r=await s._currentAgent.getAllTools(),a=r.map(e=>Ci(e)),i=t.map(e=>Oi(e));if(s._currentAgentSpan&&(s._currentAgentSpan.spanData.tools=r.map(e=>e.name)),s._currentTurn++,s._currentTurn>s._maxTurns)throw s._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:s._maxTurns}}),new zt(`Max turns (${s._maxTurns}) exceeded`,s);dn.debug(`Running agent ${s._currentAgent.name} (turn ${s._currentTurn})`),1===s._currentTurn&&await this.#Z(s);const o=xo(s._originalInput,s._generatedItems);s._noActiveAgentRun&&(s._currentAgent.emit("agent_start",s._context,s._currentAgent),this.emit("agent_start",s._context,s._currentAgent));let c={...this.config.modelSettings,...s._currentAgent.modelSettings};c=Wi(s._currentAgent,s._toolUseTracker,c),s._lastTurnResponse=await e.getResponse({systemInstructions:await s._currentAgent.getSystemPrompt(s._context),prompt:await s._currentAgent.getPrompt(s._context),input:o,previousResponseId:n.previousResponseId,modelSettings:c,tools:a,outputType:tn(s._currentAgent.outputType),handoffs:i,tracing:bo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:n.signal}),s._modelResponses.push(s._lastTurnResponse),s._context.usage.add(s._lastTurnResponse.usage),s._noActiveAgentRun=!1;const u=Bi(s._lastTurnResponse,s._currentAgent,r,t);s._lastProcessedResponse=u;const l=await Ki(s._currentAgent,s._originalInput,s._generatedItems,s._lastTurnResponse,s._lastProcessedResponse,this,s);s._toolUseTracker.addToolUse(s._currentAgent,s._lastProcessedResponse.toolsUsed),s._originalInput=l.originalInput,s._generatedItems=l.generatedItems,s._currentStep=l.nextStep}if(s._currentStep&&"next_step_final_output"===s._currentStep.type)return await this.#L(s,s._currentStep.output),this.emit("agent_end",s._context,s._currentAgent,s._currentStep.output),s._currentAgent.emit("agent_end",s._context,s._currentStep.output),new Ti(s);if(s._currentStep&&"next_step_handoff"===s._currentStep.type)s._currentAgent=s._currentStep.newAgent,s._currentAgentSpan&&(s._currentAgentSpan.end(),Dr(),s._currentAgentSpan=void 0),s._noActiveAgentRun=!0,s._currentStep={type:"next_step_run_again"};else{if(s._currentStep&&"next_step_interruption"===s._currentStep.type)return new Ti(s);dn.debug("Running next loop")}}}catch(e){throw s._currentAgentSpan&&s._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(e)}}),e}finally{s._currentAgentSpan&&("next_step_interruption"!==s._currentStep?.type&&s._currentAgentSpan.end(),Dr())}})}async#Z(e){const t=this.inputGuardrailDefs.concat(e._currentAgent.inputGuardrails.map(Na));if(t.length>0){const n={agent:e._currentAgent,input:e._originalInput,context:e._context};try{const s=await Promise.all(t.map(async t=>ga(async e=>{const s=await t.run(n);return e.spanData.triggered=s.output.tripwireTriggered,s},{data:{name:t.name}},e._currentAgentSpan)));for(const t of s)if(t.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:t.guardrail.name}}),new Vt(`Input guardrail triggered: ${JSON.stringify(t.output.outputInfo)}`,t,e)}catch(t){if(t instanceof Vt)throw t;throw e._currentTurn--,new Kt(`Input guardrail failed to complete: ${t}`,t,e)}}}async#L(e,t){const n=this.outputGuardrailDefs.concat(e._currentAgent.outputGuardrails.map(Pa));if(n.length>0){const s=e._currentAgent.processFinalOutput(t),r={agent:e._currentAgent,agentOutput:s,context:e._context,details:{modelResponse:e._lastTurnResponse}};try{const t=await Promise.all(n.map(async t=>ga(async e=>{const n=await t.run(r);return e.spanData.triggered=n.output.tripwireTriggered,n},{data:{name:t.name}},e._currentAgentSpan)));for(const n of t)if(n.output.tripwireTriggered)throw e._currentAgentSpan&&e._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:n.guardrail.name}}),new Xt(`Output guardrail triggered: ${JSON.stringify(n.output.outputInfo)}`,n,e)}catch(t){if(t instanceof Xt)throw t;throw new Kt(`Output guardrail failed to complete: ${t}`,t,e)}}}async#F(e,t){try{for(;;){const n=e.state._currentAgent,s=n.handoffs.map(Ma),r=await n.getAllTools(),a=r.map(e=>Ci(e)),i=s.map(e=>Oi(e));if(e.state._currentStep=e.state._currentStep??{type:"next_step_run_again"},"next_step_interruption"===e.state._currentStep.type){if(dn.debug("Continuing from interruption"),!e.state._lastTurnResponse||!e.state._lastProcessedResponse)throw new Gt("No model response found in previous state",e.state);const t=await Gi(e.state._currentAgent,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);if(to(e,t),e.state._toolUseTracker.addToolUse(e.state._currentAgent,e.state._lastProcessedResponse.toolsUsed),e.state._originalInput=t.originalInput,e.state._generatedItems=t.generatedItems,e.state._currentStep=t.nextStep,"next_step_interruption"===t.nextStep.type)return;continue}if("next_step_run_again"===e.state._currentStep.type){if(!e.state._currentAgentSpan){const t=s.map(e=>e.agentName);e.state._currentAgentSpan=aa({data:{name:n.name,handoffs:t,tools:r.map(e=>e.name),output_type:n.outputSchemaName}}),e.state._currentAgentSpan.start(),$r(e.state._currentAgentSpan)}if(e.state._currentTurn++,e.state._currentTurn>e.state._maxTurns)throw e.state._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:e.state._maxTurns}}),new zt(`Max turns (${e.state._maxTurns}) exceeded`,e.state);dn.debug(`Running agent ${n.name} (turn ${e.state._currentTurn})`);let o=Io(n.model,this.config.model);"string"==typeof o&&(o=await this.config.modelProvider.getModel(o)),1===e.state._currentTurn&&await this.#Z(e.state);let c={...this.config.modelSettings,...n.modelSettings};c=Wi(n,e.state._toolUseTracker,c);const u=xo(e.input,e.newItems);let l;e.state._noActiveAgentRun&&(n.emit("agent_start",e.state._context,n),this.emit("agent_start",e.state._context,n));for await(const s of o.getStreamedResponse({systemInstructions:await n.getSystemPrompt(e.state._context),prompt:await n.getPrompt(e.state._context),input:u,previousResponseId:t.previousResponseId,modelSettings:c,tools:a,handoffs:i,outputType:tn(n.outputType),tracing:bo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:t.signal})){if("response_done"===s.type){const e=wi.parse(s);l={usage:new Si(e.response.usage),output:e.response.output,responseId:e.response.id}}if(e.cancelled)return;e._addItem(new Fi(s))}if(e.state._noActiveAgentRun=!1,!l)throw new Wt("Model did not produce a final response!",e.state);e.state._lastTurnResponse=l,e.state._modelResponses.push(e.state._lastTurnResponse);const d=Bi(e.state._lastTurnResponse,n,r,s);e.state._lastProcessedResponse=d;const p=await Ki(n,e.state._originalInput,e.state._generatedItems,e.state._lastTurnResponse,e.state._lastProcessedResponse,this,e.state);to(e,p),e.state._toolUseTracker.addToolUse(n,d.toolsUsed),e.state._originalInput=p.originalInput,e.state._generatedItems=p.generatedItems,e.state._currentStep=p.nextStep}if("next_step_final_output"===e.state._currentStep.type)return void await this.#L(e.state,e.state._currentStep.output);if("next_step_interruption"===e.state._currentStep.type)return;"next_step_handoff"===e.state._currentStep.type?(e.state._currentAgent=e.state._currentStep?.newAgent,e.state._currentAgentSpan&&(e.state._currentAgentSpan.end(),Dr()),e.state._currentAgentSpan=void 0,e._addItem(new Ui(e.state._currentAgent)),e.state._noActiveAgentRun=!0,e.state._currentStep={type:"next_step_run_again"}):dn.debug("Running next loop")}}catch(t){throw e.state._currentAgentSpan&&e.state._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(t)}}),t}finally{e.state._currentAgentSpan&&("next_step_interruption"!==e.state._currentStep?.type&&e.state._currentAgentSpan.end(),Dr())}}async#q(e,t,n){return n=n??{},Mr(async()=>{const s=t instanceof _o?t:new _o(n.context instanceof ki?n.context:new ki(n.context),t,e,n.maxTurns??10),r=new Ai({signal:n.signal,state:s});return r.maxTurns=n.maxTurns??s._maxTurns,this.#F(r,n).then(()=>{r._done()},e=>{r._raiseError(e)}),r})}run(e,t,n={stream:!1,context:void 0}){return t instanceof _o&&t._trace?Nr(t._trace,async()=>(t._currentAgentSpan&&$r(t._currentAgentSpan),n?.stream?this.#q(e,t,n):this.#M(e,t,n))):Pr(async()=>n?.stream?this.#q(e,t,n):this.#M(e,t,n),{traceId:this.config.traceId,name:this.config.workflowName,groupId:this.config.groupId,metadata:this.config.traceMetadata})}}let ko;function Io(e,t){return"string"==typeof e&&e!==Ao.DEFAULT_MODEL_PLACEHOLDER||e?e:t??e??Ao.DEFAULT_MODEL_PLACEHOLDER}async function To(e,t,n){const s=ko||(ko=new So,ko);return await s.run(e,t,n)}class Ao extends Ra{static create(e){return new Ao({...e,handoffs:e.handoffs,outputType:e.outputType,handoffOutputTypeWarningEnabled:!1})}static DEFAULT_MODEL_PLACEHOLDER="";name;instructions;prompt;handoffDescription;handoffs;model;modelSettings;tools;mcpServers;inputGuardrails;outputGuardrails;outputType="text";toolUseBehavior;resetToolChoice;constructor(e){if(super(),"string"!=typeof e.name||""===e.name.trim())throw new Gt("Agent must have a name.");if(this.name=e.name,this.instructions=e.instructions??Ao.DEFAULT_MODEL_PLACEHOLDER,this.prompt=e.prompt,this.handoffDescription=e.handoffDescription??"",this.handoffs=e.handoffs??[],this.model=e.model??"",this.modelSettings=e.modelSettings??{},this.tools=e.tools??[],this.mcpServers=e.mcpServers??[],this.inputGuardrails=e.inputGuardrails??[],this.outputGuardrails=e.outputGuardrails??[],e.outputType&&(this.outputType=e.outputType),this.toolUseBehavior=e.toolUseBehavior??"run_llm_again",this.resetToolChoice=e.resetToolChoice??!0,(void 0===e.handoffOutputTypeWarningEnabled||e.handoffOutputTypeWarningEnabled)&&this.handoffs&&this.outputType){const e=new Set([JSON.stringify(this.outputType)]);for(const t of this.handoffs)"outputType"in t&&t.outputType?e.add(JSON.stringify(t.outputType)):"agent"in t&&t.agent.outputType&&e.add(JSON.stringify(t.agent.outputType));e.size>1&&dn.warn(`[Agent] Warning: Handoff agents have different output types: ${Array.from(e).join(", ")}. You can make it type-safe by using Agent.create({ ... }) method instead.`)}}get outputSchemaName(){if("text"===this.outputType)return"text";if(Yt(this.outputType))return"ZodOutput";if("object"==typeof this.outputType)return this.outputType.name;throw new Error(`Unknown output type: ${this.outputType}`)}clone(e){return new Ao({...this,...e})}asTool(e){const{toolName:t,toolDescription:n,customOutputExtractor:s}=e;return gn({name:t??Qt(this.name),description:n??"",parameters:{type:"object",properties:{input:{type:"string"}},required:["input"],additionalProperties:!1},strict:!0,execute:async(e,t)=>{if("object"!=typeof(n=e)||null===n||!("input"in n)||"string"!=typeof n.input)throw new Wt("Agent tool called with invalid input");var n;const r=new So,a=await r.run(this,e.input,{context:t?.context});return"function"==typeof s?s(a):0===(i=a.rawResponses[a.rawResponses.length-1]).output.length?"":Li(i.output[i.output.length-1])||"";var i}})}async getSystemPrompt(e){return"function"==typeof this.instructions?await this.instructions(e,this):this.instructions}async getPrompt(e){return"function"==typeof this.prompt?await this.prompt(e,this):this.prompt}async getMcpTools(){return this.mcpServers.length>0?gr(this.mcpServers):[]}async getAllTools(){return[...await this.getMcpTools(),...this.tools]}processFinalOutput(e){if("text"===this.outputType)return e;if("object"==typeof this.outputType){const t=JSON.parse(e);return Yt(this.outputType)?this.outputType.parse(t):t}throw new Error(`Unknown output type: ${this.outputType}`)}toJSON(){return{name:this.name}}}function Co(e,t){return{type:"message",role:"user",content:"string"==typeof e?[{type:"input_text",text:e}]:e,providerData:t}}function Oo(e,t){return{type:"message",role:"system",content:e,providerData:t}}function Ro(e,t){return{type:"message",role:"assistant",content:"string"==typeof e?[{type:"output_text",text:e}]:e,status:"completed",providerData:t}}function Eo(e,t,n,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(e,n):r?r.value=n:t.set(e,n),n}function No(e,t,n,s){if("a"===n&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?s:"a"===n?s.call(e):s?s.value:t.get(e)}Ia(Jr());let Po=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return Po=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^n()&15>>+e/4).toString(16))};const $o=/^[a-z][a-z0-9+.-]*:/i;let Do=e=>(Do=Array.isArray,Do(e)),jo=Do;function Mo(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const Zo=e=>new Promise(t=>setTimeout(t,e)),Lo="5.10.1",Fo=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lo,"X-Stainless-OS":Uo(Deno.build.os),"X-Stainless-Arch":qo(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lo,"X-Stainless-OS":Uo(globalThis.process.platform??"unknown"),"X-Stainless-Arch":qo(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lo,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}},qo=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Uo=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Bo;function Jo(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function zo(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return Jo({start(){},async pull(e){const{done:n,value:s}=await t.next();n?e.close():e.enqueue(s)},async cancel(){await(t.return?.())}})}function Wo(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const Go=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),Ko="RFC3986",Ho=e=>String(e),Vo={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:Ho};let Xo=(e,t)=>(Xo=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Xo(e,t));const Yo=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Qo=1024;function ec(e,t){if(Do(e)){const n=[];for(let s=0;s<e.length;s+=1)n.push(t(e[s]));return n}return t(e)}const tc={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},nc=function(e,t){Array.prototype.push.apply(e,Do(t)?t:[t])};let sc;const rc={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,s,r)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<a.length;e+=Qo){const t=a.length>=Qo?a.slice(e,e+Qo):a,n=[];for(let e=0;e<t.length;++e){let s=t.charCodeAt(e);45===s||46===s||95===s||126===s||s>=48&&s<=57||s>=65&&s<=90||s>=97&&s<=122||"RFC1738"===r&&(40===s||41===s)?n[n.length]=t.charAt(e):s<128?n[n.length]=Yo[s]:s<2048?n[n.length]=Yo[192|s>>6]+Yo[128|63&s]:s<55296||s>=57344?n[n.length]=Yo[224|s>>12]+Yo[128|s>>6&63]+Yo[128|63&s]:(e+=1,s=65536+((1023&s)<<10|1023&t.charCodeAt(e)),n[n.length]=Yo[240|s>>18]+Yo[128|s>>12&63]+Yo[128|s>>6&63]+Yo[128|63&s])}i+=n.join("")}return i},encodeValuesOnly:!1,format:Ko,formatter:Ho,indices:!1,serializeDate:e=>(sc??(sc=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},ac={};function ic(e,t,n,s,r,a,i,o,c,u,l,d,p,h,m,f,g,_){let y=e,v=_,w=0,b=!1;for(;void 0!==(v=v.get(ac))&&!b;){const t=v.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");b=!0}void 0===v.get(ac)&&(w=0)}if("function"==typeof u?y=u(t,y):y instanceof Date?y=p?.(y):"comma"===n&&Do(y)&&(y=ec(y,function(e){return e instanceof Date?p?.(e):e})),null===y){if(a)return c&&!f?c(t,rc.encoder,g,"key",h):t;y=""}if("string"==typeof(x=y)||"number"==typeof x||"boolean"==typeof x||"symbol"==typeof x||"bigint"==typeof x||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(y)){if(c){const e=f?t:c(t,rc.encoder,g,"key",h);return[m?.(e)+"="+m?.(c(y,rc.encoder,g,"value",h))]}return[m?.(t)+"="+m?.(String(y))]}var x;const S=[];if(void 0===y)return S;let k;if("comma"===n&&Do(y))f&&c&&(y=ec(y,c)),k=[{value:y.length>0?y.join(",")||null:void 0}];else if(Do(u))k=u;else{const e=Object.keys(y);k=l?e.sort(l):e}const I=o?String(t).replace(/\./g,"%2E"):String(t),T=s&&Do(y)&&1===y.length?I+"[]":I;if(r&&Do(y)&&0===y.length)return T+"[]";for(let t=0;t<k.length;++t){const v=k[t],b="object"==typeof v&&void 0!==v.value?v.value:y[v];if(i&&null===b)continue;const x=d&&o?v.replace(/\./g,"%2E"):v,I=Do(y)?"function"==typeof n?n(T,x):T:T+(d?"."+x:"["+x+"]");_.set(e,w);const A=new WeakMap;A.set(ac,_),nc(S,ic(b,I,n,s,r,a,i,o,"comma"===n&&f&&Do(y)?null:c,u,l,d,p,h,m,f,g,A))}return S}let oc,cc;function uc(e){let t;return(oc??(t=new globalThis.TextEncoder,oc=t.encode.bind(t)))(e)}function lc(e){let t;return(cc??(t=new globalThis.TextDecoder,cc=t.decode.bind(t)))(e)}var dc,pc;class hc{constructor(){dc.set(this,void 0),pc.set(this,void 0),Eo(this,dc,new Uint8Array,"f"),Eo(this,pc,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?uc(e):e;Eo(this,dc,function(e){let t=0;for(const n of e)t+=n.length;const n=new Uint8Array(t);let s=0;for(const t of e)n.set(t,s),s+=t.length;return n}([No(this,dc,"f"),t]),"f");const n=[];let s;for(;null!=(s=mc(No(this,dc,"f"),No(this,pc,"f")));){if(s.carriage&&null==No(this,pc,"f")){Eo(this,pc,s.index,"f");continue}if(null!=No(this,pc,"f")&&(s.index!==No(this,pc,"f")+1||s.carriage)){n.push(lc(No(this,dc,"f").subarray(0,No(this,pc,"f")-1))),Eo(this,dc,No(this,dc,"f").subarray(No(this,pc,"f")),"f"),Eo(this,pc,null,"f");continue}const e=null!==No(this,pc,"f")?s.preceding-1:s.preceding,t=lc(No(this,dc,"f").subarray(0,e));n.push(t),Eo(this,dc,No(this,dc,"f").subarray(s.index),"f"),Eo(this,pc,null,"f")}return n}flush(){return No(this,dc,"f").length?this.decode("\n"):[]}}function mc(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function fc(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}dc=new WeakMap,pc=new WeakMap,hc.NEWLINE_CHARS=new Set(["\n","\r"]),hc.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const gc={off:0,error:200,warn:300,info:400,debug:500},_c=(e,t,n)=>{var s,r;if(e)return s=gc,r=e,Object.prototype.hasOwnProperty.call(s,r)?e:void xc(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(gc))}`)};function yc(){}function vc(e,t,n){return!t||gc[e]>gc[n]?yc:t[e].bind(t)}const wc={error:yc,warn:yc,info:yc,debug:yc};let bc=new WeakMap;function xc(e){const t=e.logger,n=e.logLevel??"off";if(!t)return wc;const s=bc.get(t);if(s&&s[0]===n)return s[1];const r={error:vc("error",t,n),warn:vc("warn",t,n),info:vc("info",t,n),debug:vc("debug",t,n)};return bc.set(t,[n,r]),r}const Sc=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var kc,Ic,Tc;class Ac{constructor(e,t,n){this.iterator=e,kc.set(this,void 0),this.controller=t,Eo(this,kc,n,"f")}static fromSSEResponse(e,t,n){let s=!1;const r=n?xc(n):console;return new Ac(async function*(){if(s)throw new u("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const s of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new u("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new u("Attempted to iterate over a response with no body")}const n=new Cc,s=new hc,r=Wo(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?uc(n):n;let s,r=new Uint8Array(t.length+e.length);for(r.set(t),r.set(e,t.length),t=r;-1!==(s=fc(t));)yield t.slice(0,s),t=t.slice(s)}t.length>0&&(yield t)}(r))for(const t of s.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of s.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!n)if(s.data.startsWith("[DONE]"))n=!0;else if(null===s.event||s.event.startsWith("response.")||s.event.startsWith("image_edit.")||s.event.startsWith("image_generation.")||s.event.startsWith("transcript.")){let t;try{t=JSON.parse(s.data)}catch(e){throw r.error("Could not parse message into JSON:",s.data),r.error("From chunk:",s.raw),e}if(t&&t.error)throw new l(void 0,t.error,void 0,e.headers);yield t}else{let e;try{e=JSON.parse(s.data)}catch(e){throw console.error("Could not parse message into JSON:",s.data),console.error("From chunk:",s.raw),e}if("error"==s.event)throw new l(void 0,e.error,e.message,void 0);yield{event:s.event,data:e}}n=!0}catch(e){if(o(e))return;throw e}finally{n||t.abort()}},t,n)}static fromReadableStream(e,t,n){let s=!1;return new Ac(async function*(){if(s)throw new u("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let n=!1;try{for await(const t of async function*(){const t=new hc,n=Wo(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(o(e))return;throw e}finally{n||t.abort()}},t,n)}[(kc=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),s=s=>({next:()=>{if(0===s.length){const s=n.next();e.push(s),t.push(s)}return s.shift()}});return[new Ac(()=>s(e),this.controller,No(this,kc,"f")),new Ac(()=>s(t),this.controller,No(this,kc,"f"))]}toReadableStream(){const e=this;let t;return Jo({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:s}=await t.next();if(s)return e.close();const r=uc(JSON.stringify(n)+"\n");e.enqueue(r)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class Cc{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,s]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return s.startsWith(" ")&&(s=s.substring(1)),"event"===t?this.event=s:"data"===t&&this.data.push(s),null}}async function Oc(e,t){const{response:n,requestLogID:s,retryOfRequestLogID:r,startTime:a}=t,i=await(async()=>{if(t.options.stream)return xc(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):Ac.fromSSEResponse(n,t.controller,e);if(204===n.status)return null;if(t.options.__binaryResponse)return n;const s=n.headers.get("content-type"),r=s?.split(";")[0]?.trim();return r?.includes("application/json")||r?.endsWith("+json")?Rc(await n.json(),n):await n.text()})();return xc(e).debug(`[${s}] response parsed`,Sc({retryOfRequestLogID:r,url:n.url,status:n.status,body:i,durationMs:Date.now()-a})),i}function Rc(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class Ec extends Promise{constructor(e,t,n=Oc){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=n,Ic.set(this,void 0),Eo(this,Ic,e,"f")}_thenUnwrap(e){return new Ec(No(this,Ic,"f"),this.responsePromise,async(t,n)=>Rc(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(No(this,Ic,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Ic=new WeakMap;class Nc{constructor(e,t,n,s){Tc.set(this,void 0),Eo(this,Tc,e,"f"),this.options=s,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new u("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await No(this,Tc,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Tc=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Pc extends Ec{constructor(e,t,n){super(e,t,async(e,t)=>new n(e,t.response,await Oc(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class $c extends Nc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class Dc extends Nc{constructor(e,t,n,s){super(e,t,n,s),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...(n=this.options.query,"object"!=typeof n?{}:n??{}),after:t}}:null;var n}}const jc=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Mc(e,t,n){return jc(),new File(e,t??"unknown_file",n)}function Zc(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const Lc=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Fc=async(e,t)=>({...e,body:await Uc(e.body,t)}),qc=new WeakMap,Uc=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,n=qc.get(t);if(n)return n;const s=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,n=new FormData;return n.toString()!==await new e(n).text()}catch{return!0}})();return qc.set(t,s),s}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>Bc(n,e,t))),n},Bc=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(n instanceof Response)e.append(t,Mc([await n.blob()],Zc(n)));else if(Lc(n))e.append(t,Mc([await new Response(zo(n)).blob()],Zc(n)));else if((e=>e instanceof Blob&&"name"in e)(n))e.append(t,n,Zc(n));else if(Array.isArray(n))await Promise.all(n.map(n=>Bc(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,s])=>Bc(e,`${t}[${n}]`,s)))}}},Jc=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function zc(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Jc(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!Lc(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";return`; props: [${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const n of e)t.push(...await zc(n))}return t}class Wc{constructor(e){this._client=e}}function Gc(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const Kc=Object.freeze(Object.create(null)),Hc=(e=Gc)=>function(t,...n){if(1===t.length)return t[0];let s=!1;const r=[],a=t.reduce((t,a,i)=>{/[?#]/.test(a)&&(s=!0);const o=n[i];let c=(s?encodeURIComponent:e)(""+o);return i!==n.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??Kc)??Kc)?.toString)&&(c=o+"",r.push({start:t.length+a.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+a+(i===n.length?"":c)},""),i=a.split(/[?#]/,1)[0],o=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let c;for(;null!==(c=o.exec(i));)r.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(r.sort((e,t)=>e.start-t.start),r.length>0){let e=0;const t=r.reduce((t,n)=>{const s=" ".repeat(n.start-e),r="^".repeat(n.length);return e=n.start+n.length,t+s+r},"");throw new u(`Path parameters result in path with invalid segments:\n${r.map(e=>e.error).join("\n")}\n${a}\n${t}`)}return a},Vc=Hc(Gc);class Xc extends Wc{list(e,t={},n){return this._client.getAPIList(Vc`/chat/completions/${e}/messages`,Dc,{query:t,...n})}}function Yc(e){return"function"==typeof e.parse}const Qc=e=>"assistant"===e?.role,eu=e=>"tool"===e?.role;var tu,nu,su,ru,au,iu,ou,cu,uu,lu,du,pu,hu,mu,fu,gu,_u,yu,vu,wu,bu;class xu{constructor(){tu.add(this),this.controller=new AbortController,nu.set(this,void 0),su.set(this,()=>{}),ru.set(this,()=>{}),au.set(this,void 0),iu.set(this,()=>{}),ou.set(this,()=>{}),cu.set(this,{}),uu.set(this,!1),lu.set(this,!1),du.set(this,!1),pu.set(this,!1),Eo(this,nu,new Promise((e,t)=>{Eo(this,su,e,"f"),Eo(this,ru,t,"f")}),"f"),Eo(this,au,new Promise((e,t)=>{Eo(this,iu,e,"f"),Eo(this,ou,t,"f")}),"f"),No(this,nu,"f").catch(()=>{}),No(this,au,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},No(this,tu,"m",hu).bind(this))},0)}_connected(){this.ended||(No(this,su,"f").call(this),this._emit("connect"))}get ended(){return No(this,uu,"f")}get errored(){return No(this,lu,"f")}get aborted(){return No(this,du,"f")}abort(){this.controller.abort()}on(e,t){return(No(this,cu,"f")[e]||(No(this,cu,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=No(this,cu,"f")[e];if(!n)return this;const s=n.findIndex(e=>e.listener===t);return s>=0&&n.splice(s,1),this}once(e,t){return(No(this,cu,"f")[e]||(No(this,cu,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Eo(this,pu,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){Eo(this,pu,!0,"f"),await No(this,au,"f")}_emit(e,...t){if(No(this,uu,"f"))return;"end"===e&&(Eo(this,uu,!0,"f"),No(this,iu,"f").call(this));const n=No(this,cu,"f")[e];if(n&&(No(this,cu,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return No(this,pu,"f")||n?.length||Promise.reject(e),No(this,ru,"f").call(this,e),No(this,ou,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];No(this,pu,"f")||n?.length||Promise.reject(e),No(this,ru,"f").call(this,e),No(this,ou,"f").call(this,e),this._emit("end")}}_emitFinal(){}}nu=new WeakMap,su=new WeakMap,ru=new WeakMap,au=new WeakMap,iu=new WeakMap,ou=new WeakMap,cu=new WeakMap,uu=new WeakMap,lu=new WeakMap,du=new WeakMap,pu=new WeakMap,tu=new WeakSet,hu=function(e){if(Eo(this,lu,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new d),e instanceof d)return Eo(this,du,!0,"f"),this._emit("abort",e);if(e instanceof u)return this._emit("error",e);if(e instanceof Error){const t=new u(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new u(String(e)))};const Su=10;class ku extends xu{constructor(){super(...arguments),mu.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),eu(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(Qc(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new u("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),No(this,mu,"m",fu).call(this)}async finalMessage(){return await this.done(),No(this,mu,"m",gu).call(this)}async finalFunctionToolCall(){return await this.done(),No(this,mu,"m",_u).call(this)}async finalFunctionToolCallResult(){return await this.done(),No(this,mu,"m",yu).call(this)}async totalUsage(){return await this.done(),No(this,mu,"m",vu).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=No(this,mu,"m",gu).call(this);t&&this._emit("finalMessage",t);const n=No(this,mu,"m",fu).call(this);n&&this._emit("finalContent",n);const s=No(this,mu,"m",_u).call(this);s&&this._emit("finalFunctionToolCall",s);const r=No(this,mu,"m",yu).call(this);null!=r&&this._emit("finalFunctionToolCallResult",r),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",No(this,mu,"m",vu).call(this))}async _createChatCompletion(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),No(this,mu,"m",wu).call(this,t);const r=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(A(r,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){const s="tool",{tool_choice:r="auto",stream:a,...i}=t,o="string"!=typeof r&&r?.function?.name,{maxChatCompletions:c=Su}=n||{},l=t.tools.map(e=>{if(T(e)){if(!e.$callback)throw new u("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),d={};for(const e of l)"function"===e.type&&(d[e.function.name||e.function.function.name]=e.function);const p="tools"in t?l.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:r,tools:p,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new u("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:r}=e.function,a=d[n];if(!a){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(d).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:s,tool_call_id:t,content:e});continue}let i;try{i=Yc(a)?await a.parse(r):r}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:s,tool_call_id:t,content:n});continue}const c=await a.function(i,this),u=No(this,mu,"m",bu).call(this,c);if(this._addMessage({role:s,tool_call_id:t,content:u}),o)return}}}}mu=new WeakSet,fu=function(){return No(this,mu,"m",gu).call(this).content??null},gu=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Qc(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new u("stream ended without producing a ChatCompletionMessage with role=assistant")},_u=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Qc(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},yu=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(eu(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},vu=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},wu=function(e){if(null!=e.n&&e.n>1)throw new u("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},bu=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class Iu extends ku{static runTools(e,t,n){const s=new Iu,r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}_addMessage(e,t=!0){super._addMessage(e,t),Qc(e)&&e.content&&this._emit("content",e.content)}}class Tu extends Error{}class Au extends Error{}const Cu=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let s=0;const r=e=>{throw new Tu(`${e} at position ${s}`)},a=e=>{throw new Au(`${e} at position ${s}`)},i=()=>(d(),s>=n&&r("Unexpected end of input"),'"'===e[s]?o():"{"===e[s]?c():"["===e[s]?u():"null"===e.substring(s,s+4)||16&t&&n-s<4&&"null".startsWith(e.substring(s))?(s+=4,null):"true"===e.substring(s,s+4)||32&t&&n-s<4&&"true".startsWith(e.substring(s))?(s+=4,!0):"false"===e.substring(s,s+5)||32&t&&n-s<5&&"false".startsWith(e.substring(s))?(s+=5,!1):"Infinity"===e.substring(s,s+8)||128&t&&n-s<8&&"Infinity".startsWith(e.substring(s))?(s+=8,1/0):"-Infinity"===e.substring(s,s+9)||256&t&&1<n-s&&n-s<9&&"-Infinity".startsWith(e.substring(s))?(s+=9,-1/0):"NaN"===e.substring(s,s+3)||64&t&&n-s<3&&"NaN".startsWith(e.substring(s))?(s+=3,NaN):l()),o=()=>{const i=s;let o=!1;for(s++;s<n&&('"'!==e[s]||o&&"\\"===e[s-1]);)o="\\"===e[s]&&!o,s++;if('"'==e.charAt(s))try{return JSON.parse(e.substring(i,++s-Number(o)))}catch(e){a(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,s-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},c=()=>{s++,d();const a={};try{for(;"}"!==e[s];){if(d(),s>=n&&8&t)return a;const r=o();d(),s++;try{const e=i();Object.defineProperty(a,r,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return a;throw e}d(),","===e[s]&&s++}}catch(e){if(8&t)return a;r("Expected '}' at end of object")}return s++,a},u=()=>{s++;const n=[];try{for(;"]"!==e[s];)n.push(i()),d(),","===e[s]&&s++}catch(e){if(4&t)return n;r("Expected ']' at end of array")}return s++,n},l=()=>{if(0===s){"-"===e&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}a(String(n))}}const i=s;for("-"===e[s]&&s++;e[s]&&!",]}".includes(e[s]);)s++;s!=n||2&t||r("Unterminated number literal");try{return JSON.parse(e.substring(i,s))}catch(n){"-"===e.substring(i,s)&&2&t&&r("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){a(String(e))}}},d=()=>{for(;s<n&&" \n\r\t".includes(e[s]);)s++};return i()})(e.trim(),t)}(e,509);var Ou,Ru,Eu,Nu,Pu,$u,Du,ju,Mu,Zu,Lu,Fu;class qu extends ku{constructor(e){super(),Ou.add(this),Ru.set(this,void 0),Eu.set(this,void 0),Nu.set(this,void 0),Eo(this,Ru,e,"f"),Eo(this,Eu,[],"f")}get currentChatCompletionSnapshot(){return No(this,Nu,"f")}static fromReadableStream(e){const t=new qu(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const s=new qu(t);return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,n){super._createChatCompletion;const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),No(this,Ou,"m",Pu).call(this);const r=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of r)No(this,Ou,"m",Du).call(this,e);if(r.controller.signal?.aborted)throw new d;return this._addChatCompletion(No(this,Ou,"m",Zu).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),No(this,Ou,"m",Pu).call(this),this._connected();const s=Ac.fromReadableStream(e,this.controller);let r;for await(const e of s)r&&r!==e.id&&this._addChatCompletion(No(this,Ou,"m",Zu).call(this)),No(this,Ou,"m",Du).call(this,e),r=e.id;if(s.controller.signal?.aborted)throw new d;return this._addChatCompletion(No(this,Ou,"m",Zu).call(this))}[(Ru=new WeakMap,Eu=new WeakMap,Nu=new WeakMap,Ou=new WeakSet,Pu=function(){this.ended||Eo(this,Nu,void 0,"f")},$u=function(e){let t=No(this,Eu,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},No(this,Eu,"f")[e.index]=t,t)},Du=function(e){if(this.ended)return;const t=No(this,Ou,"m",Fu).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const s=No(this,Ou,"m",$u).call(this,e);e.finish_reason&&(No(this,Ou,"m",Mu).call(this,e),null!=s.current_tool_call_index&&No(this,Ou,"m",ju).call(this,e,s.current_tool_call_index));for(const t of n.delta.tool_calls??[])s.current_tool_call_index!==t.index&&(No(this,Ou,"m",Mu).call(this,e),null!=s.current_tool_call_index&&No(this,Ou,"m",ju).call(this,e,s.current_tool_call_index)),s.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type?this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):Ju())}}},ju=function(e,t){if(No(this,Ou,"m",$u).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=No(this,Ru,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:T(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Mu=function(e){const t=No(this,Ou,"m",$u).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=No(this,Ou,"m",Lu).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Zu=function(){if(this.ended)throw new u("stream has ended, this shouldn't happen");const e=No(this,Nu,"f");if(!e)throw new u("request ended without sending any chunks");return Eo(this,Nu,void 0,"f"),Eo(this,Eu,[],"f"),function(e,t){const{id:n,choices:s,created:r,model:a,system_fingerprint:i,...o}=e,c={...o,id:n,choices:s.map(({message:t,finish_reason:n,index:s,logprobs:r,...a})=>{if(!n)throw new u(`missing finish_reason for choice ${s}`);const{content:i=null,function_call:o,tool_calls:c,...l}=t,d=t.role;if(!d)throw new u(`missing role for choice ${s}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new u(`missing function_call.arguments for choice ${s}`);if(!c)throw new u(`missing function_call.name for choice ${s}`);return{...a,message:{content:i,function_call:{arguments:e,name:c},role:d,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}return c?{...a,index:s,finish_reason:n,logprobs:r,message:{...l,role:d,content:i,refusal:t.refusal??null,tool_calls:c.map((t,n)=>{const{function:r,type:a,id:i,...o}=t,{arguments:c,name:l,...d}=r||{};if(null==i)throw new u(`missing choices[${s}].tool_calls[${n}].id\n${Uu(e)}`);if(null==a)throw new u(`missing choices[${s}].tool_calls[${n}].type\n${Uu(e)}`);if(null==l)throw new u(`missing choices[${s}].tool_calls[${n}].function.name\n${Uu(e)}`);if(null==c)throw new u(`missing choices[${s}].tool_calls[${n}].function.arguments\n${Uu(e)}`);return{...o,id:i,type:a,function:{...d,name:l,arguments:c}}})}}:{...a,message:{...l,content:i,role:d,refusal:t.refusal??null},finish_reason:n,index:s,logprobs:r}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&R(t)?A(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(c,t)}(e,No(this,Ru,"f"))},Lu=function(){const e=No(this,Ru,"f")?.response_format;return I(e)?e:null},Fu=function(e){var t,n,s,r;let a=No(this,Nu,"f");const{choices:i,...o}=e;a?Object.assign(a,o):a=Eo(this,Nu,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:c,logprobs:u=null,...l}of e.choices){let e=a.choices[c];if(e||(e=a.choices[c]={finish_reason:o,index:c,message:{},logprobs:u,...l}),u)if(e.logprobs){const{content:s,refusal:r,...a}=u;Bu(),Object.assign(e.logprobs,a),s&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...s)),r&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...r))}else e.logprobs=Object.assign({},u);if(o&&(e.finish_reason=o,No(this,Ru,"f")&&R(No(this,Ru,"f")))){if("length"===o)throw new x;if("content_filter"===o)throw new S}if(Object.assign(e,l),!i)continue;const{content:d,refusal:p,function_call:h,role:m,tool_calls:f,...g}=i;if(Bu(),Object.assign(e.message,g),p&&(e.message.refusal=(e.message.refusal||"")+p),m&&(e.message.role=m),h&&(e.message.function_call?(h.name&&(e.message.function_call.name=h.name),h.arguments&&((s=e.message.function_call).arguments??(s.arguments=""),e.message.function_call.arguments+=h.arguments)):e.message.function_call=h),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&No(this,Ou,"m",Lu).call(this)&&(e.message.parsed=Cu(e.message.content))),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:s,function:a,...i}of f){const o=(r=e.message.tool_calls)[t]??(r[t]={});Object.assign(o,i),n&&(o.id=n),s&&(o.type=s),a&&(o.function??(o.function={name:a.name??"",arguments:""})),a?.name&&(o.function.name=a.name),a?.arguments&&(o.function.arguments+=a.arguments,O(No(this,Ru,"f"),o)&&(o.function.parsed_arguments=Cu(o.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ac(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Uu(e){return JSON.stringify(e)}function Bu(e){}function Ju(e){}class zu extends qu{static fromReadableStream(e){const t=new zu(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const s=new zu(t),r={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,r)),s}}class Wu extends Wc{constructor(){super(...arguments),this.messages=new Xc(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(Vc`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(Vc`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/chat/completions",Dc,{query:e,...t})}delete(e,t){return this._client.delete(Vc`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new u(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new u(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>A(t,e))}runTools(e,t){return e.stream?zu.runTools(this._client,e,t):Iu.runTools(this._client,e,t)}stream(e,t){return qu.createChatCompletion(this._client,e,t)}}Wu.Messages=Xc;class Gu extends Wc{constructor(){super(...arguments),this.completions=new Wu(this._client)}}Gu.Completions=Wu;const Ku=Symbol("brand.privateNullableHeaders");function*Hu(e){if(!e)return;if(Ku in e){const{values:t,nulls:n}=e;yield*t.entries();for(const e of n)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():jo(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const s=jo(e[1])?e[1]:[e[1]];let r=!1;for(const e of s)void 0!==e&&(n&&!r&&(r=!0,yield[t,null]),yield[t,e])}}const Vu=e=>{const t=new Headers,n=new Set;for(const s of e){const e=new Set;for(const[r,a]of Hu(s)){const s=r.toLowerCase();e.has(s)||(t.delete(r),e.add(s)),null===a?(t.delete(r),n.add(s)):(t.append(r,a),n.delete(s))}}return{[Ku]:!0,values:t,nulls:n}};class Xu extends Wc{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:Vu([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class Yu extends Wc{create(e,t){return this._client.post("/audio/transcriptions",Fc({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Qu extends Wc{create(e,t){return this._client.post("/audio/translations",Fc({body:e,...t,__metadata:{model:e.model}},this._client))}}class el extends Wc{constructor(){super(...arguments),this.transcriptions=new Yu(this._client),this.translations=new Qu(this._client),this.speech=new Xu(this._client)}}el.Transcriptions=Yu,el.Translations=Qu,el.Speech=Xu;class tl extends Wc{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(Vc`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",Dc,{query:e,...t})}cancel(e,t){return this._client.post(Vc`/batches/${e}/cancel`,t)}}class nl extends Wc{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Vc`/assistants/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Vc`/assistants/${e}`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",Dc,{query:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Vc`/assistants/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class sl extends Wc{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class rl extends Wc{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class al extends Wc{constructor(){super(...arguments),this.sessions=new sl(this._client),this.transcriptionSessions=new rl(this._client)}}al.Sessions=sl,al.TranscriptionSessions=rl;class il extends Wc{create(e,t,n){return this._client.post(Vc`/threads/${e}/messages`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{thread_id:s}=t;return this._client.get(Vc`/threads/${s}/messages/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Vc`/threads/${s}/messages/${e}`,{body:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Vc`/threads/${e}/messages`,Dc,{query:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{thread_id:s}=t;return this._client.delete(Vc`/threads/${s}/messages/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class ol extends Wc{retrieve(e,t,n){const{thread_id:s,run_id:r,...a}=t;return this._client.get(Vc`/threads/${s}/runs/${r}/steps/${e}`,{query:a,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t,n){const{thread_id:s,...r}=t;return this._client.getAPIList(Vc`/threads/${s}/runs/${e}/steps`,Dc,{query:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}const cl=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var ul,ll,dl,pl,hl,ml,fl,gl,_l,yl,vl,wl,bl,xl,Sl,kl,Il,Tl,Al,Cl,Ol,Rl,El,Nl,Pl,$l,Dl,jl,Ml,Zl,Ll,Fl,ql,Ul,Bl,Jl,zl,Wl;class Gl extends xu{constructor(){super(...arguments),ul.add(this),dl.set(this,[]),pl.set(this,{}),hl.set(this,{}),ml.set(this,void 0),fl.set(this,void 0),gl.set(this,void 0),_l.set(this,void 0),yl.set(this,void 0),vl.set(this,void 0),wl.set(this,void 0),bl.set(this,void 0),xl.set(this,void 0)}[(dl=new WeakMap,pl=new WeakMap,hl=new WeakMap,ml=new WeakMap,fl=new WeakMap,gl=new WeakMap,_l=new WeakMap,yl=new WeakMap,vl=new WeakMap,wl=new WeakMap,bl=new WeakMap,xl=new WeakMap,ul=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new ll;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const s=Ac.fromReadableStream(e,this.controller);for await(const e of s)No(this,ul,"m",Sl).call(this,e);if(s.controller.signal?.aborted)throw new d;return this._addRun(No(this,ul,"m",kl).call(this))}toReadableStream(){return new Ac(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,s){const r=new ll;return r._run(()=>r._runToolAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createToolAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.submitToolOutputs(t,a,{...s,signal:this.controller.signal});this._connected();for await(const e of i)No(this,ul,"m",Sl).call(this,e);if(i.controller.signal?.aborted)throw new d;return this._addRun(No(this,ul,"m",kl).call(this))}static createThreadAssistantStream(e,t,n){const s=new ll;return s._run(()=>s._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,n,s){const r=new ll;return r._run(()=>r._runAssistantStream(e,t,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}currentEvent(){return No(this,wl,"f")}currentRun(){return No(this,bl,"f")}currentMessageSnapshot(){return No(this,ml,"f")}currentRunStepSnapshot(){return No(this,xl,"f")}async finalRunSteps(){return await this.done(),Object.values(No(this,pl,"f"))}async finalMessages(){return await this.done(),Object.values(No(this,hl,"f"))}async finalRun(){if(await this.done(),!No(this,fl,"f"))throw Error("Final run was not received.");return No(this,fl,"f")}async _createThreadAssistantStream(e,t,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const r={...t,stream:!0},a=await e.createAndRun(r,{...n,signal:this.controller.signal});this._connected();for await(const e of a)No(this,ul,"m",Sl).call(this,e);if(a.controller.signal?.aborted)throw new d;return this._addRun(No(this,ul,"m",kl).call(this))}async _createAssistantStream(e,t,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.create(t,a,{...s,signal:this.controller.signal});this._connected();for await(const e of i)No(this,ul,"m",Sl).call(this,e);if(i.controller.signal?.aborted)throw new d;return this._addRun(No(this,ul,"m",kl).call(this))}static accumulateDelta(e,t){for(const[n,s]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=s;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof s)t+=s;else if("number"==typeof t&&"number"==typeof s)t+=s;else{if(!Mo(t)||!Mo(s)){if(Array.isArray(t)&&Array.isArray(s)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...s);continue}for(const e of s){if(!Mo(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const s=t[n];null==s?t.push(e):t[n]=this.accumulateDelta(s,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${s}, accValue: ${t}`)}t=this.accumulateDelta(t,s)}e[n]=t}else e[n]=s;else e[n]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,s){return await this._createAssistantStream(t,e,n,s)}async _runToolAssistantStream(e,t,n,s){return await this._createToolAssistantStream(t,e,n,s)}}ll=Gl,Sl=function(e){if(!this.ended)switch(Eo(this,wl,e,"f"),No(this,ul,"m",Al).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":No(this,ul,"m",El).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":No(this,ul,"m",Tl).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":No(this,ul,"m",Il).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},kl=function(){if(this.ended)throw new u("stream has ended, this shouldn't happen");if(!No(this,fl,"f"))throw Error("Final run has not been received");return No(this,fl,"f")},Il=function(e){const[t,n]=No(this,ul,"m",Ol).call(this,e,No(this,ml,"f"));Eo(this,ml,t,"f"),No(this,hl,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,s=t.content[n.index];if(!s||"text"!=s.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,s.text)}if(n.index!=No(this,gl,"f")){if(No(this,_l,"f"))switch(No(this,_l,"f").type){case"text":this._emit("textDone",No(this,_l,"f").text,No(this,ml,"f"));break;case"image_file":this._emit("imageFileDone",No(this,_l,"f").image_file,No(this,ml,"f"))}Eo(this,gl,n.index,"f")}Eo(this,_l,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==No(this,gl,"f")){const t=e.data.content[No(this,gl,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,No(this,ml,"f"));break;case"text":this._emit("textDone",t.text,No(this,ml,"f"))}}No(this,ml,"f")&&this._emit("messageDone",e.data),Eo(this,ml,void 0,"f")}},Tl=function(e){const t=No(this,ul,"m",Cl).call(this,e);switch(Eo(this,xl,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==No(this,yl,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(No(this,vl,"f")&&this._emit("toolCallDone",No(this,vl,"f")),Eo(this,yl,e.index,"f"),Eo(this,vl,t.step_details.tool_calls[e.index],"f"),No(this,vl,"f")&&this._emit("toolCallCreated",No(this,vl,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Eo(this,xl,void 0,"f"),"tool_calls"==e.data.step_details.type&&No(this,vl,"f")&&(this._emit("toolCallDone",No(this,vl,"f")),Eo(this,vl,void 0,"f")),this._emit("runStepDone",e.data,t)}},Al=function(e){No(this,dl,"f").push(e),this._emit("event",e)},Cl=function(e){switch(e.event){case"thread.run.step.created":return No(this,pl,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=No(this,pl,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const s=ll.accumulateDelta(t,n.delta);No(this,pl,"f")[e.data.id]=s}return No(this,pl,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":No(this,pl,"f")[e.data.id]=e.data}if(No(this,pl,"f")[e.data.id])return No(this,pl,"f")[e.data.id];throw new Error("No snapshot available")},Ol=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(const e of s.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=No(this,ul,"m",Rl).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Rl=function(e,t){return ll.accumulateDelta(t,e)},El=function(e){switch(Eo(this,bl,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":Eo(this,fl,e.data,"f"),No(this,vl,"f")&&(this._emit("toolCallDone",No(this,vl,"f")),Eo(this,vl,void 0,"f"))}};class Kl extends Wc{constructor(){super(...arguments),this.steps=new ol(this._client)}create(e,t,n){const{include:s,...r}=t;return this._client.post(Vc`/threads/${e}/runs`,{query:{include:s},body:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}retrieve(e,t,n){const{thread_id:s}=t;return this._client.get(Vc`/threads/${s}/runs/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Vc`/threads/${s}/runs/${e}`,{body:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Vc`/threads/${e}/runs`,Dc,{query:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{thread_id:s}=t;return this._client.post(Vc`/threads/${s}/runs/${e}/cancel`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(s.id,{thread_id:e},n)}createAndStream(e,t,n){return Gl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const s=Vu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...s}}).withResponse();switch(r.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Zo(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return r}}}stream(e,t,n){return Gl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n){const{thread_id:s,...r}=t;return this._client.post(Vc`/threads/${s}/runs/${e}/submit_tool_outputs`,{body:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,n){const s=await this.submitToolOutputs(e,t,n);return await this.poll(s.id,t,n)}submitToolOutputsStream(e,t,n){return Gl.createToolAssistantStream(e,this._client.beta.threads.runs,t,n)}}Kl.Steps=ol;class Hl extends Wc{constructor(){super(...arguments),this.runs=new Kl(this._client),this.messages=new il(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Vc`/threads/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Vc`/threads/${e}`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t){return this._client.delete(Vc`/threads/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return Gl.createThreadAssistantStream(e,this._client.beta.threads,t)}}Hl.Runs=Kl,Hl.Messages=il;class Vl extends Wc{constructor(){super(...arguments),this.realtime=new al(this._client),this.assistants=new nl(this._client),this.threads=new Hl(this._client)}}Vl.Realtime=al,Vl.Assistants=nl,Vl.Threads=Hl;class Xl extends Wc{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Yl extends Wc{retrieve(e,t,n){const{container_id:s}=t;return this._client.get(Vc`/containers/${s}/files/${e}/content`,{...n,headers:Vu([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}}class Ql extends Wc{constructor(){super(...arguments),this.content=new Yl(this._client)}create(e,t,n){return this._client.post(Vc`/containers/${e}/files`,Fc({body:t,...n},this._client))}retrieve(e,t,n){const{container_id:s}=t;return this._client.get(Vc`/containers/${s}/files/${e}`,n)}list(e,t={},n){return this._client.getAPIList(Vc`/containers/${e}/files`,Dc,{query:t,...n})}delete(e,t,n){const{container_id:s}=t;return this._client.delete(Vc`/containers/${s}/files/${e}`,{...n,headers:Vu([{Accept:"*/*"},n?.headers])})}}Ql.Content=Yl;class ed extends Wc{constructor(){super(...arguments),this.files=new Ql(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(Vc`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",Dc,{query:e,...t})}delete(e,t){return this._client.delete(Vc`/containers/${e}`,{...t,headers:Vu([{Accept:"*/*"},t?.headers])})}}ed.Files=Ql;class td extends Wc{create(e,t){const n=!!e.encoding_format;let s=n?e.encoding_format:"base64";n&&xc(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const r=this._client.post("/embeddings",{body:{...e,encoding_format:s},...t});return n?r:(xc(this._client).debug("embeddings/decoding base64 embeddings from base64"),r._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return Array.from(new Float32Array(s.buffer))}})(t)}),e)))}}class nd extends Wc{retrieve(e,t,n){const{eval_id:s,run_id:r}=t;return this._client.get(Vc`/evals/${s}/runs/${r}/output_items/${e}`,n)}list(e,t,n){const{eval_id:s,...r}=t;return this._client.getAPIList(Vc`/evals/${s}/runs/${e}/output_items`,Dc,{query:r,...n})}}class sd extends Wc{constructor(){super(...arguments),this.outputItems=new nd(this._client)}create(e,t,n){return this._client.post(Vc`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:s}=t;return this._client.get(Vc`/evals/${s}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(Vc`/evals/${e}/runs`,Dc,{query:t,...n})}delete(e,t,n){const{eval_id:s}=t;return this._client.delete(Vc`/evals/${s}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:s}=t;return this._client.post(Vc`/evals/${s}/runs/${e}`,n)}}sd.OutputItems=nd;class rd extends Wc{constructor(){super(...arguments),this.runs=new sd(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(Vc`/evals/${e}`,t)}update(e,t,n){return this._client.post(Vc`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",Dc,{query:e,...t})}delete(e,t){return this._client.delete(Vc`/evals/${e}`,t)}}rd.Runs=sd;class ad extends Wc{create(e,t){return this._client.post("/files",Fc({body:e,...t},this._client))}retrieve(e,t){return this._client.get(Vc`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",Dc,{query:e,...t})}delete(e,t){return this._client.delete(Vc`/files/${e}`,t)}content(e,t){return this._client.get(Vc`/files/${e}/content`,{...t,headers:Vu([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const s=new Set(["processed","error","deleted"]),r=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Zo(t),a=await this.retrieve(e),Date.now()-r>n)throw new h({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}}class id extends Wc{}class od extends Wc{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class cd extends Wc{constructor(){super(...arguments),this.graders=new od(this._client)}}cd.Graders=od;class ud extends Wc{create(e,t,n){return this._client.getAPIList(Vc`/fine_tuning/checkpoints/${e}/permissions`,$c,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(Vc`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:s}=t;return this._client.delete(Vc`/fine_tuning/checkpoints/${s}/permissions/${e}`,n)}}class ld extends Wc{constructor(){super(...arguments),this.permissions=new ud(this._client)}}ld.Permissions=ud;class dd extends Wc{list(e,t={},n){return this._client.getAPIList(Vc`/fine_tuning/jobs/${e}/checkpoints`,Dc,{query:t,...n})}}class pd extends Wc{constructor(){super(...arguments),this.checkpoints=new dd(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(Vc`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",Dc,{query:e,...t})}cancel(e,t){return this._client.post(Vc`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(Vc`/fine_tuning/jobs/${e}/events`,Dc,{query:t,...n})}pause(e,t){return this._client.post(Vc`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(Vc`/fine_tuning/jobs/${e}/resume`,t)}}pd.Checkpoints=dd;class hd extends Wc{constructor(){super(...arguments),this.methods=new id(this._client),this.jobs=new pd(this._client),this.checkpoints=new ld(this._client),this.alpha=new cd(this._client)}}hd.Methods=id,hd.Jobs=pd,hd.Checkpoints=ld,hd.Alpha=cd;class md extends Wc{}class fd extends Wc{constructor(){super(...arguments),this.graderModels=new md(this._client)}}fd.GraderModels=md;class gd extends Wc{createVariation(e,t){return this._client.post("/images/variations",Fc({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",Fc({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class _d extends Wc{retrieve(e,t){return this._client.get(Vc`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",$c,e)}delete(e,t){return this._client.delete(Vc`/models/${e}`,t)}}class yd extends Wc{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class vd extends xu{constructor(e){super(),Nl.add(this),Pl.set(this,void 0),$l.set(this,void 0),Dl.set(this,void 0),Eo(this,Pl,e,"f")}static createResponse(e,t,n){const s=new vd(t);return s._run(()=>s._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createOrRetrieveResponse(e,t,n){const s=n?.signal;let r;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),No(this,Nl,"m",jl).call(this);let a=null;"response_id"in t?(r=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):r=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const e of r)No(this,Nl,"m",Ml).call(this,e,a);if(r.controller.signal?.aborted)throw new d;return No(this,Nl,"m",Zl).call(this)}[(Pl=new WeakMap,$l=new WeakMap,Dl=new WeakMap,Nl=new WeakSet,jl=function(){this.ended||Eo(this,$l,void 0,"f")},Ml=function(e,t){if(this.ended)return;const n=(e,n)=>{(null==t||n.sequence_number>t)&&this._emit(e,n)},s=No(this,Nl,"m",Ll).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const t=s.output[e.output_index];if(!t)throw new u(`missing output at index ${e.output_index}`);if("message"===t.type){const s=t.content[e.content_index];if(!s)throw new u(`missing content at index ${e.content_index}`);if("output_text"!==s.type)throw new u(`expected content to be 'output_text', got ${s.type}`);n("response.output_text.delta",{...e,snapshot:s.text})}break}case"response.function_call_arguments.delta":{const t=s.output[e.output_index];if(!t)throw new u(`missing output at index ${e.output_index}`);"function_call"===t.type&&n("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:n(e.type,e)}},Zl=function(){if(this.ended)throw new u("stream has ended, this shouldn't happen");const e=No(this,$l,"f");if(!e)throw new u("request ended without sending any events");Eo(this,$l,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!I(e.text?.format)}(t)?jt(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,t)}(e,No(this,Pl,"f"));return Eo(this,Dl,t,"f"),t},Ll=function(e){let t=No(this,$l,"f");if(!t){if("response.created"!==e.type)throw new u(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=Eo(this,$l,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new u(`missing output at index ${e.output_index}`);"message"===n.type&&n.content.push(e.part);break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new u(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new u(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new u(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new u(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.completed":Eo(this,$l,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const s=t.shift();s?s.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=No(this,Dl,"f");if(!e)throw new u("stream ended without producing a ChatCompletion");return e}}class wd extends Wc{list(e,t={},n){return this._client.getAPIList(Vc`/responses/${e}/input_items`,Dc,{query:t,...n})}}class bd extends Wc{constructor(){super(...arguments),this.inputItems=new wd(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Ft(e),e))}retrieve(e,t={},n){return this._client.get(Vc`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Ft(e),e))}delete(e,t){return this._client.delete(Vc`/responses/${e}`,{...t,headers:Vu([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>jt(t,e))}stream(e,t){return vd.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(Vc`/responses/${e}/cancel`,t)}}bd.InputItems=wd;class xd extends Wc{create(e,t,n){return this._client.post(Vc`/uploads/${e}/parts`,Fc({body:t,...n},this._client))}}class Sd extends Wc{constructor(){super(...arguments),this.parts=new xd(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(Vc`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(Vc`/uploads/${e}/complete`,{body:t,...n})}}Sd.Parts=xd;class kd extends Wc{create(e,t,n){return this._client.post(Vc`/vector_stores/${e}/file_batches`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:s}=t;return this._client.get(Vc`/vector_stores/${s}/file_batches/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{vector_store_id:s}=t;return this._client.post(Vc`/vector_stores/${s}/file_batches/${e}/cancel`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t);return await this.poll(e,s.id,n)}listFiles(e,t,n){const{vector_store_id:s,...r}=t;return this._client.getAPIList(Vc`/vector_stores/${s}/file_batches/${e}/files`,Dc,{query:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async poll(e,t,n){const s=Vu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:r,response:a}=await this.retrieve(t,{vector_store_id:e},{...n,headers:s}).withResponse();switch(r.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Zo(e);break;case"failed":case"cancelled":case"completed":return r}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},s){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const r=s?.maxConcurrency??5,a=Math.min(r,t.length),i=this._client,o=t.values(),c=[...n],u=Array(a).fill(o).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},s);c.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),n=t.filter(e=>"rejected"===e.status);if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const e of t)"fulfilled"===e.status&&s.push(e.value);return s})(u),await this.createAndPoll(e,{file_ids:c})}}class Id extends Wc{create(e,t,n){return this._client.post(Vc`/vector_stores/${e}/files`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:s}=t;return this._client.get(Vc`/vector_stores/${s}/files/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{vector_store_id:s,...r}=t;return this._client.post(Vc`/vector_stores/${s}/files/${e}`,{body:r,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(Vc`/vector_stores/${e}/files`,Dc,{query:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{vector_store_id:s}=t;return this._client.delete(Vc`/vector_stores/${s}/files/${e}`,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const s=await this.create(e,t,n);return await this.poll(e,s.id,n)}async poll(e,t,n){const s=Vu([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const r=await this.retrieve(t,{vector_store_id:e},{...n,headers:s}).withResponse(),a=r.data;switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=r.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Zo(e);break;case"failed":case"completed":return a}}}async upload(e,t,n){const s=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:s.id},n)}async uploadAndPoll(e,t,n){const s=await this.upload(e,t,n);return await this.poll(e,s.id,n)}content(e,t,n){const{vector_store_id:s}=t;return this._client.getAPIList(Vc`/vector_stores/${s}/files/${e}/content`,$c,{...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class Td extends Wc{constructor(){super(...arguments),this.files=new Id(this._client),this.fileBatches=new kd(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(Vc`/vector_stores/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(Vc`/vector_stores/${e}`,{body:t,...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",Dc,{query:e,...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(Vc`/vector_stores/${e}`,{...t,headers:Vu([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,n){return this._client.getAPIList(Vc`/vector_stores/${e}/search`,$c,{body:t,method:"post",...n,headers:Vu([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}Td.Files=Id,Td.FileBatches=kd;class Ad extends Wc{constructor(){super(...arguments),Fl.add(this)}async unwrap(e,t,n=this._client.webhookSecret,s=300){return await this.verifySignature(e,t,n,s),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,s=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");No(this,Fl,"m",ql).call(this,n);const r=Vu([t]).values,a=No(this,Fl,"m",Ul).call(this,r,"webhook-signature"),i=No(this,Fl,"m",Ul).call(this,r,"webhook-timestamp"),o=No(this,Fl,"m",Ul).call(this,r,"webhook-id"),c=parseInt(i,10);if(isNaN(c))throw new k("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-c>s)throw new k("Webhook timestamp is too old");if(c>u+s)throw new k("Webhook timestamp is too new");const l=a.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),d=n.startsWith("whsec_")?Buffer.from(n.replace("whsec_",""),"base64"):Buffer.from(n,"utf-8"),p=o?`${o}.${i}.${e}`:`${i}.${e}`,h=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const e of l)try{const t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",h,t,(new TextEncoder).encode(p)))return}catch{continue}throw new k("The given webhook signature does not match the expected signature")}}Fl=new WeakSet,ql=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Ul=function(e,t){if(!e)throw new Error("Headers are required");const n=e.get(t);if(null==n)throw new Error(`Missing required header: ${t}`);return n};class Cd{constructor({baseURL:e=cl("OPENAI_BASE_URL"),apiKey:t=cl("OPENAI_API_KEY"),organization:n=cl("OPENAI_ORG_ID")??null,project:s=cl("OPENAI_PROJECT_ID")??null,webhookSecret:r=cl("OPENAI_WEBHOOK_SECRET")??null,...a}={}){if(Bl.add(this),zl.set(this,void 0),this.completions=new Xl(this),this.chat=new Gu(this),this.embeddings=new td(this),this.files=new ad(this),this.images=new gd(this),this.audio=new el(this),this.moderations=new yd(this),this.models=new _d(this),this.fineTuning=new hd(this),this.graders=new fd(this),this.vectorStores=new Td(this),this.webhooks=new Ad(this),this.beta=new Vl(this),this.batches=new tl(this),this.uploads=new Sd(this),this.responses=new bd(this),this.evals=new rd(this),this.containers=new ed(this),void 0===t)throw new u("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:n,project:s,webhookSecret:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new u("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=i.baseURL,this.timeout=i.timeout??Jl.DEFAULT_TIMEOUT,this.logger=i.logger??console;const o="warn";this.logLevel=o,this.logLevel=_c(i.logLevel,"ClientOptions.logLevel",this)??_c(cl("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),Eo(this,zl,Go,"f"),this._options=i,this.apiKey=t,this.organization=n,this.project=s,this.webhookSecret=r}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return Vu([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let n=e;const s=function(e=rc){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||rc.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Ko;if(void 0!==e.format){if(!Xo(Vo,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const s=Vo[n];let r,a=rc.filter;if(("function"==typeof e.filter||Do(e.filter))&&(a=e.filter),r=e.arrayFormat&&e.arrayFormat in tc?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":rc.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||rc.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:rc.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:rc.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:rc.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?rc.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:rc.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:rc.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:rc.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:rc.encodeValuesOnly,filter:a,format:n,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:rc.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:rc.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:rc.strictNullHandling}}(t);let r,a;"function"==typeof s.filter?(a=s.filter,n=a("",n)):Do(s.filter)&&(a=s.filter,r=a);const i=[];if("object"!=typeof n||null===n)return"";const o=tc[s.arrayFormat],c="comma"===o&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const u=new WeakMap;for(let e=0;e<r.length;++e){const t=r[e];s.skipNulls&&null===n[t]||nc(i,ic(n[t],t,o,c,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,u))}const l=i.join(s.delimiter);let d=!0===s.addQueryPrefix?"?":"";return s.charsetSentinel&&("iso-8859-1"===s.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Lo}`}defaultIdempotencyKey(){return`stainless-node-retry-${Po()}`}makeStatusError(e,t,n,s){return l.generate(e,t,n,s)}buildURL(e,t,n){const s=!No(this,Bl,"m",Wl).call(this)&&n||this.baseURL,r=(e=>$o.test(e))(e)?new URL(e):new URL(s+(s.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(a)||(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new Ec(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){const s=await e,r=s.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(s);const{req:a,url:i,timeout:u}=await this.buildRequest(s,{retryCount:r-t});await this.prepareRequest(a,{url:i,options:s});const l="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=void 0===n?"":`, retryOf: ${n}`,f=Date.now();if(xc(this).debug(`[${l}] sending request`,Sc({retryOfRequestLogID:n,method:s.method,url:i,options:s,headers:a.headers})),s.signal?.aborted)throw new d;const g=new AbortController,_=await this.fetchWithTimeout(i,a,u,g).catch(c),y=Date.now();if(_ instanceof Error){const e=`retrying, ${t} attempts remaining`;if(s.signal?.aborted)throw new d;const r=o(_)||/timed? ?out/i.test(String(_)+("cause"in _?String(_.cause):""));if(t)return xc(this).info(`[${l}] connection ${r?"timed out":"failed"} - ${e}`),xc(this).debug(`[${l}] connection ${r?"timed out":"failed"} (${e})`,Sc({retryOfRequestLogID:n,url:i,durationMs:y-f,message:_.message})),this.retryRequest(s,t,n??l);if(xc(this).info(`[${l}] connection ${r?"timed out":"failed"} - error; no more retries left`),xc(this).debug(`[${l}] connection ${r?"timed out":"failed"} (error; no more retries left)`,Sc({retryOfRequestLogID:n,url:i,durationMs:y-f,message:_.message})),r)throw new h;throw new p({cause:_})}const v=`[${l}${m}${[..._.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${a.method} ${i} ${_.ok?"succeeded":"failed"} with status ${_.status} in ${y-f}ms`;if(!_.ok){const e=await this.shouldRetry(_);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}(_.body),xc(this).info(`${v} - ${e}`),xc(this).debug(`[${l}] response error (${e})`,Sc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,durationMs:y-f})),this.retryRequest(s,t,n??l,_.headers)}const r=e?"error; no more retries left":"error; not retryable";xc(this).info(`${v} - ${r}`);const a=await _.text().catch(e=>c(e).message),i=(e=>{try{return JSON.parse(e)}catch(e){return}})(a),o=i?void 0:a;throw xc(this).debug(`[${l}] response error (${r})`,Sc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,message:o,durationMs:Date.now()-f})),this.makeStatusError(_.status,i,o,_.headers)}return xc(this).info(v),xc(this).debug(`[${l}] response start`,Sc({retryOfRequestLogID:n,url:_.url,status:_.status,headers:_.headers,durationMs:y-f})),{response:_,options:s,controller:g,requestLogID:l,retryOfRequestLogID:n,startTime:f}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){const n=this.makeRequest(t,null,void 0);return new Pc(this,n,e)}async fetchWithTimeout(e,t,n,s){const{signal:r,method:a,...i}=t||{};r&&r.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),n),c=globalThis.ReadableStream&&i.body instanceof globalThis.ReadableStream||"object"==typeof i.body&&null!==i.body&&Symbol.asyncIterator in i.body,u={signal:s.signal,...c?{duplex:"half"}:{},method:"GET",...i};a&&(u.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(o)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n,s){let r;const a=s?.get("retry-after-ms");if(a){const e=parseFloat(a);Number.isNaN(e)||(r=e)}const i=s?.get("retry-after");if(i&&!r){const e=parseFloat(i);r=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Zo(r),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:s,path:r,query:a,defaultBaseURL:i}=n,o=this.buildURL(r,a,i);"timeout"in n&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new u(`${e} must be an integer`);if(t<0)throw new u(`${e} must be a positive integer`)})("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:c,body:l}=this.buildBody({options:n});return{req:{method:s,headers:await this.buildHeaders({options:e,method:s,bodyHeaders:c,retryCount:t}),...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&l instanceof globalThis.ReadableStream&&{duplex:"half"},...l&&{body:l},...this.fetchOptions??{},...n.fetchOptions??{}},url:o,timeout:n.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:s}){let r={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),r[this.idempotencyHeader]=e.idempotencyKey);const a=Vu([r,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(s),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Bo??(Bo=Fo()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=Vu([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&n.values.has("content-type")||e instanceof Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:zo(e)}:No(this,zl,"f").call(this,{body:e,headers:n})}}Jl=Cd,zl=new WeakMap,Bl=new WeakSet,Wl=function(){return"https://api.openai.com/v1"!==this.baseURL},Cd.OpenAI=Jl,Cd.DEFAULT_TIMEOUT=6e5,Cd.OpenAIError=u,Cd.APIError=l,Cd.APIConnectionError=p,Cd.APIConnectionTimeoutError=h,Cd.APIUserAbortError=d,Cd.NotFoundError=_,Cd.ConflictError=y,Cd.RateLimitError=w,Cd.BadRequestError=m,Cd.AuthenticationError=f,Cd.InternalServerError=b,Cd.PermissionDeniedError=g,Cd.UnprocessableEntityError=v,Cd.InvalidWebhookSignatureError=k,Cd.toFile=async function(e,t,n){if(jc(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Jc(e))(e=await e))return e instanceof File?e:Mc([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const s=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),Mc(await zc(s),t,n)}const s=await zc(e);if(t||(t=Zc(e)),!n?.type){const e=s.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(n={...n,type:e})}return Mc(s,t,n)},Cd.Completions=Xl,Cd.Chat=Gu,Cd.Embeddings=td,Cd.Files=ad,Cd.Images=gd,Cd.Audio=el,Cd.Moderations=yd,Cd.Models=_d,Cd.FineTuning=hd,Cd.Graders=fd,Cd.VectorStores=Td,Cd.Webhooks=Ad,Cd.Beta=Vl,Cd.Batches=tl,Cd.Uploads=Sd,Cd.Responses=bd,Cd.Evals=rd,Cd.Containers=ed,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);let Od,Rd,Ed,Nd="responses";function Pd(e){Ed=e}function $d(e){Nd=e}function Dd(e){Od=e}function jd(e){Rd=e}const Md={"User-Agent":"Agents/JavaScript 0.0.12"},Zd=un("openai-agents:openai"),Ld=cr(["in_progress","completed","searching","failed"]).default("failed"),Fd=cr(["in_progress","completed","searching","failed","incomplete"]).default("failed"),qd=cr(["in_progress","completed","interpreting"]).default("in_progress"),Ud=cr(["in_progress","completed","generating","failed"]).default("failed");function Bd(e={}){const t={type:"web_search",name:e.name??"web_search_preview",user_location:e.userLocation,search_context_size:e.searchContextSize??"medium"};return{type:"hosted_tool",name:e.name??"web_search_preview",providerData:t}}function Jd(e,t={}){const n=Array.isArray(e)?e:[e],s={type:"file_search",name:t.name??"file_search",vector_store_ids:n,max_num_results:t.maxNumResults,include_search_results:t.includeSearchResults,ranking_options:t.rankingOptions,filters:t.filters};return{type:"hosted_tool",name:t.name??"file_search",providerData:s}}function zd(e={}){const t={type:"code_interpreter",name:e.name??"code_interpreter",container:e.container??{type:"auto"}};return{type:"hosted_tool",name:e.name??"code_interpreter",providerData:t}}function Wd(e={}){const t={type:"image_generation",name:e.name??"image_generation",background:e.background,input_fidelity:e.inputFidelity,input_image_mask:e.inputImageMask,model:e.model,moderation:e.moderation,output_compression:e.outputCompression,output_format:e.outputFormat,partial_images:e.partialImages,quality:e.quality,size:e.size};return{type:"hosted_tool",name:e.name??"image_generation",providerData:t}}function Gd(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;const t={};for(const[n,s]of Object.entries(e))t[n.replace(/([A-Z])/g,"_$1").toLowerCase()]=Gd(s);return t}const Kd=cr(["file_search","web_search_preview","computer_use_preview","code_interpreter","image_generation","mcp"]),Hd=cr(["auto","required","none"]);function Vd(e){if("function"===e.type)return{tool:{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict},include:void 0};if("computer"===e.type)return{tool:{type:"computer_use_preview",environment:e.environment,display_width:e.dimensions[0],display_height:e.dimensions[1]},include:void 0};if("hosted_tool"===e.type){if("web_search"===e.providerData?.type)return{tool:{type:"web_search_preview",user_location:e.providerData.user_location,search_context_size:e.providerData.search_context_size},include:void 0};if("file_search"===e.providerData?.type)return{tool:{type:"file_search",vector_store_ids:e.providerData.vector_store_ids||("string"==typeof e.providerData.vector_store_id?[e.providerData.vector_store_id]:e.providerData.vector_store_id),max_num_results:e.providerData.max_num_results,ranking_options:e.providerData.ranking_options,filters:e.providerData.filters},include:e.providerData.include_search_results?["file_search_call.results"]:void 0};if("code_interpreter"===e.providerData?.type)return{tool:{type:"code_interpreter",container:e.providerData.container},include:void 0};if("image_generation"===e.providerData?.type)return{tool:{type:"image_generation",background:e.providerData.background,input_fidelity:e.providerData.input_fidelity,input_image_mask:e.providerData.input_image_mask,model:e.providerData.model,moderation:e.providerData.moderation,output_compression:e.providerData.output_compression,output_format:e.providerData.output_format,partial_images:e.providerData.partial_images,quality:e.providerData.quality,size:e.providerData.size},include:void 0};if("mcp"===e.providerData?.type)return{tool:{type:"mcp",server_label:e.providerData.server_label,server_url:e.providerData.server_url,allowed_tools:e.providerData.allowed_tools,headers:e.providerData.headers,require_approval:(t=e.providerData.require_approval,"never"===t||void 0===t?"never":"always"===t?"always":{never:{tool_names:t.never?.tool_names},always:{tool_names:t.always?.tool_names}})},include:void 0};if(e.providerData)return{tool:e.providerData,include:void 0}}var t;throw new Error(`Unsupported tool type: ${JSON.stringify(e)}`)}function Xd(e){return{name:e.toolName,description:e.toolDescription,parameters:e.inputJsonSchema,strict:e.strictJsonSchema,type:"function"}}function Yd(e){if("input_text"===e.type)return{type:"input_text",text:e.text,...Gd(e.providerData)};if("input_image"===e.type){const t={type:"input_image",detail:"auto"};return"string"==typeof e.image?t.image_url=e.image:t.file_id=e.image.id,{...t,...Gd(e.providerData)}}if("input_file"===e.type){const t={type:"input_file"};if("string"==typeof e.file)if(e.file.startsWith("data:"))t.file_data=e.file;else{if(!e.file.startsWith("https://"))throw new Gt("Unsupported string data for file input. If you're trying to pass an uploaded file's ID, use an object with the ID property instead.");t.file_url=e.file}else"id"in e.file?t.file_id=e.file.id:"url"in e.file&&(t.file_url=e.file.url);return{...t,...Gd(e.providerData)}}throw new Gt(`Unsupported input content type: ${JSON.stringify(e)}`)}function Qd(e){if("output_text"===e.type)return{type:"output_text",text:e.text,annotations:[],...Gd(e.providerData)};if("refusal"===e.type)return{type:"refusal",refusal:e.refusal,...Gd(e.providerData)};throw new Gt(`Unsupported output content type: ${JSON.stringify(e)}`)}function ep(e){return{type:"computer_screenshot",image_url:e.output.data}}function tp(e){if("output_text"===e.type){const{type:t,text:n,...s}=e;return{type:t,text:n,...s}}if("refusal"===e.type){const{type:t,refusal:n,...s}=e;return{type:t,refusal:n,...s}}throw new Error(`Unsupported message content type: ${JSON.stringify(e)}`)}function np(e){return e.map(e=>{if("message"===e.type){const{id:t,type:n,role:s,content:r,status:a,...i}=e;return{id:t,type:n,role:s,content:r.map(tp),status:a,providerData:i}}if("file_search_call"===e.type||"web_search_call"===e.type||"image_generation_call"===e.type||"code_interpreter_call"===e.type){const{status:t,...n}=e;let s;return"result"in n&&null!==n.result&&(s=n.result,delete n.result),{type:"hosted_tool_call",id:e.id,name:e.type,status:t,output:s,providerData:n}}if("function_call"===e.type){const{call_id:t,name:n,status:s,arguments:r,...a}=e;return{type:"function_call",id:e.id,callId:t,name:n,status:s,arguments:r,providerData:a}}if("computer_call"===e.type){const{call_id:t,status:n,action:s,...r}=e;return{type:"computer_call",id:e.id,callId:t,status:n,action:s,providerData:r}}if("mcp_list_tools"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:void 0,providerData:t}}if("mcp_approval_request"===e.type){const{...t}=e;return{type:"hosted_tool_call",id:e.id,name:"mcp_approval_request",status:"completed",output:void 0,providerData:t}}if("mcp_call"===e.type){const{output:t,...n}=e;return{type:"hosted_tool_call",id:e.id,name:e.type,status:"completed",output:t||void 0,providerData:n}}if("reasoning"===e.type){const{summary:t,...n}=e;return{type:"reasoning",id:e.id,content:t.map(e=>{const{text:t,...n}=e;return{type:"input_text",text:t,providerData:n}}),providerData:n}}return{type:"unknown",providerData:e}})}class sp{#U;#B;constructor(e,t){this.#U=e,this.#B=t}async#J(e,t){const n=function(e){return"string"==typeof e?[{role:"user",content:e}]:e.map(e=>{if(function(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}(e))return function(e){if("system"===e.role)return{id:e.id,role:"system",content:e.content,...Gd(e.providerData)};if("user"===e.role)return"string"==typeof e.content?{id:e.id,role:"user",content:e.content,...Gd(e.providerData)}:{id:e.id,role:"user",content:e.content.map(Yd),...Gd(e.providerData)};if("assistant"===e.role)return{type:"message",id:e.id,role:"assistant",content:e.content.map(Qd),status:e.status,...Gd(e.providerData)};throw new Gt(`Unsupported item ${JSON.stringify(e)}`)}(e);if("function_call"===e.type)return{id:e.id,type:"function_call",name:e.name,call_id:e.callId,arguments:e.arguments,status:e.status,...Gd(e.providerData)};if("function_call_result"===e.type){if("text"!==e.output.type)throw new Gt(`Unsupported tool result type: ${JSON.stringify(e.output)}`);return{type:"function_call_output",id:e.id,call_id:e.callId,output:e.output.text,status:e.status,...Gd(e.providerData)}}if("reasoning"===e.type)return{id:e.id,type:"reasoning",summary:e.content.map(e=>({type:"summary_text",text:e.text,...Gd(e.providerData)})),encrypted_content:e.providerData?.encryptedContent,...Gd(e.providerData)};if("computer_call"===e.type)return{type:"computer_call",call_id:e.callId,id:e.id,action:e.action,status:e.status,pending_safety_checks:[],...Gd(e.providerData)};if("computer_call_result"===e.type)return{type:"computer_call_output",id:e.id,call_id:e.callId,output:ep(e),status:e.providerData?.status,acknowledged_safety_checks:e.providerData?.acknowledgedSafetyChecks,...Gd(e.providerData)};if("hosted_tool_call"===e.type){if("web_search_call"===e.providerData?.type||"web_search"===e.providerData?.type)return{...Gd(e.providerData),type:"web_search_call",id:e.id,status:Ld.parse(e.status??"failed")};if("file_search_call"===e.providerData?.type||"file_search"===e.providerData?.type)return{...Gd(e.providerData),type:"file_search_call",id:e.id,status:Fd.parse(e.status??"failed"),queries:e.providerData?.queries??[],results:e.providerData?.results};if("code_interpreter_call"===e.providerData?.type||"code_interpreter"===e.providerData?.type)return{...Gd(e.providerData),type:"code_interpreter_call",id:e.id,code:e.providerData?.code??"",outputs:e.providerData?.outputs??e.providerData?.results??[],status:qd.parse(e.status??"failed"),container_id:e.providerData?.containerId};if("image_generation_call"===e.providerData?.type||"image_generation"===e.providerData?.type)return{...Gd(e.providerData),type:"image_generation_call",id:e.id,result:e.providerData?.result??null,status:Ud.parse(e.status??"failed")};if("mcp_list_tools"===e.providerData?.type||"mcp_list_tools"===e.name){const t=e.providerData;return{...Gd(e.providerData),type:"mcp_list_tools",id:e.id,tools:Gd(t.tools),server_label:t.server_label,error:t.error}}if("mcp_approval_request"===e.providerData?.type||"mcp_approval_request"===e.name){const t=e.providerData;return{...Gd(e.providerData),type:"mcp_approval_request",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label}}if("mcp_approval_response"===e.providerData?.type||"mcp_approval_response"===e.name){const t=e.providerData;return{...Gd(t),type:"mcp_approval_response",id:t.id,approve:t.approve,approval_request_id:t.approval_request_id,reason:t.reason}}if("mcp_call"===e.providerData?.type||"mcp_call"===e.name){const t=e.providerData;return{...Gd(t),type:"mcp_call",id:t.id??e.id,name:t.name,arguments:t.arguments,server_label:t.server_label,error:t.error}}throw new Gt(`Unsupported built-in tool call type: ${JSON.stringify(e)}`)}if("unknown"===e.type)return{...Gd(e.providerData),id:e.id};const t=e;throw new Gt(`Unsupported item ${JSON.stringify(t)}`)})}(e.input),{tools:s,include:r}=function(e,t){const n=[],s=[];for(const t of e){const{tool:e,include:r}=Vd(t);if(n.push(e),r&&r.length>0)for(const e of r)s.push(e)}return{tools:[...n,...t.map(Xd)],include:s}}(e.tools,e.handoffs),a=function(e){if(void 0===e)return;const t=Hd.safeParse(e);if(t.success)return t.data;const n=Kd.safeParse(e);return n.success?{type:n.data}:{type:"function",name:e}}(e.modelSettings.toolChoice),i=function(e){if("text"!==e)return{format:e}}(e.outputType),o=function(e){if(!e)return;const t={};for(const[n,s]of Object.entries(e.variables??{}))"string"==typeof s?t[n]=s:"object"==typeof s&&(t[n]=Yd(s));return{id:e.promptId,version:e.version,variables:t}}(e.prompt);let c;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===s.length)throw new Error("Parallel tool calls are not supported without tools");c=e.modelSettings.parallelToolCalls}const u={instructions:e.systemInstructions,model:this.#B,input:n,include:r,tools:s,previous_response_id:e.previousResponseId,prompt:o,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,truncation:e.modelSettings.truncation,max_output_tokens:e.modelSettings.maxTokens,tool_choice:a,parallel_tool_calls:c,stream:t,text:i,store:e.modelSettings.store,...e.modelSettings.providerData};Zd.dontLogModelData?Zd.debug("Calling LLM"):Zd.debug(`Calling LLM. Request data: ${JSON.stringify(u,null,2)}`);const l=await this.#U.responses.create(u,{headers:Md,signal:e.signal});return Zd.dontLogModelData?Zd.debug("Response received"):Zd.debug(`Response received: ${JSON.stringify(l,null,2)}`),l}async getResponse(e){const t=await ra(async t=>{const n=await this.#J(e,!1);return e.tracing&&(t.spanData.response_id=n.id,t.spanData._input=e.input,t.spanData._response=n),n});return{usage:new Si({inputTokens:t.usage?.input_tokens??0,outputTokens:t.usage?.output_tokens??0,totalTokens:t.usage?.total_tokens??0,inputTokensDetails:{...t.usage?.input_tokens_details},outputTokensDetails:{...t.usage?.output_tokens_details}}),output:np(t.output),responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?sa():void 0;try{t&&(t.start(),$r(t),!0===e.tracing&&(t.spanData._input=e.input));const n=await this.#J(e,!0);let s;for await(const e of n){if("response.created"===e.type)yield{type:"response_started",providerData:{...e}};else if("response.completed"===e.type){s=e.response;const{response:t,...n}=e,{output:r,usage:a,id:i,...o}=t;yield{type:"response_done",response:{id:i,output:np(r),usage:{inputTokens:a?.input_tokens??0,outputTokens:a?.output_tokens??0,totalTokens:a?.total_tokens??0,inputTokensDetails:{...a?.input_tokens_details},outputTokensDetails:{...a?.output_tokens_details}},providerData:o},providerData:n},yield{type:"model",event:e}}else if("response.output_text.delta"===e.type){const{delta:t,...n}=e;yield{type:"output_text_delta",delta:t,providerData:n}}yield{type:"model",event:e}}e.tracing&&t&&s&&(t.spanData.response_id=s.id,t.spanData._response=s)}catch(n){throw t&&t.setError({message:"Error streaming response",data:{error:e.tracing?String(n):n instanceof Error?n.name:void 0}}),n}finally{t&&(t.end(),Dr())}}}function rp(e){if(null!=e&&null!=e)return"auto"===e||"required"===e||"none"===e?e:{type:"function",function:{name:e}}}function ap(e){if("string"==typeof e)return e;const t=[];for(const n of e)if("output_text"===n.type||"input_text"===n.type)t.push({type:"text",text:n.text,...n.providerData});else{if("refusal"!==n.type){if("audio"===n.type||"image"===n.type)continue;{const e=n;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}}t.push({type:"refusal",refusal:n.refusal,...n.providerData})}return t}function ip(e){if("string"==typeof e)return e;const t=[];for(const n of e)if("input_text"===n.type)t.push({type:"text",text:n.text,...n.providerData});else if("input_image"===n.type){if("string"!=typeof n.image)throw new Error(`Only image URLs are supported for input_image: ${JSON.stringify(n)}`);const{image_url:e,...s}=n.providerData||{};t.push({type:"image_url",image_url:{url:n.image,...e},...s})}else{if("input_file"===n.type)throw new Error(`File uploads are not supported for chat completions: ${JSON.stringify(n)}`);if("audio"!==n.type){const e=n;throw new Error(`Unknown content: ${JSON.stringify(e)}`)}{const{input_audio:e,...s}=n.providerData||{};t.push({type:"input_audio",input_audio:{data:n.audio,...e},...s})}}return t}function op(e){return"message"===e.type||void 0===e.type&&"string"==typeof e.role}function cp(e){if("function"===e.type)return{type:"function",function:{name:e.name,description:e.description||"",parameters:e.parameters}};throw new Error(`Hosted tools are not supported with the ChatCompletions API. Got tool type: ${e.type}, tool: ${JSON.stringify(e)}`)}function up(e){return{type:"function",function:{name:e.toolName,description:e.toolDescription||"",parameters:e.inputJsonSchema}}}const lp="FAKE_ID";class dp{#U;#B;constructor(e,t){this.#U=e,this.#B=t}async getResponse(e){const t=await pa(async t=>{t.spanData.model=this.#B,t.spanData.model_config=e.modelSettings?{temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty}:{base_url:this.#U.baseURL};const n=await this.#J(e,t,!1);return t&&!0===e.tracing&&(t.spanData.output=[n]),n}),n=[];if(t.choices&&t.choices[0]){const e=t.choices[0].message;if(void 0===e.content||null===e.content||e.tool_calls&&""===e.content){if(e.refusal){const{refusal:s,...r}=e;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"refusal",refusal:s||"",providerData:r}],status:"completed"})}else if(e.audio){const{data:s,...r}=e.audio;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"audio",audio:s,providerData:r}],status:"completed"})}else if(e.tool_calls)for(const s of e.tool_calls){const{id:e,...r}=s,{arguments:a,name:i,...o}=s.function;n.push({id:t.id,type:"function_call",arguments:a,name:i,callId:e,status:"completed",providerData:{...r,...o}})}}else{const{content:s,...r}=e;n.push({id:t.id,type:"message",role:"assistant",content:[{type:"output_text",text:s||"",providerData:r}],status:"completed"})}}var s;return{usage:t.usage?new Si((s=t.usage,{requests:1,input_tokens:s.prompt_tokens,output_tokens:s.completion_tokens,total_tokens:s.total_tokens,input_tokens_details:{cached_tokens:s.prompt_tokens_details?.cached_tokens||0},output_tokens_details:{reasoning_tokens:s.completion_tokens_details?.reasoning_tokens||0}})):new Si,output:n,responseId:t.id,providerData:t}}async*getStreamedResponse(e){const t=e.tracing?da():void 0;try{t&&(t.start(),$r(t));const n=await this.#J(e,t,!0),s={id:lp,created:Math.floor(Date.now()/1e3),model:this.#B,object:"chat.completion",choices:[],usage:{prompt_tokens:0,completion_tokens:0,total_tokens:0}};for await(const e of async function*(e,t){let n;const s={started:!1,text_content_index_and_output:null,refusal_content_index_and_output:null,function_calls:{}};for await(const e of t){if(s.started||(s.started=!0,yield{type:"response_started",providerData:{...e}}),yield{type:"model",event:e},n=e.usage||void 0,!e.choices?.[0]?.delta)continue;const t=e.choices[0].delta;if(t.content&&(s.text_content_index_and_output||(s.text_content_index_and_output=[s.refusal_content_index_and_output?1:0,{text:"",type:"output_text",providerData:{annotations:[]}}]),yield{type:"output_text_delta",delta:t.content,providerData:{...e}},s.text_content_index_and_output[1].text+=t.content),"refusal"in t&&t.refusal&&(s.refusal_content_index_and_output||(s.refusal_content_index_and_output=[s.text_content_index_and_output?1:0,{refusal:"",type:"refusal"}]),s.refusal_content_index_and_output[1].refusal+=t.refusal),t.tool_calls)for(const e of t.tool_calls){e.index in s.function_calls||(s.function_calls[e.index]={id:lp,arguments:"",name:"",type:"function_call",callId:""});const t=e.function;s.function_calls[e.index].arguments+=t?.arguments||"",s.function_calls[e.index].name+=t?.name||"",s.function_calls[e.index].callId+=e.id||""}}const r=[];if(s.text_content_index_and_output||s.refusal_content_index_and_output){const e={id:lp,content:[],role:"assistant",type:"message",status:"completed"};s.text_content_index_and_output&&e.content.push(s.text_content_index_and_output[1]),s.refusal_content_index_and_output&&e.content.push(s.refusal_content_index_and_output[1]),r.push(e)}for(const e of Object.values(s.function_calls))r.push(e);const a={type:"response_done",response:{id:e.id,usage:{inputTokens:n?.prompt_tokens??0,outputTokens:n?.completion_tokens??0,totalTokens:n?.total_tokens??0,inputTokensDetails:{cached_tokens:n?.prompt_tokens_details?.cached_tokens??0},outputTokensDetails:{reasoning_tokens:n?.completion_tokens_details?.reasoning_tokens??0}},output:r}};yield a}(s,n))yield e;t&&s&&!0===e.tracing&&(t.spanData.output=[s])}catch(n){throw t&&t.setError({message:"Error streaming response",data:{error:!0===e.tracing?String(n):n instanceof Error?n.name:void 0}}),n}finally{t&&(t.end(),Dr())}}async#J(e,t,n){const s=[];if(e.tools)for(const t of e.tools)s.push(cp(t));if(e.handoffs)for(const t of e.handoffs)s.push(up(t));const r="text"===(a=e.outputType)?{type:"text"}:"json_schema"===a.type?{type:"json_schema",json_schema:{name:a.name,strict:a.strict,schema:a.schema}}:{type:"json_object"};var a;let i;if("boolean"==typeof e.modelSettings.parallelToolCalls){if(e.modelSettings.parallelToolCalls&&0===s.length)throw new Error("Parallel tool calls are not supported without tools");i=e.modelSettings.parallelToolCalls}const o=function(e){if("string"==typeof e)return[{role:"user",content:e}];const t=[];let n=null;const s=()=>{n&&(n.tool_calls&&0!==n.tool_calls.length||delete n.tool_calls,t.push(n),n=null)},r=()=>(n||(n={role:"assistant",tool_calls:[]}),n);for(const n of e)if(op(n)){const{content:e,role:r,providerData:a}=n;if(s(),"assistant"===r){const n={role:"assistant",content:ap(e),...a},s=e.find(e=>"audio"===e.type);s&&(n.audio={id:"",...s.providerData}),t.push(n)}else"user"===r?t.push({role:r,content:ip(e),...a}):"system"===r&&t.push({role:"system",content:e,...a})}else{if("reasoning"===n.type)throw new Gt("Reasoning is not supported for chat completions. Got item: "+JSON.stringify(n));if("hosted_tool_call"===n.type){if("file_search_call"===n.name){const e=r(),t=e.tool_calls??[],s=n,{function:a,...i}=s.providerData??{},{arguments:o,...c}=a??{};t.push({id:s.id||"",type:"function",function:{name:"file_search_call",arguments:JSON.stringify({queries:s.providerData?.queries??[],status:s.status,...o}),...c},...i}),e.tool_calls=t;continue}throw new Gt("Hosted tool calls are not supported for chat completions. Got item: "+JSON.stringify(n))}if("computer_call"===n.type||"computer_call_result"===n.type)throw new Gt("Computer use calls are not supported for chat completions. Got item: "+JSON.stringify(n));if("function_call"===n.type){const e=r(),t=e.tool_calls??[],s=n;t.push({id:s.callId,type:"function",function:{name:s.name,arguments:s.arguments??"{}"}}),e.tool_calls=t}else if("function_call_result"===n.type){s();const e=n;if("text"!==e.output.type)throw new Gt("Only text output is supported for chat completions. Got item: "+JSON.stringify(n));t.push({role:"tool",tool_call_id:e.callId,content:e.output.text,...e.providerData})}else{if("unknown"!==n.type){const e=n;throw new Error(`Unknown item type: ${JSON.stringify(e)}`)}t.push({...n.providerData})}}return s(),t}(e.input);e.systemInstructions&&o.unshift({content:e.systemInstructions,role:"system"}),t&&!0===e.tracing&&(t.spanData.input=o);const c={model:this.#B,messages:o,tools:s.length?s:void 0,temperature:e.modelSettings.temperature,top_p:e.modelSettings.topP,frequency_penalty:e.modelSettings.frequencyPenalty,presence_penalty:e.modelSettings.presencePenalty,max_tokens:e.modelSettings.maxTokens,tool_choice:rp(e.modelSettings.toolChoice),response_format:r,parallel_tool_calls:i,stream:n,store:e.modelSettings.store,...e.modelSettings.providerData};Zd.dontLogModelData?Zd.debug("Calling LLM"):Zd.debug(`Calling LLM. Request data: ${JSON.stringify(c,null,2)}`);const u=await this.#U.chat.completions.create(c,{headers:Md,signal:e.signal});return Zd.dontLogModelData?Zd.debug("Response received"):Zd.debug(`Response received: ${JSON.stringify(u,null,2)}`),u}}class pp{#U;#z;#W;constructor(e={}){if(this.#W=e,this.#W.openAIClient){if(this.#W.apiKey)throw new Error("Cannot provide both apiKey and openAIClient");if(this.#W.baseURL)throw new Error("Cannot provide both baseURL and openAIClient");this.#U=this.#W.openAIClient}this.#z=this.#W.useResponses}#G(){return this.#U||(this.#U=Od??new Cd({apiKey:this.#W.apiKey??Rd??{}.OPENAI_API_KEY,baseURL:this.#W.baseURL,organization:this.#W.organization,project:this.#W.project})),this.#U}async getModel(e){const t=e||"gpt-4.1";return this.#z??"responses"===Nd?new sp(this.#G(),t):new dp(this.#G(),t)}}class hp{#W;constructor(e={}){this.#W={apiKey:e.apiKey??void 0,organization:e.organization??"",project:e.project??"",endpoint:e.endpoint??"https://api.openai.com/v1/traces/ingest",maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4}}async export(e,t){const n=this.#W.apiKey??Ed??{}.OPENAI_API_KEY;if(!n)return void Zd.error("No API key provided for OpenAI tracing exporter. Exports will be skipped");const s={data:e.map(e=>e.toJSON()).filter(e=>!!e)};let r=0,a=this.#W.baseDelay;for(;r<this.#W.maxRetries;){try{const e=await fetch(this.#W.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,"OpenAI-Beta":"traces=v1",...Md},body:JSON.stringify(s),signal:t});if(e.ok)return void Zd.debug(`Exported ${s.data.length} items`);if(e.status>=400&&e.status<500)return void Zd.error(`[non-fatal] Tracing client error ${e.status}: ${await e.text()}`);Zd.warn(`[non-fatal] Tracing: server error ${e.status}, retrying.`)}catch(e){Zd.error("[non-fatal] Tracing: request failed: ",e)}if(t?.aborted)return void Zd.error("Tracing: request aborted");const e=a+.1*Math.random()*a;await new Promise(t=>setTimeout(t,e)),a=Math.min(2*a,this.#W.maxDelay),r++}Zd.error(`Tracing: failed to export traces after ${this.#W.maxRetries} attempts`)}}function mp(){const e=new hp;Ta([new Lr(e)])}const fp="0.0.12";function gp(e){const t=atob(e),n=t.length,s=new Uint8Array(n);for(let e=0;e<n;e++)s[e]=t.charCodeAt(e);return s.buffer}function _p(e){const t=String.fromCharCode(...new Uint8Array(e));return btoa(t)}function yp(e){if(null==e||"object"!=typeof e||!("type"in e)||"string"!=typeof e.type||!e.type)return;if("message"!==e.type)return;if(!("content"in e)||!Array.isArray(e.content)||e.content.length<1)return;const t=e.content[e.content.length-1];return"type"in t&&"string"==typeof t.type?"text"===t.type?"string"==typeof t.text?t.text:void 0:"audio"===t.type&&"string"==typeof t.transcript?t.transcript:void 0:void 0}function vp(e){return"system"===e.role?e:"assistant"===e.role?{...e,content:e.content.map(e=>"audio"===e.type?{...e,audio:null}:e)}:"user"===e.role?{...e,content:e.content.map(e=>"input_audio"===e.type?{...e,audio:null}:e)}:e}function wp(e,t,n){if("conversation.item.input_audio_transcription.completed"===t.type)return e.map(e=>{if(e.itemId===t.item_id&&"message"===e.type&&"role"in e&&"user"===e.role){const n=e.content.map(e=>"input_audio"===e.type?{...e,transcript:t.transcript}:e);return{...e,content:n,status:"completed"}}return e});const s=n||"message"!==t.type?t:vp(t),r=e.findIndex(e=>e.itemId===t.itemId);if(-1!==r)return e.map((e,t)=>t===r?s:n||"message"!==e.type?e:vp(e));if(t.previousItemId){const n=e.findIndex(e=>e.itemId===t.previousItemId);return-1!==n?[...e.slice(0,n+1),s,...e.slice(n+1)]:[...e,s]}return[...e,s]}const bp={"User-Agent":`Agents/JavaScript ${fp}`,"X-OpenAI-Agents-SDK":`openai-agents-sdk.${fp}`},xp=`openai-agents-sdk.${fp}`;class Sp extends Ao{voice;constructor(e){super(e),this.voice=e.voice??"ash"}}function kp({policyHint:e,...t}){const n=Pa(t),s=e??n.name;return{...n,policyHint:s,run:async e=>{const t=await n.run(e);return{...t,guardrail:{...t.guardrail,policyHint:s}}}}}const Ip=un("openai-agents:realtime"),Tp=(nr({itemId:Xs()}),rr("role",[nr({itemId:Xs(),previousItemId:Xs().nullable().optional(),type:or("message"),role:or("system"),content:tr(nr({type:or("input_text"),text:Xs()}))}),nr({itemId:Xs(),previousItemId:Xs().nullable().optional(),type:or("message"),role:or("user"),status:cr(["in_progress","completed"]),content:tr(nr({type:or("input_text"),text:Xs()}).or(nr({type:or("input_audio"),audio:Xs().nullable().optional(),transcript:Xs().nullable()})))}),nr({itemId:Xs(),previousItemId:Xs().nullable().optional(),type:or("message"),role:or("assistant"),status:cr(["in_progress","completed","incomplete"]),content:tr(nr({type:or("text"),text:Xs()}).or(nr({type:or("audio"),audio:Xs().nullable().optional(),transcript:Xs().nullable().optional()})))})])),Ap=nr({itemId:Xs(),previousItemId:Xs().nullable().optional(),type:or("function_call"),status:cr(["in_progress","completed"]),arguments:Xs(),name:Xs(),output:Xs().nullable()}),Cp=nr({id:Xs().optional().nullable(),conversation_id:Xs().optional().nullable(),max_output_tokens:Ys().or(or("inf")).optional().nullable(),metadata:ar(Xs(),er()).optional().nullable(),modalities:tr(Xs()).optional().nullable(),object:or("realtime.response").optional().nullable(),output:tr(er()).optional().nullable(),output_audio_format:Xs().optional().nullable(),status:cr(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:ar(Xs(),er()).optional().nullable(),usage:nr({input_tokens:Ys().optional(),input_tokens_details:ar(Xs(),er()).optional().nullable(),output_tokens:Ys().optional(),output_tokens_details:ar(Xs(),er()).optional().nullable()}).optional().nullable(),voice:Xs().optional().nullable()}),Op=nr({id:Xs().optional(),audio:Xs().nullable().optional(),text:Xs().nullable().optional(),transcript:Xs().nullable().optional(),type:sr([or("input_text"),or("input_audio"),or("item_reference"),or("text"),or("audio")])}),Rp=nr({id:Xs().optional(),arguments:Xs().optional(),call_id:Xs().optional(),content:tr(Op).optional(),name:Xs().optional(),object:or("realtime.item").optional(),output:Xs().optional(),role:cr(["user","assistant","system"]).optional(),status:cr(["completed","incomplete","in_progress"]).optional(),type:cr(["message","function_call","function_call_output"]).optional()}),Ep=nr({type:or("conversation.created"),event_id:Xs(),conversation:nr({id:Xs().optional(),object:or("realtime.conversation").optional()})}),Np=nr({type:or("conversation.item.created"),event_id:Xs(),item:Rp,previous_item_id:Xs().nullable().optional()}),Pp=nr({type:or("conversation.item.deleted"),event_id:Xs(),item_id:Xs()}),$p=nr({type:or("conversation.item.input_audio_transcription.completed"),event_id:Xs(),item_id:Xs(),content_index:Ys(),transcript:Xs(),logprobs:tr(er()).nullable().optional()}),Dp=nr({type:or("conversation.item.input_audio_transcription.delta"),event_id:Xs(),item_id:Xs(),content_index:Ys().optional(),delta:Xs().optional(),logprobs:tr(er()).nullable().optional()}),jp=nr({type:or("conversation.item.input_audio_transcription.failed"),event_id:Xs(),item_id:Xs(),content_index:Ys(),error:nr({code:Xs().optional(),message:Xs().optional(),param:Xs().optional(),type:Xs().optional()})}),Mp=nr({type:or("conversation.item.retrieved"),event_id:Xs(),item:Rp}),Zp=nr({type:or("conversation.item.truncated"),event_id:Xs(),item_id:Xs(),audio_end_ms:Ys(),content_index:Ys()}),Lp=nr({type:or("conversation.item.create"),item:Rp,event_id:Xs().optional(),previous_item_id:Xs().nullable().optional()}),Fp=nr({type:or("conversation.item.delete"),item_id:Xs(),event_id:Xs().optional()}),qp=nr({type:or("conversation.item.retrieve"),item_id:Xs(),event_id:Xs().optional()}),Up=nr({type:or("conversation.item.truncate"),item_id:Xs(),audio_end_ms:Ys(),content_index:Ys(),event_id:Xs().optional()}),Bp=nr({type:or("error"),event_id:Xs().optional(),error:er().optional()}),Jp=nr({type:or("input_audio_buffer.cleared"),event_id:Xs()}),zp=nr({type:or("input_audio_buffer.append"),audio:Xs(),event_id:Xs().optional()}),Wp=nr({type:or("input_audio_buffer.clear"),event_id:Xs().optional()}),Gp=nr({type:or("input_audio_buffer.commit"),event_id:Xs().optional()}),Kp=nr({type:or("input_audio_buffer.committed"),event_id:Xs(),item_id:Xs(),previous_item_id:Xs().nullable().optional()}),Hp=nr({type:or("input_audio_buffer.speech_started"),event_id:Xs(),item_id:Xs(),audio_start_ms:Ys()}),Vp=nr({type:or("input_audio_buffer.speech_stopped"),event_id:Xs(),item_id:Xs(),audio_end_ms:Ys()}),Xp=nr({type:or("output_audio_buffer.started"),event_id:Xs()}).passthrough(),Yp=nr({type:or("output_audio_buffer.stopped"),event_id:Xs()}).passthrough(),Qp=nr({type:or("output_audio_buffer.cleared"),event_id:Xs()}),eh=nr({type:or("rate_limits.updated"),event_id:Xs(),rate_limits:tr(nr({limit:Ys().optional(),name:cr(["requests","tokens"]).optional(),remaining:Ys().optional(),reset_seconds:Ys().optional()}))}),th=nr({type:or("response.audio.delta"),event_id:Xs(),item_id:Xs(),content_index:Ys(),delta:Xs(),output_index:Ys(),response_id:Xs()}),nh=nr({type:or("response.audio.done"),event_id:Xs(),item_id:Xs(),content_index:Ys(),output_index:Ys(),response_id:Xs()}),sh=nr({type:or("response.audio_transcript.delta"),event_id:Xs(),item_id:Xs(),content_index:Ys(),delta:Xs(),output_index:Ys(),response_id:Xs()}),rh=nr({type:or("response.audio_transcript.done"),event_id:Xs(),item_id:Xs(),content_index:Ys(),transcript:Xs(),output_index:Ys(),response_id:Xs()}),ah=nr({type:or("response.content_part.added"),event_id:Xs(),item_id:Xs(),content_index:Ys(),output_index:Ys(),response_id:Xs(),part:nr({audio:Xs().optional(),text:Xs().optional(),transcript:Xs().optional(),type:cr(["text","audio"]).optional()})}),ih=nr({type:or("response.content_part.done"),event_id:Xs(),item_id:Xs(),content_index:Ys(),output_index:Ys(),response_id:Xs(),part:nr({audio:Xs().optional(),text:Xs().optional(),transcript:Xs().optional(),type:cr(["text","audio"]).optional()})}),oh=nr({type:or("response.created"),event_id:Xs(),response:Cp}),ch=nr({type:or("response.done"),event_id:Xs(),response:Cp}),uh=nr({type:or("response.function_call_arguments.delta"),event_id:Xs(),item_id:Xs(),call_id:Xs(),delta:Xs(),output_index:Ys(),response_id:Xs()}),lh=nr({type:or("response.function_call_arguments.done"),event_id:Xs(),item_id:Xs(),call_id:Xs(),arguments:Xs(),output_index:Ys(),response_id:Xs()}),dh=nr({type:or("response.output_item.added"),event_id:Xs(),item:Rp,output_index:Ys(),response_id:Xs()}),ph=nr({type:or("response.output_item.done"),event_id:Xs(),item:Rp,output_index:Ys(),response_id:Xs()}),hh=nr({type:or("response.text.delta"),event_id:Xs(),item_id:Xs(),content_index:Ys(),delta:Xs(),output_index:Ys(),response_id:Xs()}),mh=nr({type:or("response.text.done"),event_id:Xs(),item_id:Xs(),content_index:Ys(),text:Xs(),output_index:Ys(),response_id:Xs()}),fh=nr({type:or("session.created"),event_id:Xs(),session:er()}),gh=nr({type:or("session.updated"),event_id:Xs(),session:er()}),_h=nr({type:or("response.cancel"),event_id:Xs().optional(),response_id:Xs().optional()}),yh=nr({type:or("response.create"),event_id:Xs().optional(),response:er().optional()}),vh=nr({type:or("session.update"),event_id:Xs().optional(),session:er()}),wh=nr({type:or("transcription_session.update"),event_id:Xs().optional(),session:er()}),bh=nr({type:or("transcription_session.updated"),event_id:Xs(),session:er()}),xh=nr({type:Xs(),event_id:Xs().optional().nullable()}).passthrough(),Sh=rr("type",[Ep,Np,Pp,$p,Dp,jp,Mp,Zp,Bp,Jp,Kp,Hp,Vp,Xp,Yp,Qp,eh,th,nh,sh,rh,ah,ih,oh,ch,uh,lh,dh,ph,hh,mh,fh,gh,bh]);function kh(e){const t=JSON.parse(e.data.toString()),n=Sh.safeParse(t);if(!n.success){const e=xh.safeParse(t);return e.success?{data:e.data,isGeneric:!0}:{data:null,isGeneric:!0}}return{data:n.data,isGeneric:!1}}rr("type",[Lp,Fp,qp,Up,zp,Wp,Gp,_h,yh,vh,wh]);const Ih="gpt-4o-realtime-preview",Th={voice:"ash",modalities:["text","audio"],inputAudioFormat:"pcm16",outputAudioFormat:"pcm16",inputAudioTranscription:{model:"gpt-4o-mini-transcribe"},turnDetection:{type:"semantic_vad"},inputAudioNoiseReduction:null,speed:1};class Ah extends Oa{#B;#K;#H=null;#V=null;eventEmitter=new wr;constructor(e={}){super(),this.#B=e.model??Ih,this.#K=e.apiKey}get currentModel(){return this.#B}set currentModel(e){this.#B=e}get _rawSessionConfig(){return this.#V??null}async _getApiKey(e){const t=e.apiKey??this.#K;return"function"==typeof t?await t():t}_onMessage(e){const{data:t,isGeneric:n}=kh(e);if(null!==t&&(this.emit("*",t),!n))if("error"===t.type?this.emit("error",{type:"error",error:t}):this.emit(t.type,t),"response.created"!==t.type){if("session.updated"===t.type&&(this.#V=t.session),"response.done"===t.type){const e=ch.safeParse(t);if(!e.success)return void Ip.error("Error parsing response done event",e.error);const n=e.data.response.usage?.input_tokens??0,s=e.data.response.usage?.output_tokens??0,r=n+s,a=new Si({inputTokens:n,inputTokensDetails:e.data.response.usage?.input_tokens_details??{},outputTokens:s,outputTokensDetails:e.data.response.usage?.output_tokens_details??{},totalTokens:r});return this.emit("usage_update",a),void this.emit("turn_done",{type:"response_done",response:{id:e.data.response.id??"",output:e.data.response.output??[],usage:{inputTokens:n,inputTokensDetails:e.data.response.usage?.input_tokens_details??{},outputTokens:s,outputTokensDetails:e.data.response.usage?.output_tokens_details??{},totalTokens:r}}})}if("response.audio.done"!==t.type)if("conversation.item.deleted"!==t.type)if("conversation.item.input_audio_transcription.completed"!==t.type&&"conversation.item.truncated"!==t.type)if("conversation.item.input_audio_transcription.delta"!==t.type&&"response.text.delta"!==t.type&&"response.audio_transcript.delta"!==t.type&&"response.function_call_arguments.delta"!==t.type){if(("conversation.item.created"===t.type||"conversation.item.retrieved"===t.type)&&"message"===t.item.type){const e="conversation.item.created"===t.type?t.previous_item_id:null,n=Tp.parse({itemId:t.item.id,previousItemId:e,type:t.item.type,role:t.item.role,content:t.item.content,status:t.item.status});return void this.emit("item_update",n)}if("response.output_item.done"===t.type||"response.output_item.added"===t.type){const e=t.item;if("function_call"===e.type&&"completed"===e.status){const t=Ap.parse({itemId:e.id,type:e.type,status:"in_progress",arguments:e.arguments,name:e.name,output:null});return this.emit("item_update",t),void this.emit("function_call",{id:e.id,type:"function_call",callId:e.call_id??"",arguments:e.arguments??"",name:e.name??""})}if("message"===e.type){const e=Tp.parse({itemId:t.item.id,type:t.item.type,role:t.item.role,content:t.item.content,status:"in_progress"});return void this.emit("item_update",e)}}}else"response.audio_transcript.delta"===t.type&&this.emit("audio_transcript_delta",{type:"transcript_delta",delta:t.delta,itemId:t.item_id,responseId:t.response_id});else this.sendEvent({type:"conversation.item.retrieve",item_id:t.item_id});else this.emit("item_deleted",{itemId:t.item_id});else this.emit("audio_done")}else this.emit("turn_started",{type:"response_started",providerData:{...t}})}_onError(e){this.emit("error",{type:"error",error:e})}_onOpen(){this.emit("connected")}_onClose(){this.emit("disconnected")}sendMessage(e,t){this.sendEvent({type:"conversation.item.create",item:"string"==typeof e?{type:"message",role:"user",content:[{type:"input_text",text:e}]}:e,...t}),this.sendEvent({type:"response.create"})}_getMergedSessionConfig(e){const t={instructions:e.instructions,model:e.model??this.#B??Th.model,voice:e.voice??Th.voice,speed:e.speed??Th.speed,modalities:e.modalities??Th.modalities,input_audio_format:e.inputAudioFormat??Th.inputAudioFormat,output_audio_format:e.outputAudioFormat??Th.outputAudioFormat,input_audio_transcription:e.inputAudioTranscription??Th.inputAudioTranscription,input_audio_noise_reduction:e.inputAudioNoiseReduction??Th.inputAudioNoiseReduction,turn_detection:Ah.buildTurnDetectionConfig(e.turnDetection)??Th.turnDetection,tool_choice:e.toolChoice??Th.toolChoice,tools:e.tools?.map(e=>({...e,strict:void 0})),...e.providerData??{}};return t}static buildTurnDetectionConfig(e){if(void 0===e)return;const{type:t,createResponse:n,create_response:s,eagerness:r,interruptResponse:a,interrupt_response:i,prefixPaddingMs:o,prefix_padding_ms:c,silenceDurationMs:u,silence_duration_ms:l,threshold:d,...p}=e,h={type:t,create_response:n||s,eagerness:r,interrupt_response:a||i,prefix_padding_ms:o||c,silence_duration_ms:u||l,threshold:d,...p};return Object.keys(h).forEach(e=>{void 0===h[e]&&delete h[e]}),Object.keys(h).length>0?h:void 0}set _tracingConfig(e){this.#H=e}_updateTracingConfig(e){if(void 0===this.#H&&(this.#H=null),"auto"!==e){if("string"==typeof this.#H||"string"==typeof e)return null===e?(Ip.debug("Disabling tracing for this session. It cannot be turned on for this session from this point on."),void this.sendEvent({type:"session.update",session:{tracing:null}})):void(null!==this.#H&&"string"!=typeof this.#H?e?.group_id===this.#H?.group_id&&e?.metadata===this.#H?.metadata&&e?.workflow_name===this.#H?.workflow_name?this.sendEvent({type:"session.update",session:{tracing:e}}):Ip.warn("Mismatch in tracing config. Ignoring the new tracing config. This likely happens when you already set a tracing config on session creation. Current tracing config: %s, new tracing config: %s",JSON.stringify(this.#H),JSON.stringify(e)):this.sendEvent({type:"session.update",session:{tracing:e}}));Ip.warn("Tracing config is already set, skipping setting it again. This likely happens when you already set a tracing config on session creation.")}else this.sendEvent({type:"session.update",session:{tracing:"auto"}})}updateSessionConfig(e){const t=this._getMergedSessionConfig(e);this.sendEvent({type:"session.update",session:t})}sendFunctionCallOutput(e,t,n=!0){this.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",output:t,call_id:e.callId}});try{const n=Ap.parse({itemId:e.id,previousItemId:e.previousItemId,type:"function_call",status:"completed",arguments:e.arguments,name:e.name,output:t});this.emit("item_update",n)}catch(t){Ip.error("Error parsing tool call item",t,e)}n&&this.sendEvent({type:"response.create"})}sendAudio(e,{commit:t=!1}={}){this.sendEvent({type:"input_audio_buffer.append",audio:_p(e)}),t&&this.sendEvent({type:"input_audio_buffer.commit"})}resetHistory(e,t){const{removals:n,additions:s,updates:r}=function(e,t){return{removals:e.filter(e=>!t.some(t=>t.itemId===e.itemId)),additions:t.filter(t=>!e.some(e=>e.itemId===t.itemId)),updates:t.filter(t=>e.some(e=>e.itemId===t.itemId&&JSON.stringify(e)!==JSON.stringify(t)))}}(e,t),a=new Set(n.map(e=>e.itemId));for(const e of r)a.add(e.itemId);if(a.size>0)for(const e of a)this.sendEvent({type:"conversation.item.delete",item_id:e});const i=[...s,...r];for(const e of i)if("message"===e.type){const t={type:"message",role:e.role,content:e.content,id:e.itemId};"system"!==e.role&&e.status&&(t.status=e.status),this.sendEvent({type:"conversation.item.create",item:t})}else"function_call"===e.type&&Ip.warn("Function calls cannot be manually added or updated at the moment. Ignoring.")}}class Ch extends Ah{options;#X;#Y={status:"disconnected",peerConnection:void 0,dataChannel:void 0};#Q;#ee=!1;#te=!1;constructor(e={}){if("undefined"==typeof RTCPeerConnection)throw new Error("WebRTC is not supported in this environment");super(e),this.options=e,this.#X=e.baseUrl??"https://api.openai.com/v1/realtime",this.#Q=e.useInsecureApiKey??!1}get status(){return this.#Y.status}get connectionState(){return this.#Y}get muted(){return this.#te}async connect(e){if("connected"===this.#Y.status)return;"connecting"===this.#Y.status&&Ip.warn("Realtime connection already in progress. Please await original promise");const t=e.model??this.currentModel;this.currentModel=t;const n=e.url??this.#X,s=await this._getApiKey(e),r="string"==typeof s&&s.startsWith("ek_");if(!this.#Q&&!r)throw new Gt("Using the WebRTC connection in a browser environment requires an insecure API key. Please use a WebSocket connection instead or set the useInsecureApiKey option to true.");return new Promise(async(t,r)=>{try{const a={...e.initialSessionConfig||{},model:this.currentModel},i=new URL(n);let o=new RTCPeerConnection;const c=o.createDataChannel("oai-events");this.#Y={status:"connecting",peerConnection:o,dataChannel:c},this.emit("connection_change",this.#Y.status),c.addEventListener("open",()=>{this.#Y={status:"connected",peerConnection:o,dataChannel:c},this.updateSessionConfig(a),this.emit("connection_change",this.#Y.status),this._onOpen(),t()}),c.addEventListener("error",e=>{this.close(),this._onError(e),r(e)}),c.addEventListener("message",e=>{this._onMessage(e);const{data:t,isGeneric:n}=kh(e);t&&!n&&("response.created"===t.type?this.#ee=!0:"response.done"===t.type&&(this.#ee=!1),"session.created"===t.type&&(this._tracingConfig=t.session.tracing,this._updateTracingConfig(a.tracing??"auto")))});const u=this.options.audioElement??document.createElement("audio");u.autoplay=!0,o.ontrack=e=>{u.srcObject=e.streams[0]};const l=this.options.mediaStream??await navigator.mediaDevices.getUserMedia({audio:!0});o.addTrack(l.getAudioTracks()[0]),this.options.changePeerConnection&&(o=await this.options.changePeerConnection(o),this.#Y={...this.#Y,peerConnection:o});const d=await o.createOffer();if(await o.setLocalDescription(d),!d.sdp)throw new Error("Failed to create offer");const p={...this._getMergedSessionConfig(a),model:this.currentModel},h=new FormData;h.append("sdp",d.sdp),h.append("session",JSON.stringify(p));const m=await fetch(i,{method:"POST",body:h,headers:{Authorization:`Bearer ${s}`,"X-OpenAI-Agents-SDK":bp["X-OpenAI-Agents-SDK"]}}),f={type:"answer",sdp:await m.text()};await o.setRemoteDescription(f)}catch(e){this.close(),this._onError(e),r(e)}})}sendEvent(e){if(!this.#Y.dataChannel||"open"!==this.#Y.dataChannel.readyState)throw new Error("WebRTC data channel is not connected. Make sure you call `connect()` before sending events.");this.#Y.dataChannel.send(JSON.stringify(e))}mute(e){this.#te=e,this.#Y.peerConnection&&this.#Y.peerConnection.getSenders().forEach(t=>{t.track&&(t.track.enabled=!e)})}close(){if(this.#Y.dataChannel&&this.#Y.dataChannel.close(),this.#Y.peerConnection){const e=this.#Y.peerConnection;e.getSenders().forEach(e=>{e.track?.stop()}),e.close()}"disconnected"!==this.#Y.status&&(this.#Y={status:"disconnected",peerConnection:void 0,dataChannel:void 0},this.emit("connection_change",this.#Y.status),this._onClose())}interrupt(){this.#ee&&(this.sendEvent({type:"response.cancel"}),this.#ee=!1),this.sendEvent({type:"output_audio_buffer.clear"})}}const Oh=globalThis.WebSocket;class Rh extends Ah{#K;#X;#Y={status:"disconnected",websocket:void 0};#Q;#ne;#se;_firstAudioTimestamp;_audioLengthMs=0;#ee=!1;constructor(e={}){super(e),this.#X=`wss://api.openai.com/v1/realtime?model=${this.currentModel}`,this.#Q=e.useInsecureApiKey??!1}get status(){return this.#Y.status}get connectionState(){return this.#Y}get muted(){return null}get currentItemId(){return this.#ne}_onAudio(e){this.emit("audio",e)}#re(e,t,n){if(this.#Y.websocket)return void e();if(!this.#K)throw new Gt("API key is not set. Please call `connect()` with an API key first.");if(!this.#K.startsWith("ek_")&&!this.#Q)throw new Gt("Using the WebSocket connection in a browser environment requires an ephemeral client key. If you have to use a regular API key, set the `useInsecureApiKey` option to true.");const s=["realtime","openai-insecure-api-key."+this.#K,"openai-beta.realtime-v1",xp],r=new Oh(this.#X,s);this.#Y={status:"connecting",websocket:r},this.emit("connection_change",this.#Y.status),r.addEventListener("open",()=>{this.#Y={status:"connected",websocket:r},this.emit("connection_change",this.#Y.status),this._onOpen(),e()}),r.addEventListener("error",e=>{this._onError(e),this.#Y={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#Y.status),t(e)}),r.addEventListener("message",e=>{this._onMessage(e);const{data:t,isGeneric:s}=kh(e);if(t&&!s)if("response.audio.delta"===t.type){this.#se=t.content_index,this.#ne=t.item_id,void 0===this._firstAudioTimestamp&&(this._firstAudioTimestamp=Date.now(),this._audioLengthMs=0);const e=gp(t.delta);(this._rawSessionConfig?.output_audio_format??"pcm16").startsWith("g711_")?this._audioLengthMs+=e.byteLength/8:this._audioLengthMs+=e.byteLength/24/2;const n={type:"audio",data:e,responseId:t.response_id};this._onAudio(n)}else if("input_audio_buffer.speech_started"===t.type){const e=this._rawSessionConfig?.turn_detection?.interrupt_response??!1;this.interrupt(!e)}else"response.created"===t.type?this.#ee=!0:"response.done"===t.type?this.#ee=!1:"session.created"===t.type&&(this._tracingConfig=t.session.tracing,this._updateTracingConfig(n.tracing??"auto"))}),r.addEventListener("close",()=>{this.#Y={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#Y.status),this._onClose()})}async connect(e){const t=e.model??this.currentModel;this.currentModel=t,this.#K=await this._getApiKey(e),this.#X=e.url??`wss://api.openai.com/v1/realtime?model=${this.currentModel}`;const n={...e.initialSessionConfig||{},model:this.currentModel};await new Promise((e,t)=>{try{this.#re(e,t,n)}catch(e){t(e)}}),await this.updateSessionConfig(n)}sendEvent(e){if(!this.#Y.websocket)throw new Error("WebSocket is not connected. Make sure you call `connect()` before sending events.");this.#Y.websocket.send(JSON.stringify(e))}close(){this.#Y.websocket?.close(),this.#ne=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#se=void 0}mute(e){throw new Error("Mute is not supported for the WebSocket transport. You have to mute the audio input yourself.")}sendAudio(e,t={}){"connected"===this.#Y.status&&super.sendAudio(e,t)}_cancelResponse(){this.#ee&&(this.sendEvent({type:"response.cancel"}),this.#ee=!1)}_interrupt(e,t=!0){e<0||e>this._audioLengthMs||(t&&this._cancelResponse(),this.emit("audio_interrupted"),this.sendEvent({type:"conversation.item.truncate",item_id:this.#ne,content_index:this.#se,audio_end_ms:e}))}interrupt(e=!0){if(!this.#ne||"number"!=typeof this._firstAudioTimestamp)return;const t=Date.now()-this._firstAudioTimestamp;t>=0&&this._interrupt(t,e),this.#ne=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#se=void 0}}class Eh extends wr{initialAgent;options;#ae;#ie;#oe=[];#ce;#ue=[];#le;#de={};#pe=[];#he;#me={};constructor(e,t={}){super(),this.initialAgent=e,this.options=t,void 0===t.transport&&"undefined"!=typeof window&&void 0!==window.RTCPeerConnection||"webrtc"===t.transport?this.#ae=new Ch:"websocket"===t.transport||void 0===t.transport?this.#ae=new Rh:this.#ae=t.transport,this.#ie=e,this.#ce=new ki({...t.context??{},history:this.#pe}),this.#ue=(t.outputGuardrails??[]).map(kp),this.#le={debounceTextLength:(t.outputGuardrailSettings??{}).debounceTextLength??100},this.#he=t.historyStoreAudio??!1}get transport(){return this.#ae}get currentAgent(){return this.#ie}get usage(){return this.#ce.usage}get context(){return this.#ce}get muted(){return this.#ae.muted}get history(){return this.#pe}async#fe(e){this.#ie=e;const t=this.#ie.handoffs.map(Ma).map(e=>e.getHandoffAsFunctionTool());this.#oe=[...(await this.#ie.getAllTools()).filter(e=>"function"===e.type),...t]}async#ge(e={}){const t=await this.#ie.getSystemPrompt(this.#ce),n=this.options.tracingDisabled?null:this.options.workflowName?{workflow_name:this.options.workflowName}:"auto";return null!==n&&"auto"!==n?(this.options.groupId&&(n.group_id=this.options.groupId),this.options.traceMetadata&&(n.metadata=this.options.traceMetadata)):(this.options.groupId||this.options.traceMetadata)&&Ip.warn("In order to set traceMetadata or a groupId you need to specify a workflowName."),{instructions:t,voice:this.#ie.voice,model:this.options.model,tools:this.#oe,tracing:n,...e}}async updateAgent(e){return this.#ie.emit("agent_handoff",this.#ce,e),this.emit("agent_handoff",this.#ce,this.#ie,e),await this.#fe(e),await this.#ae.updateSessionConfig(await this.#ge()),e}async#_e(e,t){const n=await t.onInvokeHandoff(this.#ce,e.arguments);this.#ie.emit("agent_handoff",this.#ce,n),this.emit("agent_handoff",this.#ce,this.#ie,n),await this.#fe(n),await this.#ae.updateSessionConfig(await this.#ge());const s=$a(n);return this.#ae.sendFunctionCallOutput(e,s,!0),n}async#ye(e,t){this.#ce.context.history=JSON.parse(JSON.stringify(this.#pe));let n=e.arguments;if(t.parameters&&(n=Yt(t.parameters)?t.parameters.parse(n):JSON.parse(n)),await t.needsApproval(this.#ce,n,e.callId)){const n=this.context.isToolApproved({toolName:t.name,callId:e.callId});if(!1===n){this.emit("agent_tool_start",this.#ce,this.#ie,t,{toolCall:e}),this.#ie.emit("agent_tool_start",this.#ce,t,{toolCall:e});const n="Tool execution was not approved.";return this.#ae.sendFunctionCallOutput(e,n,!0),this.emit("agent_tool_end",this.#ce,this.#ie,t,n,{toolCall:e}),void this.#ie.emit("agent_tool_end",this.#ce,t,n,{toolCall:e})}if(void 0===n)return void this.emit("tool_approval_requested",this.#ce,this.#ie,{type:"function_approval",tool:t,approvalItem:new Mi(e,this.#ie)})}this.emit("agent_tool_start",this.#ce,this.#ie,t,{toolCall:e}),this.#ie.emit("agent_tool_start",this.#ce,t,{toolCall:e}),this.#ce.context.history=JSON.parse(JSON.stringify(this.#pe));const s=pn(await t.invoke(this.#ce,e.arguments));this.#ae.sendFunctionCallOutput(e,s,!0),this.emit("agent_tool_end",this.#ce,this.#ie,t,s,{toolCall:e}),this.#ie.emit("agent_tool_end",this.#ce,t,s,{toolCall:e})}async#ve(e){const t=new Map(this.#ie.handoffs.map(Ma).map(e=>[e.toolName,e])),n=new Map((await this.#ie.getAllTools()).map(e=>[e.name,e])),s=t.get(e.name);if(s)await this.#_e(e,s);else{const t=n.get(e.name);if(!t||"function"!==t.type)throw new Wt(`Tool ${e.name} not found`);await this.#ye(e,t)}}async#L(e,t,n){if(0===this.#ue.length)return;const s={agent:this.#ie,agentOutput:e,context:this.#ce},r=(await Promise.all(this.#ue.map(e=>e.run(s)))).find(e=>e.output.tripwireTriggered);if(r){if(this.#me[t])return;this.#me[t]=!0;const e=new Xt(`Output guardrail triggered: ${JSON.stringify(r.output.outputInfo)}`,r);this.emit("guardrail_tripped",this.#ce,this.#ie,e,{itemId:n}),this.interrupt();const s=`\n Your last answer was blocked. \nFailed Guardrail Reason: ${(a=r).guardrail.policyHint}. \nFailure Details: ${JSON.stringify(a.output.outputInfo??{})}. \nPlease respond again following policy. Apologize for not being able to answer the question (while avoiding the specific reason) and divert discussion back to an approved topic immediately and not invite more discussion.\n`.trim();return void this.sendMessage(s)}var a}#we(){this.#ae.on("*",e=>{if(this.emit("transport_event",e),"conversation.item.input_audio_transcription.completed"===e.type)try{const t=e;this.#pe=wp(this.#pe,t,this.#he),this.#ce.context.history=this.#pe,this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("audio",e=>{this.emit("audio",e)}),this.#ae.on("turn_started",()=>{this.emit("agent_start",this.#ce,this.#ie),this.#ie.emit("agent_start",this.#ce,this.#ie)}),this.#ae.on("turn_done",e=>{const t=e.response.output[e.response.output.length-1],n=yp(t)??"",s=t?.id??"";this.emit("agent_end",this.#ce,this.#ie,n),this.#ie.emit("agent_end",this.#ce,n),this.#L(n,e.response.id,s)}),this.#ae.on("audio_done",()=>{this.emit("audio_stopped",this.#ce,this.#ie)});let e,t=0;this.#ae.on("audio_transcript_delta",n=>{try{const s=n.delta,r=n.itemId,a=n.responseId;e!==r&&(e=r,t=0);const i=(this.#de[r]??"")+s;if(this.#de[r]=i,this.#le.debounceTextLength<0)return;const o=Math.floor(i.length/this.#le.debounceTextLength);o>t&&(t=o,this.#L(i,a,r))}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("item_update",e=>{try{const t=!this.#pe.some(t=>t.itemId===e.itemId);if(this.#pe=wp(this.#pe,e,this.#he),this.#ce.context.history=this.#pe,t){const t=this.#pe.find(t=>t.itemId===e.itemId);t&&this.emit("history_added",t)}this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("item_deleted",e=>{try{this.#pe=this.#pe.filter(t=>t.itemId!==e.itemId),this.#ce.context.history=this.#pe,this.emit("history_updated",this.#pe)}catch(e){this.emit("error",{type:"error",error:e})}}),this.#ae.on("function_call",async e=>{try{await this.#ve(e)}catch(e){Ip.error("Error handling function call",e),this.emit("error",{type:"error",error:e})}}),this.#ae.on("usage_update",e=>{this.#ce.usage.add(e)}),this.#ae.on("audio_interrupted",()=>{this.emit("audio_interrupted",this.#ce,this.#ie)}),this.#ae.on("error",e=>{this.emit("error",e)})}async connect(e){await this.#fe(this.initialAgent),this.#we(),await this.#ae.connect({apiKey:e.apiKey??this.options.apiKey,model:this.options.model,initialSessionConfig:await this.#ge(this.options.config)}),this.#pe=[],this.emit("history_updated",this.#pe)}updateHistory(e){let t;t="function"==typeof e?e(this.#pe):e,this.#ae.resetHistory(this.#pe,t)}sendMessage(e,t={}){this.#ae.sendMessage(e,t)}mute(e){this.#ae.mute(e)}close(){this.#me={},this.#ae.close()}sendAudio(e,t={}){this.#ae.sendAudio(e,t)}interrupt(){this.#ae.interrupt()}async approve(e,t={alwaysApprove:!1}){this.#ce.approveTool(e,t);const n=this.#ie.tools.find(t=>t.name===e.rawItem.name);if(!n||"function"!==n.type||"function_call"!==e.rawItem.type)throw new Wt(`Tool ${e.rawItem.name} not found`);await this.#ye(e.rawItem,n)}async reject(e,t={alwaysReject:!1}){this.#ce.rejectTool(e,t);const n=this.#ie.tools.find(t=>t.name===e.rawItem.name);if(!n||"function"!==n.type||"function_call"!==e.rawItem.type)throw new Wt(`Tool ${e.rawItem.name} not found`);await this.#ye(e.rawItem,n)}}const Nh={base64ToArrayBuffer:gp,arrayBufferToBase64:_p,getLastTextFromAudioOutputMessage:yp};La(new pp),mp(),window.openaiAgent={Agents:a,AgentsCore:t,AgentsOpenAI:s}})(),{}})());
//# sourceMappingURL=bundle.min.js.map